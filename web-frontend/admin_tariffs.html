<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fit Dew - Тарифы</title>
  <script>
    (function() {
      const savedTheme = localStorage.getItem("theme") || "dark";
      document.documentElement.classList.toggle("light", savedTheme === "light");
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@600;700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="env.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --card: rgba(24, 27, 34, 0.9);
      --card-border: rgba(255, 255, 255, 0.08);
      --text: #f3f4f7;
      --muted: rgba(255, 255, 255, 0.6);
      --accent: #f2d17c;
      --accent-strong: #e7b860;
      --shadow: 0 22px 50px rgba(0, 0, 0, 0.35);
      --radius: 18px;
    }

    html {
      color-scheme: dark;
    }

    html.light {
      color-scheme: light;
      --bg: #f4f1e9;
      --card: rgba(255, 255, 255, 0.9);
      --card-border: rgba(0, 0, 0, 0.06);
      --text: #121212;
      --muted: rgba(0, 0, 0, 0.55);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Manrope", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .admin-screen {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 20px 60px;
      display: grid;
      gap: 18px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header-left {
      display: grid;
      gap: 6px;
    }

    .eyebrow {
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .page-title {
      margin: 0;
      font-family: "Exo 2", sans-serif;
      font-size: 1.6rem;
    }

    .page-subtitle {
      margin: 0;
      color: var(--muted);
    }

    .btn-outline {
      border: 1px solid var(--card-border);
      background: transparent;
      color: var(--text);
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .btn-outline:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .section-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 16px;
    }

    .tariff-row {
      display: grid;
      grid-template-columns: minmax(140px, 1.2fr) repeat(2, minmax(140px, 1fr)) minmax(160px, 1fr);
      gap: 14px;
      align-items: center;
      padding: 14px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .tariff-meta {
      display: grid;
      gap: 4px;
    }

    .tariff-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .tariff-code {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .field {
      display: grid;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .field input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.2);
      color: var(--text);
      font-size: 0.95rem;
    }

    .tariff-final {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent);
      text-align: right;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1b1b;
      padding: 12px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
    }

    .status {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .error {
      color: #ff7b7b;
    }

    @media (max-width: 900px) {
      .tariff-row {
        grid-template-columns: 1fr;
        text-align: left;
      }
      .tariff-final {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="admin-screen">
    <header class="page-header">
      <div class="header-left">
        <span class="eyebrow">Суперадмин</span>
        <h1 class="page-title">Цены и скидки</h1>
        <p class="page-subtitle">Настройте цены тарифов и скидки. Итог = Цена × (1 − скидка/100).</p>
      </div>
      <button class="btn-outline" id="backBtn" type="button">Назад</button>
    </header>

    <section class="section-card">
      <div id="accessMessage" class="status">Проверяем доступ…</div>
      <div id="tariffList" hidden></div>
      <div class="actions" id="actionsRow" hidden>
        <button class="btn-primary" id="saveBtn" type="button">Сохранить</button>
        <div class="status" id="saveStatus"></div>
      </div>
    </section>
  </div>

  <script>
    (function() {
      const tg = window.Telegram?.WebApp || null;
      const params = new URLSearchParams(window.location.search);
      const API_BASE = window.ENV?.API_BASE || "";
      const apiBase = API_BASE ? API_BASE.replace(/\/$/, "") : "";

      const buildInitData = () => {
        const data = tg?.initData || "";
        if (data) return data;
        const u = tg?.initDataUnsafe || null;
        if (!u?.user || !u?.hash) return "";
        const p = new URLSearchParams();
        if (u.user?.id) p.set("user", JSON.stringify(u.user));
        if (u.auth_date) p.set("auth_date", u.auth_date);
        if (u.chat_type) p.set("chat_type", u.chat_type);
        if (u.chat_instance) p.set("chat_instance", u.chat_instance);
        p.set("hash", u.hash);
        return p.toString();
      };

      const initData = tg?.initData || params.get("initData") || buildInitData() || "";
      const accessMessage = document.getElementById("accessMessage");
      const tariffList = document.getElementById("tariffList");
      const saveBtn = document.getElementById("saveBtn");
      const saveStatus = document.getElementById("saveStatus");
      const actionsRow = document.getElementById("actionsRow");
      const backBtn = document.getElementById("backBtn");

      const buildUrl = (path) => (
        initData ? `${path}?initData=${encodeURIComponent(initData)}` : path
      );

      if (backBtn) {
        backBtn.addEventListener("click", () => {
          window.location.href = buildUrl("admin_programs.html");
        });
      }

      const formatRub = (value) => {
        const num = Number(value);
        if (!Number.isFinite(num)) return "—";
        return `${num.toFixed(2)} ₽`;
      };

      const computeFinal = (price, discount) => {
        const p = Number(price);
        const d = Number(discount);
        if (!Number.isFinite(p) || p <= 0) return null;
        const safeDiscount = Number.isFinite(d) ? Math.max(0, Math.min(d, 90)) : 0;
        const final = p * (1 - safeDiscount / 100);
        return Math.max(1, Number(final.toFixed(2)));
      };

      const renderTariffs = (items) => {
        if (!tariffList) return;
        tariffList.innerHTML = "";
        items.forEach((item) => {
          const row = document.createElement("div");
          row.className = "tariff-row";
          row.dataset.code = item.code;
          row.innerHTML = `
            <div class="tariff-meta">
              <div class="tariff-name">${item.name}</div>
              <div class="tariff-code">${item.code}</div>
            </div>
            <label class="field">
              <span>Цена, ₽</span>
              <input type="number" min="1" step="1" class="price-input" value="${Number(item.priceRub || 0)}">
            </label>
            <label class="field">
              <span>Скидка, %</span>
              <input type="number" min="0" max="90" step="1" class="discount-input" value="${Number(item.discountPercent || 0)}">
            </label>
            <div class="tariff-final">Итого: ${formatRub(item.finalPriceRub)}</div>
          `;
          tariffList.appendChild(row);
        });

        tariffList.querySelectorAll(".tariff-row").forEach((row) => {
          const priceInput = row.querySelector(".price-input");
          const discountInput = row.querySelector(".discount-input");
          const finalEl = row.querySelector(".tariff-final");
          const updateFinal = () => {
            const final = computeFinal(priceInput.value, discountInput.value);
            finalEl.textContent = final ? `Итого: ${formatRub(final)}` : "Итого: —";
          };
          priceInput.addEventListener("input", updateFinal);
          discountInput.addEventListener("input", updateFinal);
        });
      };

      const loadTariffs = async () => {
        if (!apiBase || !initData) return;
        try {
          const res = await fetch(`${apiBase}/api/admin/tariffs?initData=${encodeURIComponent(initData)}`);
          const json = await res.json().catch(() => ({}));
          if (!json?.ok) throw new Error(json?.error || "load_failed");
          renderTariffs(json.tariffs || []);
          tariffList.hidden = false;
          actionsRow.hidden = false;
          accessMessage.textContent = "Доступ подтвержден.";
        } catch (err) {
          accessMessage.textContent = "Не удалось загрузить тарифы.";
          accessMessage.classList.add("error");
        }
      };

      const saveTariffs = async () => {
        if (!tariffList) return;
        saveStatus.textContent = "Сохраняем...";
        saveStatus.classList.remove("error");

        const payload = [];
        tariffList.querySelectorAll(".tariff-row").forEach((row) => {
          const code = row.dataset.code;
          const price = Number(row.querySelector(".price-input").value);
          const discount = Number(row.querySelector(".discount-input").value);
          payload.push({
            code,
            priceRub: price,
            discountPercent: discount
          });
        });

        try {
          const res = await fetch(`${apiBase}/api/admin/tariffs`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ initData, tariffs: payload })
          });
          const json = await res.json().catch(() => ({}));
          if (!json?.ok) throw new Error(json?.error || "save_failed");
          renderTariffs(json.tariffs || []);
          saveStatus.textContent = "Сохранено";
          setTimeout(() => {
            if (saveStatus.textContent === "Сохранено") saveStatus.textContent = "";
          }, 2000);
        } catch (err) {
          saveStatus.textContent = "Ошибка сохранения";
          saveStatus.classList.add("error");
        }
      };

      const checkAccess = async () => {
        if (!apiBase) {
          accessMessage.textContent = "Нет API_BASE. Проверь env.js.";
          accessMessage.classList.add("error");
          return;
        }
        if (!initData) {
          accessMessage.textContent = "Открой админку через Telegram, чтобы получить initData.";
          accessMessage.classList.add("error");
          return;
        }
        try {
          const res = await fetch(`${apiBase}/api/user?initData=${encodeURIComponent(initData)}`);
          const json = await res.json().catch(() => ({}));
          const role = json?.profile?.role || "user";
          if (!json?.ok || role !== "sadmin") {
            accessMessage.textContent = "Доступ закрыт. Нужна роль суперадмина.";
            accessMessage.classList.add("error");
            return;
          }
          loadTariffs();
        } catch (err) {
          accessMessage.textContent = "Ошибка сети при проверке доступа.";
          accessMessage.classList.add("error");
        }
      };

      if (saveBtn) {
        saveBtn.addEventListener("click", saveTariffs);
      }

      checkAccess();

      try {
        tg?.ready?.();
        tg?.expand?.();
      } catch (_) {}
    })();
  </script>
</body>
</html>
