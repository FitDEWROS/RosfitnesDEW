<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fit Dew - –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</title>

  <!-- üß© –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@500;700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #111113;
      --text: #ffffff;
      --card: rgba(255,255,255,0.05);
      --card-border: rgba(255,255,255,0.1);
      --accent: #8b5cf6;
    }
    html.light {
      --bg: #f5f7fa;
      --text: #111113;
      --card: #ffffff;
      --card-border: rgba(0,0,0,0.1);
      --accent: #3b82f6;
    }

    body.page-crossfit {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.3s ease, color 0.3s ease;
    }
    body, html {
      margin: 0;
      padding: 0;
    }

    /* üåà –ì—Ä–∞–¥–∏–µ–Ω—Ç-–∞—É—Ä–∞ (—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Äî –∫–∞–∫ –±—ã–ª–æ) */
    .cf-header {
      width: 100vw;
      margin-left: calc(-50vw + 50%);
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      color: #fff;
      background: rgba(17,17,19,0.55);
      backdrop-filter: blur(14px);
      box-shadow: 0 2px 20px rgba(139,92,246,0.25);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      overflow: hidden;
      z-index: 20;
    }
    .cf-header::after {
      content: "";
      position: absolute;
      inset: -80px;
      background: radial-gradient(circle at 50% 100%, rgba(139,92,246,0.45), transparent 70%);
      z-index: -1;
      pointer-events: none;
    }

    /* ‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (–≤ —Å—Ç–∏–ª–µ index.html, –Ω–æ –º—è–≥—á–µ) */
    html.light .cf-header {
      background: linear-gradient(135deg, rgba(139,92,246,0.18), rgba(59,130,246,0.18));
      backdrop-filter: blur(16px);
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      color: #111;
      width: 100%; /* –±—ã–ª–æ 100vw ‚Äî —Ç–µ–ø–µ—Ä—å –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ */
      margin-left: 0; /* —É–±–∏—Ä–∞–µ–º —Å–¥–≤–∏–≥ */
    }
    html.light .cf-header::after {
      background: radial-gradient(circle at 60% 100%, rgba(59,130,246,0.25), transparent 70%);
    }

    .nav-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    .nav-btn:hover {
      background: rgba(139,92,246,0.3);
      box-shadow: 0 0 10px rgba(139,92,246,0.5);
    }

    /* –ö–Ω–æ–ø–∫–∞ –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ */
    html.light .nav-btn {
      border: 1px solid rgba(0,0,0,0.15);
      color: #111;
      background: rgba(255,255,255,0.6);
    }
    html.light .nav-btn:hover {
      background: rgba(59,130,246,0.15);
      box-shadow: 0 0 10px rgba(59,130,246,0.25);
    }

    .header-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      gap: 2px;
      text-align: center;
    }

    .app-title {
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 0.3px;
    }

    .wrap {
      width: min(1100px, 100%);
      margin: 0 auto;
      padding-bottom: 140px;
    }

    .list-actions {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      padding: 0 16px 8px;
    }

    .list-actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .filter-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      flex: 1 1 auto;
      min-width: 0;
    }

    .filter-btn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: var(--card);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .filter-btn svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
    }
    .filter-btn:active {
      transform: scale(0.96);
    }

    .filter-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      width: 100%;
      padding-left: 46px;
    }
    .filter-panel[hidden] {
      display: none;
    }
    .filter-search {
      min-width: 180px;
      flex: 1 1 auto;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: var(--card);
      color: var(--text);
      padding: 8px 12px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .filter-search:focus {
      border-color: rgba(242, 209, 124, 0.6);
      box-shadow: 0 0 0 3px rgba(242, 209, 124, 0.15);
    }
    .filter-chip {
      border: 1px solid var(--card-border);
      background: var(--card);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .filter-chip.is-active {
      color: #1b1b1b;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
    }

    .density-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: var(--card);
    }

    .density-label {
      font-size: 0.6rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .density-btn {
      border: none;
      border-radius: 999px;
      min-width: 28px;
      height: 26px;
      padding: 0 8px;
      font-size: 0.75rem;
      color: #1b1b1b;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      cursor: pointer;
    }

    .density-btn.is-active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1b1b;
    }

    /* üèãÔ∏è –°–µ—Ç–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π */
    .cf-main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 18px;
      padding: 24px 16px 40px;
      justify-items: center;
      flex-grow: 1;
    }

    .exercise-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      width: 100%;
      max-width: 260px;
      overflow: hidden;
      text-align: center;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      opacity: 0;
      transform: translateY(15px);
    }
    .exercise-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 6px 22px var(--accent);
    }

    .thumb {
      position: relative;
      height: 160px;
      background: #000;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.8);
      transition: transform 0.3s ease, filter 0.3s ease;
    }
    .exercise-card:hover img {
      transform: scale(1.05);
      filter: brightness(1);
    }
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.2rem;
      text-shadow: 0 0 10px rgba(0,0,0,0.6);
      pointer-events: none;
    }

    .exercise-card h3 {
      font-size: 1.05rem;
      font-weight: 600;
      margin: 12px 0 6px;
    }
    .exercise-card p {
      font-size: 0.9rem;
      opacity: 0.85;
      padding: 0 10px 12px;
    }

    /* üé• –í–∏–¥–µ–æ-–º–æ–¥–∞–ª–∫–∞ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .modal.show { display: flex; }

    .video-modal {
      position: relative;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      display: grid;
      gap: 10px;
      animation: modalAppear 0.3s ease forwards;
    }

    @keyframes modalAppear {
      from { opacity: 0; transform: translateY(20px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .video-modal video {
      width: 100%;
      height: auto;
      max-height: 55vh;
      border-radius: 12px;
      margin-bottom: 12px;
      object-fit: contain;
      background: #000;
    }

    .video-modal h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 6px 0 4px;
      color: var(--text);
      text-align: center;
    }

    .video-modal p {
      font-size: 0.9rem;
      opacity: 0.85;
      margin: 0 0 4px;
      text-align: center;
      color: var(--text);
    }

    .video-note {
      font-size: 0.85rem;
      opacity: 0.8;
      text-align: center;
      margin: 6px 0 0;
    }

    .video-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    .thumb-letter {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      font-size: 2.2rem;
      font-weight: 700;
      font-family: var(--font-title);
      color: #f6f2e7;
      background: linear-gradient(135deg, rgba(243, 213, 139, 0.55), rgba(143, 208, 197, 0.4));
    }

    /* ‚ùå –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
    .close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 26px;
      color: var(--text);
      opacity: 0.7;
      cursor: pointer;
      background: rgba(0,0,0,0.25);
      border-radius: 50%;
      padding: 3px 9px;
      transition: 0.25s;
    }
    .close:hover { opacity: 1; }

    /* üì± –ú–æ–±–∏–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ */
    @media (max-width: 600px) {
      .video-modal {
        width: calc(100% - 32px);
        margin: 0 auto;
        padding: 12px;
        border-radius: 14px;
        max-height: 80dvh; /* ‚úÖ –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–ª–µ–≥—Ä–∞–º –∏ notch */
        overflow-y: auto;
      }

      .video-modal video {
        max-height: 50dvh;
        border-radius: 10px;
      }

      .close {
        top: 10px;
        right: 10px;
        font-size: 28px;
      }
}



      .cf-header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      justify-content: initial;
    }

    .header-title {
      position: static;
      transform: none;
      justify-self: center;
      padding: 0 12px;
      line-height: 1.05;
    }

    .header-spacer {
      width: 86px;
      height: 1px;
    }


    .back-btn {
      width: fit-content;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1b1b;
      font-family: var(--font-title);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(243, 213, 139, 0.3);
    }
</style>
  <style>
    :root {
      --bg: #0f0f10;
      --text: #f6f2e7;
      --muted: #c6c0b2;
      --card: #1a1a1d;
      --card-border: rgba(255, 255, 255, 0.08);
      --accent: #f3d58b;
      --accent-strong: #f1c65a;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      --font-title: "Exo 2", sans-serif;
      --font-body: "Manrope", sans-serif;
    }

    html.light {
      --bg: #f4f1e6;
      --text: #1b1b1b;
      --muted: #6f6a60;
      --card: #ffffff;
      --card-border: rgba(0, 0, 0, 0.08);
      --accent: #e8c86a;
      --accent-strong: #ddb24d;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }

    body.page-crossfit {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      position: relative;
    }

    body.page-crossfit::before {
      content: "";
      position: fixed;
      inset: -20%;
      background:
        radial-gradient(500px 280px at 15% 10%, rgba(243, 213, 139, 0.16), transparent 60%),
        radial-gradient(420px 320px at 85% 20%, rgba(143, 208, 197, 0.12), transparent 65%),
        radial-gradient(420px 300px at 40% 90%, rgba(243, 213, 139, 0.08), transparent 70%);
      z-index: -2;
    }

    .cf-header {
      width: auto;
      margin: 16px;
      border-radius: 24px;
      background: linear-gradient(145deg, #1f1f22, #121214);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      color: var(--text);
    }

    .cf-header::after {
      background: radial-gradient(circle at 20% 120%, rgba(243, 213, 139, 0.35), transparent 70%);
    }

    html.light .cf-header {
      background: #ffffff;
      color: #1b1b1b;
      border-color: rgba(0, 0, 0, 0.08);
      box-shadow: var(--shadow);
    }

    html.light .cf-header::after {
      background: radial-gradient(circle at 30% 120%, rgba(232, 200, 106, 0.28), transparent 70%);
    }

    .nav-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border: none;
      color: #1b1b1b;
      font-family: var(--font-title);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      box-shadow: 0 10px 22px rgba(243, 213, 139, 0.3);
    }

    .nav-btn:hover {
      background: #f0d07a;
      box-shadow: 0 12px 24px rgba(243, 213, 139, 0.4);
    }

    .app-title {
      font-family: var(--font-title);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .exercise-card {
      background: linear-gradient(160deg, #1f1f22 0%, #121214 100%);
      border: 1px solid var(--card-border);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
    }

    html.light .exercise-card {
      background: #ffffff;
    }

    .exercise-card h3 {
      font-family: var(--font-title);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .exercise-card p {
      color: var(--muted);
    }

    .empty-state {
      width: 100%;
      text-align: center;
      padding: 18px;
      border-radius: 16px;
      border: 1px dashed var(--card-border);
      color: var(--muted);
      background: rgba(0, 0, 0, 0.18);
    }

    html.light .empty-state {
      background: rgba(0, 0, 0, 0.04);
    }

    .thumb {
      background: #0c0c0d;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .overlay {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: grid;
      place-items: center;
    }

    .video-modal {
      background: linear-gradient(160deg, rgba(26, 26, 28, 0.95), rgba(18, 18, 20, 0.95));
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
    }

    html.light .video-modal {
      background: #ffffff;
    }

    .close {
      background: rgba(255, 255, 255, 0.08);
    }

    .header-eyebrow {
      font-size: 0.65rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .cf-main {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .cf-main[data-cols="1"] {
      grid-template-columns: 1fr;
    }

    .cf-main[data-cols="2"] {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .cf-main[data-cols="4"] {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }


    .exercise-card {
      padding: 0;
      text-align: left;
      border-radius: 22px;
      overflow: hidden;
      display: grid;
      gap: 8px;
    }

    .card-body {
      padding: 12px 14px 16px;
      display: grid;
      gap: 6px;
    }

    .card-hint {
      font-size: 0.68rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .thumb {
      height: 180px;
      position: relative;
      overflow: hidden;
    }

    .thumb-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .thumb-placeholder {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 2.4rem;
      font-weight: 700;
      font-family: var(--font-title);
      color: #f6f2e7;
      background: linear-gradient(135deg, rgba(243, 213, 139, 0.55), rgba(143, 208, 197, 0.4));
      transition: opacity 0.3s ease;
    }

    .exercise-card.has-preview .thumb-video { opacity: 1; }
    .exercise-card.has-preview .thumb-placeholder { opacity: 0; }

    .thumb-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      pointer-events: none;
    }

    .play-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: grid;
      place-items: center;
      color: #fff;
      font-size: 1.1rem;
    }

    .thumb-chip {
      position: absolute;
      right: 12px;
      bottom: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.45);
      color: #fff;
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    html.light .thumb-chip {
      background: rgba(0, 0, 0, 0.12);
      color: #1b1b1b;
      border-color: rgba(0, 0, 0, 0.12);
    }

    .modal {
      align-items: flex-end;
      padding: 16px;
    }

    .video-modal {
      width: min(560px, 96vw);
      margin-bottom: env(safe-area-inset-bottom);
      max-height: 86vh;
      overflow-y: auto;
      transform: translateY(28px);
      opacity: 0;
      animation: none;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .modal.show .video-modal {
      transform: translateY(0);
      opacity: 1;
    }

    .video-modal video {
      max-height: 48vh;
    }

    .video-desc {
      display: grid;
      gap: 12px;
      margin-top: 8px;
    }

    .desc-block strong {
      display: block;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .desc-block div {
      font-size: 0.92rem;
      line-height: 1.5;
      color: var(--text);
    }

    .video-actions {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-close {
      position: static;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.35);
      color: var(--text);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
    }

    html.light .modal-close {
      background: rgba(0, 0, 0, 0.12);
    }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="env.js?v=20260115"></script>
  <style>
    .cf-header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      justify-content: initial;
    }

    .header-title {
      position: static;
      transform: none;
      justify-self: center;
      padding: 0 12px;
      line-height: 1.05;
      text-align: center;
    }

    .header-spacer {
      width: 86px;
      height: 1px;
    }

    #videoModal.guest-locked .video-desc,
    #videoModal.guest-locked #exerciseVideo {
      filter: blur(6px);
    }
    #videoModal.guest-locked #exerciseVideo {
      pointer-events: none;
    }
  </style>
</head>

<body class="page-crossfit">
  <!-- –®–∞–ø–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –Ω–∞—Ä—É–∂—É, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –±–µ–ª—ã–µ –∫—Ä–∞—è -->
  <header class="cf-header">
    <button id="backBtn" class="back-btn" type="button">–ù–∞–∑–∞–¥</button>
    <div class="header-title">
      <span class="header-eyebrow">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
      <span class="app-title">–ö—Ä–æ—Å—Å—Ñ–∏—Ç</span>
    </div>
  
    <div class="header-spacer" aria-hidden="true"></div>
</header>

  <div class="wrap">
    <div class="list-actions">
      <div class="list-actions-row">
        <div class="filter-controls">
          <button id="filterToggle" class="filter-btn" type="button" aria-label="–§–∏–ª—å—Ç—Ä—ã">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 6h10M18 6h2M8 12h12M4 12h2M4 18h6M14 18h6"></path>
              <circle cx="16" cy="6" r="2" fill="currentColor" stroke="none"></circle>
              <circle cx="6" cy="12" r="2" fill="currentColor" stroke="none"></circle>
              <circle cx="12" cy="18" r="2" fill="currentColor" stroke="none"></circle>
            </svg>
          </button>
          <input id="filterSearch" class="filter-search" type="search" placeholder="–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
        </div>
        <div class="density-toggle" role="group" aria-label="–ö–æ–ª–æ–Ω–∫–∏">
          <button class="density-btn" type="button" data-cols="2" aria-label="–ö–æ–ª–æ–Ω–∫–∏: 2">2</button>
        </div>
      </div>
      <div id="filterPanel" class="filter-panel" hidden>
        <button class="filter-chip is-active" type="button" data-filter="dumbbells">–ì–∞–Ω—Ç–µ–ª–∏</button>
        <button class="filter-chip is-active" type="button" data-filter="barbell">–®—Ç–∞–Ω–≥–∞</button>
        <button class="filter-chip is-active" type="button" data-filter="kettlebells">–ì–∏—Ä–∏</button>
        <button class="filter-chip is-active" type="button" data-filter="free">–°–≤–æ–±–æ–¥–Ω—ã–µ</button>
      </div>
    </div>
    <main class="cf-main" id="exerciseList" aria-live="polite" data-cols="2"></main>
  </div>

  <div id="videoModal" class="modal" aria-hidden="true">
    <div class="video-modal" role="dialog" aria-modal="true">
<video id="exerciseVideo" controls controlslist="nodownload noplaybackrate" disablepictureinpicture></video>
      <h3 id="videoTitle"></h3>
      <p id="videoNote" class="video-note"></p>
      <div id="videoDesc" class="video-desc"></div>
      <div class="video-actions">
        <button class="modal-close" id="closeVideo" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

    </div>
  </div>

  

  <script>
    (function() {
      const theme = localStorage.getItem("theme") || "dark";
      document.documentElement.classList.toggle("light", theme === "light");
    })();

    const tg = window.Telegram?.WebApp || null;
    const API_BASE = window.ENV?.API_BASE || "";
    const apiBase = API_BASE ? API_BASE.replace(/\/$/, "") : "";
    const list = document.getElementById("exerciseList");
    const densityButton = document.querySelector(".density-btn");
    const densityOrder = ["1", "2"];
    const filterToggle = document.getElementById("filterToggle");
    const filterPanel = document.getElementById("filterPanel");
    const filterButtons = Array.from(document.querySelectorAll(".filter-chip"));
    const filterSearch = document.getElementById("filterSearch");
    const FILTER_KEYS = ["dumbbells", "barbell", "kettlebells", "free"];
    let activeFilters = new Set(FILTER_KEYS);
    let allExercises = [];
    const videoModal = document.getElementById("videoModal");
    const videoEl = document.getElementById("exerciseVideo");
    const videoTitle = document.getElementById("videoTitle");
    const videoDesc = document.getElementById("videoDesc");
    const videoNote = document.getElementById("videoNote");
    const isAndroid = /Android/i.test(navigator.userAgent);
    let currentVideoRequest = 0;
    let currentVideoUrl = "";
    let isGuestMode = false;
    const showAlert = (msg) => (tg?.showAlert ? tg.showAlert(msg) : alert(msg));

    const buildInitData = () => {
      const raw = tg?.initData || "";
      if (raw && raw.length > 0) return raw;

      const u = tg?.initDataUnsafe || null;
      if (!u || !u.hash) return "";

      const p = new URLSearchParams();
      if (u.query_id) p.set("query_id", u.query_id);
      if (u.user) p.set("user", JSON.stringify(u.user));
      if (u.auth_date) p.set("auth_date", String(u.auth_date));
      if (u.start_param) p.set("start_param", u.start_param);
      if (u.chat_type) p.set("chat_type", u.chat_type);
      if (u.chat_instance) p.set("chat_instance", u.chat_instance);
      p.set("hash", u.hash);
      return p.toString();
    };

    const fetchUserProfile = async () => {
      if (!apiBase || !tg) return null;
      const initData = buildInitData();
      if (!initData) return null;
      try {
        const res = await fetch(`${apiBase}/api/user?initData=${encodeURIComponent(initData)}`);
        const json = await res.json().catch(() => ({}));
        return json?.profile || null;
      } catch (err) {
        console.warn("profile fetch failed", err);
        return null;
      }
    };

    const isBasicTariff = (tariff) => String(tariff || "").toLowerCase().includes("–±–∞–∑–æ–≤");

    const isGuestTariff = (tariff) => {
      const value = String(tariff || "").toLowerCase().trim();
      return !value || value.includes("–±–µ–∑ —Ç–∞—Ä–∏—Ñ–∞") || value.includes("–≥–æ—Å—Ç");
    };

    const isStaffProfile = (profile) => {
      if (!profile) return false;
      const role = profile.role;
      return role === "admin" || role === "sadmin" || role === "curator" || Boolean(profile.isCurator);
    };

    const normalizeScope = (value) => (value === "gym" || value === "crossfit" || value === "both" ? value : "both");

    const enforceBaseAccess = async () => {
      const profile = await fetchUserProfile();
      if (!profile) return true;
      if (isStaffProfile(profile)) {
        isGuestMode = false;
        const scope = normalizeScope(profile.trainerScope);
        if (scope === "gym") {
          localStorage.setItem("training_mode", "gym");
          window.location.replace("exercises.html");
          return false;
        }
        if (scope === "crossfit") {
          localStorage.setItem("training_mode", "crossfit");
        }
        return true;
      }
      isGuestMode = isGuestTariff(profile.tariffName);
      if (!isBasicTariff(profile.tariffName)) return true;
      const mode = profile.trainingMode === "crossfit" ? "crossfit" : "gym";
      localStorage.setItem("training_mode", mode);
      if (mode !== "crossfit") {
        showAlert("\u042d\u0442\u043e\u0442 \u0440\u0430\u0437\u0434\u0435\u043b \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0417\u0430\u043b.");
        window.location.replace("exercises.html");
        return false;
      }
      return true;
    };

    const normalizeCols = (value) => {
      const str = String(value || "");
      return densityOrder.includes(str) ? str : "2";
    };

    const applyDensity = (cols) => {
      if (!list) return;
      const safeCols = normalizeCols(cols);
      list.dataset.cols = safeCols;
      if (densityButton) {
        densityButton.dataset.cols = safeCols;
        densityButton.textContent = safeCols;
        densityButton.setAttribute("aria-label", `–ö–æ–ª–æ–Ω–∫–∏: ${safeCols}`);
      }
    };

    if (list && densityButton) {
      const savedCols = normalizeCols(localStorage.getItem("exercise_cols"));
      localStorage.setItem("exercise_cols", savedCols);
      applyDensity(savedCols);
      densityButton.addEventListener("click", () => {
        const current = normalizeCols(densityButton.dataset.cols || "2");
        const idx = densityOrder.indexOf(current);
        const next = densityOrder[(idx + 1) % densityOrder.length];
        localStorage.setItem("exercise_cols", next);
        applyDensity(next);
      });
    }

    const isYandexPublicLink = (url) => {
      try {
        const host = new URL(url).hostname;
        return host === "disk.yandex.ru" || host === "yadi.sk" || host.endsWith(".yandex.ru");
      } catch (_) {
        return false;
      }
    };

    const resolveVideoUrl = async (url) => {
      if (!url) return null;
      if (!isYandexPublicLink(url)) return url;
      try {
        const res = await fetch(`${apiBase}/api/yadisk/resolve?publicUrl=${encodeURIComponent(url)}`);
        const json = await res.json().catch(() => ({}));
        if (json?.ok && json.href) return json.href;
      } catch (err) {
        console.warn("Yandex resolve failed:", err);
      }
      return null;
    };

    const showVideoLink = (href, message) => {
      if (!videoNote) return;
      videoNote.innerHTML = "";
      if (message) {
        const text = document.createElement("span");
        text.textContent = message;
        videoNote.appendChild(text);
        videoNote.appendChild(document.createElement("br"));
      }
      const link = document.createElement("a");
      link.href = href;
      link.target = "_blank";
      link.rel = "noopener";
      link.className = "video-link";
      link.textContent = "–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ";
      videoNote.appendChild(link);
    };

    const escapeHtml = (value) => (
      String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
    );

    const formatText = (value) => escapeHtml(value).replace(/\n/g, "<br>");

    const splitDescription = (raw) => {
      const text = String(raw || "").replace(/\r\n/g, "\n").trim();
      if (!text) return { how: "", tip: "" };
      const tipRegex = /(?:^|\n)\s*–°–æ–≤–µ—Ç\s*:/i;
      const tipMatch = text.match(tipRegex);
      let how = text;
      let tip = "";
      if (tipMatch && typeof tipMatch.index === "number") {
        how = text.slice(0, tipMatch.index);
        tip = text.slice(tipMatch.index).replace(tipRegex, "");
      }
      how = how.replace(/–ö–∞–∫\s+–≤—ã–ø–æ–ª–Ω—è—Ç—å\s*:/i, "").trim();
      tip = tip.replace(/–°–æ–≤–µ—Ç\s*:/i, "").trim();
      if (!how && !tip) {
        how = text;
      }
      return { how, tip };
    };

    const buildDescriptionHtml = (raw) => {
      const sections = splitDescription(raw);
      const howText = sections.how || raw || "-";
      const tipText = sections.tip || "-";
      return `
        <div class="desc-block">
          <strong>–ö–∞–∫ –≤—ã–ø–æ–ª–Ω—è—Ç—å:</strong>
          <div>${formatText(howText)}</div>
        </div>
        <div class="desc-block">
          <strong>–°–æ–≤–µ—Ç:</strong>
          <div>${formatText(tipText)}</div>
        </div>
      `;
    };

    const setupPreview = (previewEl, card, previewUrl) => {
      if (!previewEl || !previewUrl) return false;
      let primed = false;
      let ready = false;
      const showPreview = () => {
        if (ready) return;
        if (previewEl.videoWidth > 0 && previewEl.videoHeight > 0 && previewEl.currentTime > 0) {
          ready = true;
          card.classList.add("has-preview");
        }
      };

      const prime = () => {
        if (primed) return;
        primed = true;
        previewEl.muted = true;
        previewEl.playsInline = true;
        previewEl.preload = "metadata";
        const src = previewUrl.includes("#") ? previewUrl : `${previewUrl}#t=0.1`;
        previewEl.src = src;

        previewEl.addEventListener("loadedmetadata", () => {
          try {
            const seekTo = Math.min(0.1, (previewEl.duration || 1) / 10);
            previewEl.currentTime = seekTo;
          } catch (_) {}
          if (previewEl.requestVideoFrameCallback) {
            previewEl.requestVideoFrameCallback(() => {
              previewEl.pause();
              showPreview();
            });
          }
        }, { once: true });
        previewEl.addEventListener("timeupdate", () => {
          previewEl.pause();
          showPreview();
        }, { once: true });
        previewEl.addEventListener("seeked", showPreview, { once: true });
        previewEl.addEventListener("error", () => {
          previewEl.removeAttribute("src");
        }, { once: true });

        try {
          previewEl.load();
          if (isAndroid) {
            const playAttempt = previewEl.play();
            if (playAttempt && typeof playAttempt.catch === "function") {
              playAttempt.catch(() => {});
            }
          }
        } catch (_) {}

        setTimeout(() => {
          if (!ready) {
            previewEl.removeAttribute("src");
            previewEl.load();
          }
        }, 1500);
      };

      if ("IntersectionObserver" in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              observer.disconnect();
              prime();
            }
          });
        }, { rootMargin: "200px" });
        observer.observe(card);
      } else {
        prime();
      }

      return true;
    };

    const renderExercises = (items) => {
      if (!list) return;
      list.innerHTML = "";
      if (!items.length) {
        list.innerHTML = "<div class='empty-state'>–ü–æ–∫–∞ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</div>";
        return;
      }
      items.forEach((exercise, i) => {
        const card = document.createElement("div");
        card.className = "exercise-card";
        const letter = (exercise.title || "–£").slice(0, 1);
        const hasVideo = Boolean(exercise.videoUrl);
        const previewUrl = exercise.videoUrl && !isYandexPublicLink(exercise.videoUrl) ? exercise.videoUrl : "";

        card.innerHTML = `
          <div class="thumb">
            <div class="thumb-placeholder">${letter}</div>
            <video class="thumb-video" muted playsinline preload="metadata"></video>
            <div class="thumb-overlay"><span class="play-icon">&#9654;</span></div>
            <span class="thumb-chip">${hasVideo ? "–í–∏–¥–µ–æ" : "–ë–µ–∑ –≤–∏–¥–µ–æ"}</span>
          </div>
          <div class="card-body">
            <h3>${exercise.title || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"}</h3>
            <div class="card-hint">–û—Ç–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</div>
          </div>
        `;

        const previewEl = card.querySelector(".thumb-video");
        if (previewEl && previewUrl) {
          setupPreview(previewEl, card, previewUrl);
        } else if (previewEl) {
          previewEl.remove();
        }

        card.addEventListener("click", () => openVideoModal(exercise));
        list.appendChild(card);
        setTimeout(() => { card.style.opacity = 1; card.style.transform = "translateY(0)"; }, 100 * i);
      });
    };

    const updateFilterUI = () => {
      filterButtons.forEach((btn) => {
        const key = btn.dataset.filter;
        btn.classList.toggle("is-active", key && activeFilters.has(key));
      });
    };

    const normalizeSearch = (value) => String(value || "").toLowerCase().trim();

    const applyFilters = () => {
      const showAll = activeFilters.size === 0 || activeFilters.size === FILTER_KEYS.length;
      const filteredByType = showAll
        ? allExercises
        : allExercises.filter((exercise) => exercise.crossfitType && activeFilters.has(exercise.crossfitType));
      const query = normalizeSearch(filterSearch?.value);
      const filtered = query
        ? filteredByType.filter((exercise) => {
            const title = normalizeSearch(exercise.title);
            const desc = normalizeSearch(exercise.description);
            return title.includes(query) || desc.includes(query);
          })
        : filteredByType;
      renderExercises(filtered);
    };

    const loadExercises = async () => {
      if (!apiBase) return;
      try {
        const query = new URLSearchParams({ type: "crossfit" });
        if (isGuestMode) query.set("guest", "1");
        const res = await fetch(`${apiBase}/api/exercises?${query.toString()}`);
        const json = await res.json().catch(() => ({}));
        if (json?.ok && Array.isArray(json.exercises)) {
          allExercises = json.exercises;
          applyFilters();
        }
      } catch (err) {
        console.warn("exercises load failed", err);
      }
    };

    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    if (filterToggle && filterPanel) {
      filterToggle.addEventListener("click", () => {
        filterPanel.hidden = !filterPanel.hidden;
      });
    }
    if (filterPanel) {
      filterPanel.addEventListener("click", (event) => {
        const btn = event.target.closest(".filter-chip");
        if (!btn) return;
        const key = btn.dataset.filter;
        if (!key) return;
        if (activeFilters.has(key)) {
          activeFilters.delete(key);
        } else {
          activeFilters.add(key);
        }
        updateFilterUI();
        applyFilters();
      });
    }
    if (filterSearch) {
      filterSearch.addEventListener("input", () => applyFilters());
    }

        const openVideoModal = async (exercise) => {
      if (!videoModal) return;
      if (isGuestMode && exercise && exercise.guestAccess === false) {
        showAlert("\u0423\u043f\u0440\u0430\u0436\u043d\u0435\u043d\u0438\u0435 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e \u0432 \u0433\u043e\u0441\u0442\u0435\u0432\u043e\u043c \u0434\u043e\u0441\u0442\u0443\u043f\u0435.");
        return;
      }
      currentVideoRequest += 1;
      const requestId = currentVideoRequest;
      const guestLocked = isGuestMode && (exercise?.guestAccess ?? true);
      const guestLockMessage = "\u0412\u0438\u0434\u0435\u043e \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u043e\u0441\u043b\u0435 \u043f\u043e\u043a\u0443\u043f\u043a\u0438 \u0442\u0430\u0440\u0438\u0444\u0430.";
      if (videoTitle) videoTitle.textContent = exercise?.title || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ";
      if (videoDesc) {
        videoDesc.innerHTML = buildDescriptionHtml(exercise?.description || "");
      }
      videoModal.classList.toggle("guest-locked", guestLocked);
      if (videoEl) {
        videoEl.pause();
        videoEl.removeAttribute("src");
        videoEl.style.display = "none";
        videoEl.onplay = null;
      }
      if (videoNote) {
        videoNote.style.display = "block";
        if (guestLocked && exercise?.videoUrl) {
          videoNote.textContent = guestLockMessage;
        } else {
          videoNote.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ...";
        }
      }
      videoModal.classList.add("show");
      videoModal.setAttribute("aria-hidden", "false");

      if (!exercise?.videoUrl) {
        currentVideoUrl = "";
        if (videoNote) videoNote.textContent = "–í–∏–¥–µ–æ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.";
        return;
      }

      currentVideoUrl = exercise.videoUrl || "";
      const resolvedUrl = await resolveVideoUrl(exercise.videoUrl);
      if (requestId !== currentVideoRequest) return;
      currentVideoUrl = resolvedUrl || exercise.videoUrl || "";

      if (resolvedUrl && videoEl) {
        videoEl.src = resolvedUrl;
        videoEl.style.display = "block";
        if (guestLocked) {
          videoEl.onplay = () => {
            videoEl.pause();
            showAlert(guestLockMessage);
            if (videoNote) {
              videoNote.style.display = "block";
              videoNote.textContent = guestLockMessage;
            }
          };
        } else {
          videoEl.onerror = () => {
            if (requestId !== currentVideoRequest) return;
            showVideoLink(resolvedUrl, "–í–∏–¥–µ–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.");
          };
        }
        videoEl.onloadeddata = () => {
          if (requestId !== currentVideoRequest) return;
          if (!guestLocked && videoNote) {
            videoNote.style.display = "block";
            videoNote.textContent = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–¥–µ–æ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å.";
          }
        };
        videoEl.onplaying = () => {
          if (requestId !== currentVideoRequest) return;
          if (!guestLocked && videoNote) videoNote.style.display = "none";
        };
        videoEl.load();
        if (!guestLocked) {
          const playAttempt = videoEl.play();
          if (playAttempt && typeof playAttempt.catch === "function") {
            playAttempt.catch(() => {
              if (requestId !== currentVideoRequest) return;
              showVideoLink(resolvedUrl, "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–¥–µ–æ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ.");
            });
          }
        }
      } else {
        if (guestLocked) {
          if (videoNote) videoNote.textContent = guestLockMessage;
        } else {
          showVideoLink(exercise.videoUrl, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ.");
        }
      }
    };

    document.getElementById("closeVideo").addEventListener("click", closeModal);
    window.addEventListener("click", (e) => {
      const modal = document.getElementById("videoModal");
      if (e.target === modal) closeModal();
    });

    function closeModal() {
      if (videoModal) {
        videoModal.classList.remove("show");
        videoModal.classList.remove("guest-locked");
        videoModal.setAttribute("aria-hidden", "true");
      }
      currentVideoUrl = "";
      if (videoEl) {
        videoEl.pause();
        videoEl.removeAttribute("src");
        videoEl.onplay = null;
      }
      if (videoNote) {
        videoNote.textContent = "";
      }
    }

    const initPage = async () => {
      const allowed = await enforceBaseAccess();
      if (!allowed) return;
      document.body.classList.toggle("guest-mode", isGuestMode);
      loadExercises();
    };

    initPage();
  </script>
</body>
</html>




