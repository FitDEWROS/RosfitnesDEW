<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RosApp ‚Äî –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</title>

  <!-- ‚úÖ –ï–¥–∏–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—â–µ–π —Ç–µ–º—ã -->
  <link rel="stylesheet" href="styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>

<body>
  <div class="wrap">
    <header class="header">
      <button id="btnBackNav" class="nav-btn">‚Üê –ù–∞–∑–∞–¥</button>
    </header>

    <main class="muscle-wrap" aria-live="polite">
      <div class="view-switch" role="tablist" aria-label="–í—ã–±–æ—Ä –≤–∏–¥–∞ —Ç–µ–ª–∞">
        <button id="btnFront" class="active" role="tab" aria-selected="true">–í–∏–¥ —Å–ø–µ—Ä–µ–¥–∏</button>
        <button id="btnBack" role="tab" aria-selected="false">–í–∏–¥ —Å–∑–∞–¥–∏</button>
        <button id="btnDebug" class="debug-toggle">–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏</button>
      </div>

      <div id="frontView" class="canvas" style="display:block">
        <object id="svgFront" class="svg-host" type="image/svg+xml" data="front.svg"></object>
      </div>

      <div id="backView" class="canvas" style="display:none">
        <object id="svgBack" class="svg-host" type="image/svg+xml" data="back.svg"></object>
      </div>

      <section id="info" class="info" aria-live="polite">
        <h3>–í—ã–±–µ—Ä–∏ –º—ã—à—Ü—É</h3>
        <p class="legend">–ù–∞–∂–º–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç—å –Ω–∞ —Å–∏–ª—É—ç—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</p>
      </section>
    </main>
  </div>

  <script>
    /* === üåó –¢–µ–º–∞ === */
    (function() {
      const savedTheme = localStorage.getItem("theme") || "dark";
      document.documentElement.classList.toggle("light", savedTheme === "light");
    })();

    /* === üîô –ù–∞–∑–∞–¥ === */
    document.getElementById("btnBackNav").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    window.addEventListener("popstate", () => window.location.href = "index.html");
    history.pushState({ page: "exercises" }, "", window.location.href);

    /* === ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ === */
    const btnFront = document.getElementById('btnFront');
    const btnBack  = document.getElementById('btnBack');
    const btnDebug = document.getElementById('btnDebug');
    const front    = document.getElementById('frontView');
    const back     = document.getElementById('backView');
    const info     = document.getElementById('info');

    let debugMode = false;

    btnDebug.onclick = () => {
      debugMode = !debugMode;
      btnDebug.classList.toggle("active", debugMode);
      btnDebug.textContent = debugMode ? "–û—Ç–ª–∞–¥–∫–∞: –í–ö–õ" : "–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏";
    };

    function setView(isFront){
      front.style.display = isFront ? "block" : "none";
      back.style.display  = isFront ? "none" : "block";
      btnFront.classList.toggle('active', isFront);
      btnBack.classList.toggle('active', !isFront);
      btnFront.setAttribute('aria-selected', String(isFront));
      btnBack.setAttribute('aria-selected', String(!isFront));
      info.innerHTML = `<h3>–í—ã–±–µ—Ä–∏ –º—ã—à—Ü—É</h3>
        <p class="legend">–ù–∞–∂–º–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç—å –Ω–∞ —Å–∏–ª—É—ç—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</p>`;
    }

    btnFront.onclick = () => setView(true);
    btnBack.onclick  = () => setView(false);

    const DB = {
      abs:['–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è','–ü–æ–¥—ä—ë–º –Ω–æ–≥ –≤ –≤–∏—Å–µ','–ü–ª–∞–Ω–∫–∞'],
      chest:['–ñ–∏–º –ª—ë–∂–∞','–û—Ç–∂–∏–º–∞–Ω–∏—è','–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ'],
      biceps:['–ü–æ–¥—ä—ë–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å','–ì–∞–Ω—Ç–µ–ª–∏ —Å–∏–¥—è'],
      delts:['–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è','–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π —Å—Ç–æ—è'],
      forearm:['–°–≥–∏–±–∞–Ω–∏—è –∫–∏—Å—Ç–µ–π —Å–æ —à—Ç–∞–Ω–≥–æ–π','–û–±—Ä–∞—Ç–Ω—ã–µ —Å–≥–∏–±–∞–Ω–∏—è'],
      obliques:['–†—É—Å—Å–∫–∏–µ —Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è','–ë–æ–∫–æ–≤–∞—è –ø–ª–∞–Ω–∫–∞'],
      quads:['–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è','–í—ã–ø–∞–¥—ã','–ñ–∏–º –Ω–æ–≥–∞–º–∏'],
      calves:['–ü–æ–¥—ä—ë–º—ã –Ω–∞ –Ω–æ—Å–∫–∏ —Å—Ç–æ—è','–ü–æ–¥—ä—ë–º—ã —Å–∏–¥—è'],
      traps:['–®—Ä–∞–≥–∏','–¢—è–≥–∞ –∫ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É'],
      rearDelts:['–û–±—Ä–∞—Ç–Ω–∞—è —Ä–∞–∑–≤–æ–¥–∫–∞','–¢—è–≥–∞ –∫ –ª–∏—Ü—É'],
      lats:['–¢—è–≥–∞ –±–ª–æ–∫–∞','–¢—è–≥–∞ –≤ –Ω–∞–∫–ª–æ–Ω–µ'],
      triceps:['–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º','–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ'],
      erectors:['–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è','–¢—è–≥–∞ —Å –ø–æ–ª–∞'],
      glutes:['–Ø–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç','–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞'],
      hams:['–°–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥ –ª—ë–∂–∞','–¢—è–≥–∞ —Ä—É–º—ã–Ω—Å–∫–∞—è'],
      adductors:['–°–≤–µ–¥–µ–Ω–∏–µ –Ω–æ–≥ –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ'],
      hipFlexors:['–ü–æ–¥—ä—ë–º –ø—Ä—è–º—ã—Ö –Ω–æ–≥ –ª—ë–∂–∞'],
      tibialis:['–ü–æ–¥—ä—ë–º—ã –Ω–æ—Å–∫–æ–≤ —Å–∏–¥—è']
    };

    const GROUPS = {
      abs: ["abs-1","abs-2","abs-3","abs-4","abs-5","abs-6","abs-7","abs-8"],
      chest: ["chest-1","chest-2"],
      biceps: ["biceps-left-1","biceps-left-2","biceps-right-1","biceps-right-2"],
      delts: ["delts-left","delts-right"],
      forearm: ["forearm-left-1","forearm-left-2","forearm-left-3","forearm-right-1","forearm-right-2","forearm-right-3"],
      obliques: ["obliques-left-1","obliques-left-2","obliques-left-3","obliques-left-4","obliques-left-5",
                 "obliques-right-1","obliques-right-2","obliques-right-3","obliques-right-4","obliques-right-5"],
      quads: ["quads-left","quads-right"],
      calves: ["calves-left","calves-right"],
      triceps: ["triceps-left","triceps-right"],
      rearDelts: ["rear-delts-left","rear-delts-right"],
      lats: ["lats-left","lats-right"],
      glutes: ["glutes-left","glutes-right"],
      hams: ["hams-left","hams-right"],
      traps: ["traps"],
      erectors: ["erectors"],
      adductors: ["adductors-left","adductors-right"],
      hipFlexors: ["hip-flexors-left","hip-flexors-right"],
      tibialis: ["tibialis-left","tibialis-right"]
    };

    function findGroup(id){
      for (let key in GROUPS){
        if (GROUPS[key].includes(id)) return key;
      }
      return null;
    }

    function attachHandlers(obj){
      obj.addEventListener("load", () => {
        const svgDoc = obj.contentDocument || obj.getSVGDocument();
        if (!svgDoc) return;

        Object.values(GROUPS).flat().forEach(id => {
          const el = svgDoc.getElementById(id);
          if (el) el.classList.add('muscle');
        });

        svgDoc.querySelectorAll("path").forEach((el, idx) => {
          if (!el.id) el.id = "auto-path-" + idx;

          el.addEventListener("pointerdown", () => {
            svgDoc.querySelectorAll(".muscle.active, .muscle-test")
                  .forEach(m => m.classList.remove("active","muscle-test"));

            const groupKey = findGroup(el.id);

            if (debugMode) {
              const list = groupKey ? GROUPS[groupKey] : [el.id];
              list.forEach(gid => {
                const g = svgDoc.getElementById(gid);
                if (!g) return;
                g.classList.add("muscle-test");
                const d = g.getAttribute("d") || "";
                const match = d.match(/M\s*([0-9.\-]+),\s*([0-9.\-]+)/i);
                const coords = match ? `X=${match[1]}, Y=${match[2]}` : "–Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
                alert(`–ú—ã—à—Ü–∞: ${gid}\n${coords}`);
              });
              return;
            }

            if (groupKey) {
              GROUPS[groupKey].forEach(gid => {
                const g = svgDoc.getElementById(gid);
                if (g) g.classList.add("active");
              });
              const list = DB[groupKey] || ['–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π'];
              info.innerHTML = `<h3>${humanName(groupKey)}</h3><ul>${list.map(x=>`<li>${x}</li>`).join('')}</ul>`;
            }
          });
        });
      });
    }

    attachHandlers(document.getElementById("svgFront"));
    attachHandlers(document.getElementById("svgBack"));

    function humanName(key){
      const map = {
        chest:"–ì—Ä—É–¥—å", abs:"–ü—Ä–µ—Å—Å",
        biceps:"–ë–∏—Ü–µ–ø—Å—ã", delts:"–î–µ–ª—å—Ç—ã",
        forearm:"–ü—Ä–µ–¥–ø–ª–µ—á—å—è", obliques:"–ö–æ—Å—ã–µ",
        quads:"–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å—ã", calves:"–ò–∫—Ä—ã",
        traps:"–¢—Ä–∞–ø–µ—Ü–∏–∏", rearDelts:"–ó–∞–¥–Ω–∏–µ –¥–µ–ª—å—Ç—ã",
        lats:"–®–∏—Ä–æ—á–∞–π—à–∏–µ", triceps:"–¢—Ä–∏—Ü–µ–ø—Å—ã",
        erectors:"–†–∞–∑–≥–∏–±–∞—Ç–µ–ª–∏ —Å–ø–∏–Ω—ã",
        glutes:"–Ø–≥–æ–¥–∏—Ü—ã", hams:"–ë–∏—Ü–µ–ø—Å—ã –±–µ–¥—Ä–∞",
        adductors:"–ü—Ä–∏–≤–æ–¥—è—â–∏–µ", hipFlexors:"–°–≥–∏–±–∞—Ç–µ–ª–∏ –±–µ–¥—Ä–∞",
        tibialis:"–ë–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤—ã–µ"
      };
      return map[key] || key;
    }
  </script>
</body>
</html>
