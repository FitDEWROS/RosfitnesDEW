<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RosApp ‚Äî –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</title>

  <!-- ‚úÖ –ï–¥–∏–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—â–µ–π —Ç–µ–º—ã -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@500;700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script src="env.js?v=20260115"></script>
  <style>
    body.guest-mode .view-toggle {
      display: none;
    }
    #videoModal.guest-locked .video-desc,
    #videoModal.guest-locked #exerciseVideo {
      filter: blur(6px);
    }
    #videoModal.guest-locked #exerciseVideo {
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="header header--split">
      <button id="btnBackNav" class="back-btn" type="button">–ù–∞–∑–∞–¥</button>
      <div class="view-toggle" role="tablist" aria-label="–í–∏–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã">
        <button class="view-toggle-btn is-active" data-view="map" role="tab" aria-selected="true">–°–∏–ª—É—ç—Ç</button>
        <button class="view-toggle-btn" data-view="list" role="tab" aria-selected="false">–°–ø–∏—Å–æ–∫</button>
      </div>
    </header>

    <main class="muscle-wrap" aria-live="polite">
      <div id="mapView" class="map-view is-hidden" hidden>
        <div class="view-switch" role="tablist" aria-label="–í—ã–±–æ—Ä –≤–∏–¥–∞ —Ç–µ–ª–∞">
          <button id="btnFront" class="active" role="tab" aria-selected="true">–í–∏–¥ —Å–ø–µ—Ä–µ–¥–∏</button>
          <button id="btnBack" role="tab" aria-selected="false">–í–∏–¥ —Å–∑–∞–¥–∏</button>
          <button id="btnDebug" class="debug-toggle" hidden>–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏</button>
        </div>

        <div id="frontView" class="canvas" style="display:block">
          <object id="svgFront" class="svg-host" type="image/svg+xml" data="front.svg?v=3"></object>
        </div>

        <div id="backView" class="canvas" style="display:none">
          <object id="svgBack" class="svg-host" type="image/svg+xml" data="back.svg?v=3"></object>
        </div>

        <section id="info" class="info" aria-live="polite">
          <h3>–í—ã–±–µ—Ä–∏ –º—ã—à—Ü—É</h3>
          <p class="legend">–ù–∞–∂–º–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç—å –Ω–∞ —Å–∏–ª—É—ç—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</p>
        </section>
      </div>

      <section id="listView" class="exercise-list-view" hidden>
        <div class="list-head">
          <div class="list-title-group">
            <span class="header-eyebrow">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
            <h3 class="list-title">–ó–∞–ª</h3>
          </div>
          <span class="muted list-subtitle">–ö–∞—Ç–∞–ª–æ–≥ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</span>
        </div>
        <div class="list-controls">
          <label class="list-search" aria-label="–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
            <input id="listSearch" type="search" placeholder="–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" autocomplete="off">
          </label>
          <div class="density-toggle" role="group" aria-label="–ö–æ–ª–æ–Ω–∫–∏">
            <button class="density-btn" type="button" data-cols="2" aria-label="–ö–æ–ª–æ–Ω–∫–∏: 2">2</button>
          </div>
        </div>
        <div class="exercise-list" id="exerciseList" data-cols="2"></div>
        <div class="empty-state" id="exerciseEmpty" hidden>–ü–æ–∫–∞ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</div>
      </section>
    </main>
  </div>

  <div id="videoModal" class="modal" aria-hidden="true">
    <div class="video-modal" role="dialog" aria-modal="true">
<video id="exerciseVideo" controls controlslist="nodownload noplaybackrate" disablepictureinpicture></video>
      <h3 class="video-title" id="videoTitle"></h3>
      <p class="video-note" id="videoNote">–í–∏–¥–µ–æ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</p>
      <div class="video-desc" id="videoDesc"></div>
      <div class="video-actions">
        <button class="modal-open" id="openVideo" type="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="modal-close" id="closeVideo" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

    </div>
  </div>

  

  <script>
    /* === üåó –¢–µ–º–∞ === */
    (function() {
      const savedTheme = localStorage.getItem("theme") || "dark";
      document.documentElement.classList.toggle("light", savedTheme === "light");
    })();

    /* === üîô –ù–∞–∑–∞–¥ === */
    document.getElementById("btnBackNav").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    window.addEventListener("popstate", () => window.location.href = "index.html");
    history.pushState({ page: "exercises" }, "", window.location.href);

    const tg = window.Telegram?.WebApp || null;
    const API_BASE = window.ENV?.API_BASE || "";
    const apiBase = API_BASE ? API_BASE.replace(/\/$/, "") : "";
    const mapView = document.getElementById("mapView");
    const listView = document.getElementById("listView");
    const viewButtons = document.querySelectorAll("[data-view]");
    const viewToggle = document.querySelector(".view-toggle");
    const viewSwitch = document.querySelector(".view-switch");
    const exerciseList = document.getElementById("exerciseList");
    const exerciseEmpty = document.getElementById("exerciseEmpty");
    const listSearch = document.getElementById("listSearch");
    const videoModal = document.getElementById("videoModal");
    const videoEl = document.getElementById("exerciseVideo");
    const videoTitle = document.getElementById("videoTitle");
    const videoDesc = document.getElementById("videoDesc");
    const videoNote = document.getElementById("videoNote");
    const openVideoBtn = document.getElementById("openVideo");
    const closeVideo = document.getElementById("closeVideo");
    const densityButton = document.querySelector(".density-btn");
    const densityOrder = ["1", "2"];
    const isAndroid = /Android/i.test(navigator.userAgent);
    const showAlert = (msg) => (tg?.showAlert ? tg.showAlert(msg) : alert(msg));
    let isGuestMode = false;
    let isOwner = false;
    let debugAllowed = false;

    const buildInitData = () => {
      const raw = tg?.initData || "";
      if (raw && raw.length > 0) return raw;

      const u = tg?.initDataUnsafe || null;
      if (!u || !u.hash) return "";

      const p = new URLSearchParams();
      if (u.query_id) p.set("query_id", u.query_id);
      if (u.user) p.set("user", JSON.stringify(u.user));
      if (u.auth_date) p.set("auth_date", String(u.auth_date));
      if (u.start_param) p.set("start_param", u.start_param);
      if (u.chat_type) p.set("chat_type", u.chat_type);
      if (u.chat_instance) p.set("chat_instance", u.chat_instance);
      p.set("hash", u.hash);
      return p.toString();
    };

    const fetchUserProfile = async () => {
      if (!apiBase || !tg) return null;
      const initData = buildInitData();
      if (!initData) return null;
      try {
        const res = await fetch(`${apiBase}/api/user?initData=${encodeURIComponent(initData)}`);
        const json = await res.json().catch(() => ({}));
        return json?.profile || null;
      } catch (err) {
        console.warn("profile fetch failed", err);
        return null;
      }
    };

    const isBasicTariff = (tariff) => String(tariff || "").toLowerCase().includes("–±–∞–∑–æ–≤");
    const isGuestTariff = (tariff) => {
      const value = String(tariff || "").toLowerCase().trim();
      return !value || value.includes("–±–µ–∑ —Ç–∞—Ä–∏—Ñ–∞") || value.includes("–≥–æ—Å—Ç");
    };

    const isStaffProfile = (profile) => {
      if (!profile) return false;
      const role = profile.role;
      return role === "admin" || role === "sadmin" || role === "curator" || Boolean(profile.isCurator);
    };

    const normalizeScope = (value) => (value === "gym" || value === "crossfit" || value === "both" ? value : "both");

    const enforceBaseAccess = async () => {
      const profile = await fetchUserProfile();
      if (!profile) {
        isOwner = false;
        debugAllowed = false;
        return true;
      }
      isOwner = profile.role === "sadmin";
      debugAllowed = isOwner && localStorage.getItem("debug_mode_enabled") === "1";
      if (isStaffProfile(profile)) {
        isGuestMode = false;
        const scope = normalizeScope(profile.trainerScope);
        if (scope === "crossfit") {
          localStorage.setItem("training_mode", "crossfit");
          window.location.replace("crossfit_exercises.html");
          return false;
        }
        if (scope === "gym") {
          localStorage.setItem("training_mode", "gym");
        }
        return true;
      }
      isGuestMode = isGuestTariff(profile.tariffName);
      if (!isBasicTariff(profile.tariffName)) return true;
      const mode = profile.trainingMode === "crossfit" ? "crossfit" : "gym";
      localStorage.setItem("training_mode", mode);
      if (mode !== "gym") {
        showAlert("\u042d\u0442\u043e\u0442 \u0440\u0430\u0437\u0434\u0435\u043b \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u041a\u0440\u043e\u0441\u0441\u0444\u0438\u0442.");
        window.location.replace("crossfit_exercises.html");
        return false;
      }
      return true;
    };

    const normalizeCols = (value) => {
      const str = String(value || "");
      return densityOrder.includes(str) ? str : "2";
    };

    const applyDensity = (cols) => {
      if (!exerciseList) return;
      const safeCols = normalizeCols(cols);
      exerciseList.dataset.cols = safeCols;
      if (densityButton) {
        densityButton.dataset.cols = safeCols;
        densityButton.textContent = safeCols;
        densityButton.setAttribute("aria-label", `–ö–æ–ª–æ–Ω–∫–∏: ${safeCols}`);
      }
    };

    if (exerciseList && densityButton) {
      const savedCols = normalizeCols(localStorage.getItem("exercise_cols"));
      localStorage.setItem("exercise_cols", savedCols);
      applyDensity(savedCols);
      densityButton.addEventListener("click", () => {
        const current = normalizeCols(densityButton.dataset.cols || "2");
        const idx = densityOrder.indexOf(current);
        const next = densityOrder[(idx + 1) % densityOrder.length];
        localStorage.setItem("exercise_cols", next);
        applyDensity(next);
      });
    }

    /* === ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ === */
    const btnFront = document.getElementById('btnFront');
    const btnBack  = document.getElementById('btnBack');
    const btnDebug = document.getElementById('btnDebug');
    const front    = document.getElementById('frontView');
    const back     = document.getElementById('backView');
    const info     = document.getElementById('info');

    let debugMode = false;
    let exerciseLibrary = [];
    let lastGroup = null;
    let currentVideoRequest = 0;
    let currentVideoUrl = "";
    let currentVideoLocked = false;

    const setInfoVisible = (visible) => {
      if (!info) return;
      info.hidden = !visible;
      info.classList.toggle("is-hidden", !visible);
      info.setAttribute("aria-hidden", visible ? "false" : "true");
    };

    const showInfo = () => setInfoVisible(true);
    const hideInfo = () => setInfoVisible(false);

    hideInfo();

    const applyDebugVisibility = () => {
      if (!btnDebug) return;
      btnDebug.hidden = !debugAllowed;
      btnDebug.setAttribute("aria-hidden", debugAllowed ? "false" : "true");
      if (viewSwitch) {
        viewSwitch.classList.toggle("no-debug", !debugAllowed);
      }
      if (!debugAllowed) {
        debugMode = false;
        btnDebug.classList.remove("active");
        btnDebug.textContent = "–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏";
      }
    };

    btnDebug.onclick = () => {
      if (!debugAllowed) return;
      debugMode = !debugMode;
      btnDebug.classList.toggle("active", debugMode);
      btnDebug.textContent = debugMode ? "–û—Ç–ª–∞–¥–∫–∞: –í–ö–õ" : "–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏";
    };

    function setView(isFront){
      front.style.display = isFront ? "block" : "none";
      back.style.display  = isFront ? "none" : "block";
      btnFront.classList.toggle('active', isFront);
      btnBack.classList.toggle('active', !isFront);
      btnFront.setAttribute('aria-selected', String(isFront));
      btnBack.setAttribute('aria-selected', String(!isFront));
      hideInfo();
    }

    btnFront.onclick = () => setView(true);
    btnBack.onclick  = () => setView(false);

    const muscleKeywords = {
      traps: ["—Ç—Ä–∞–ø–µ—Ü", "—Ç—Ä–∞–ø", "—à—Ä–∞–≥"],
      chest: ["–≥—Ä—É–¥", "–∂–∏–º", "–æ—Ç–∂–∏–º", "—Å–≤–µ–¥–µ–Ω–∏–µ"],
      delts: ["–¥–µ–ª—å—Ç", "–ø–ª–µ—á", "—Ä–∞–∑–≤–æ–¥", "–∂–∏–º"],
      biceps: ["–±–∏—Ü–µ–ø—Å", "—Å–≥–∏–±", "–ø–æ–¥—ä–µ–º", "–ø–æ–¥—ä—ë–º"],
      forearm: ["–ø—Ä–µ–¥–ø–ª–µ—á", "–∫–∏—Å—Ç", "—Ö–≤–∞—Ç"],
      abs: ["–ø—Ä–µ—Å—Å", "—Å–∫—Ä—É—á", "–ø–ª–∞–Ω–∫", "–∫–æ—Ä"],
      quads: ["–∫–≤–∞–¥—Ä–∏—Ü", "–ø—Ä–∏—Å–µ–¥", "–≤—ã–ø–∞–¥", "–∂–∏–º –Ω–æ–≥"],
      adductors: ["–ø—Ä–∏–≤–æ–¥", "—Å–≤–µ–¥–µ–Ω–∏–µ", "–≤–Ω—É—Ç—Ä"],
      tibialis: ["–ø–µ—Ä–µ–¥–Ω", "–≥–æ–ª–µ–Ω", "–±–µ—Ä—Ü", "—Ç–∏–±–∏–∞–ª"],
      upperBack: ["–≤–µ—Ä—Ö —Å–ø–∏–Ω", "—Ä–æ–º–±", "–ª–æ–ø–∞—Ç", "—Ç—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç", "—Å–≤–µ–¥–µ–Ω–∏–µ –ª–æ–ø–∞—Ç"],
      triceps: ["—Ç—Ä–∏—Ü–µ–ø—Å", "—Ä–∞–∑–≥–∏–±", "—Ñ—Ä–∞–Ω—Ü—É–∑"],
      lats: ["—à–∏—Ä–æ—á", "–ø–æ–¥—Ç—è–≥", "—Ç—è–≥–∞ –≤–µ—Ä—Ö–Ω", "—Ç—è–≥–∞ –∫ –ø–æ—è—Å—É"],
      erectors: ["–ø–æ—è—Å–Ω–∏—Ü", "–Ω–∏–∂–Ω —Å–ø–∏–Ω", "–≥–∏–ø–µ—Ä—ç–∫—Å—Ç", "—Ä–∞–∑–≥–∏–±"],
      glutes: ["—è–≥–æ–¥", "–º–æ—Å—Ç", "—Ç–∞–∑"],
      hams: ["—Ö–∞–º—Å—Ç—Ä", "–∑–∞–¥–Ω –±–µ–¥—Ä", "—Ä—É–º—ã–Ω", "—Å–≥–∏–±"],
      calves: ["–∏–∫—Ä", "–Ω–æ—Å–æ–∫"]
    };

    const GROUPS = {
      traps: ["traps-left", "traps-left1", "traps-right", "traps-right1"],
      chest: ["chest-left", "chest-right"],
      delts: ["delts-left", "delts-left1",  "delts-right", "delts-right1"],
      biceps: ["biceps-left", "biceps-right"],
      forearm: ["forearm-left-1", "forearm-left-2", "forearm-left-3", "forearm-left-4", "forearm-left-5", "forearm-left-6", "forearm-left-7", "forearm-right-1", "forearm-right-2", "forearm-right-3", "forearm-right-4", "forearm-right-5", "forearm-right-6", "forearm-right-7"],
      abs: ["abs-1","abs-2","abs-3","abs-4","abs-5","abs-6","abs-7","abs-8"],
      quads: ["quads-left-1","quads-left-2", "quads-right-1", "quads-right-2"],
      adductors: ["adductors-left-1", "adductors-left-2", "adductors-right-1", "adductors-right-2"],
      tibialis: ["tibialis-left-1","tibialis-left-2","tibialis-left-3", "tibialis-right-1", "tibialis-right-2", "tibialis-right-3"],
      upperBack: ["upper-back-left-1", "upper-back-left-2", "upper-back-left-3", "upper-back-right-1", "upper-back-right-2", "upper-back-right-3"],
      triceps: ["triceps-left-1", "triceps-left-2", "triceps-left-3", "triceps-right-1", "triceps-right-2", "triceps-right-3"],
      lats: ["lats-left", "lats-left-1", "lats-right", "lats-right-1"],
      erectors: ["lower-back-left", "lower-back-right"],
      glutes: ["glutes-left", "glutes-right"],
      hams: ["hams-left", "hams-right"],
      calves: ["calves-left-1", "calves-left-2", "calves-right-1", "calves-right-2"]
    };

    function findGroup(id){
      for (let key in GROUPS){
        if (GROUPS[key].includes(id)) return key;
      }
      return null;
    }

    const normalizeMuscleName = (value) => (
      (value || "").toLowerCase().replace(/\s+/g, " ").trim()
    );

    const emptyExercisesMessage = "\u041d\u0435\u0442 \u0443\u043f\u0440\u0430\u0436\u043d\u0435\u043d\u0438\u0439.";
    const defaultExerciseTitle = "\u0423\u043f\u0440\u0430\u0436\u043d\u0435\u043d\u0438\u0435";
    const generalMuscleName = "\u041e\u0431\u0449\u0430\u044f";

    const getExerciseMuscles = (exercise) => {
      if (!exercise) return [];
      if (Array.isArray(exercise.muscles) && exercise.muscles.length) return exercise.muscles;
      if (exercise.muscle) return [exercise.muscle];
      return [];
    };

    const getEffectiveMuscles = (exercise) => (
      getExerciseMuscles(exercise)
        .map(normalizeMuscleName)
        .filter((muscle) => muscle && muscle !== normalizeMuscleName(generalMuscleName))
    );

    const getExercisesForGroup = (groupKey) => {
      if (!exerciseLibrary.length) {
        return { items: [], message: emptyExercisesMessage };
      }
      const targetMuscle = normalizeMuscleName(humanName(groupKey));
      let matches = exerciseLibrary.filter((exercise) => {
        const muscles = getEffectiveMuscles(exercise);
        return muscles.includes(targetMuscle);
      });

      if (!matches.length) {
        const keywords = muscleKeywords[groupKey] || [];
        if (!keywords.length) {
          return { items: [], message: emptyExercisesMessage };
        }
        matches = exerciseLibrary.filter((exercise) => {
          if (getEffectiveMuscles(exercise).length) return false;
          const haystack = `${exercise.title || ""} ${exercise.description || ""}`.toLowerCase();
          return keywords.some((word) => haystack.includes(word));
        });
      }

      if (!matches.length) {
        return { items: [], message: emptyExercisesMessage };
      }
      return { items: matches, message: emptyExercisesMessage };
    };

    const renderInfoList = (groupKey) => {
      if (!info) return;
      const data = getExercisesForGroup(groupKey);
      info.innerHTML = "";
      const titleEl = document.createElement("h3");
      titleEl.textContent = humanName(groupKey);
      info.appendChild(titleEl);
      showInfo();

      if (!data.items.length) {
        const empty = document.createElement("p");
        empty.className = "legend";
        empty.textContent = data.message;
        info.appendChild(empty);
        return;
      }

      const listEl = document.createElement("ul");
      listEl.className = "muscle-list";
      data.items.forEach((exercise) => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "muscle-item";
        if (exercise && exercise.id !== undefined && exercise.id !== null) {
          btn.dataset.exId = String(exercise.id);
        }
        const exIndex = exerciseLibrary.indexOf(exercise);
        if (exIndex >= 0) {
          btn.dataset.exIndex = String(exIndex);
        }
        btn.textContent = exercise.title || defaultExerciseTitle;
        li.appendChild(btn);
        listEl.appendChild(li);
      });
      info.appendChild(listEl);
    };

    function attachHandlers(obj){
      obj.addEventListener("load", () => {
        const svgDoc = obj.contentDocument || obj.getSVGDocument();
        if (!svgDoc) return;

        Object.values(GROUPS).flat().forEach(id => {
          const el = svgDoc.getElementById(id);
          if (el) el.classList.add('muscle');
        });

        svgDoc.querySelectorAll("path").forEach((el, idx) => {
          if (!el.id) el.id = "auto-path-" + idx;

          el.addEventListener("pointerdown", () => {
            svgDoc.querySelectorAll(".muscle.active, .muscle-test")
                  .forEach(m => m.classList.remove("active","muscle-test"));

            const groupKey = findGroup(el.id);

            if (debugMode) {
              const list = groupKey ? GROUPS[groupKey] : [el.id];
              list.forEach(gid => {
                const g = svgDoc.getElementById(gid);
                if (!g) return;
                g.classList.add("muscle-test");
                const d = g.getAttribute("d") || "";
                const match = d.match(/M\s*([0-9.\-]+),\s*([0-9.\-]+)/i);
                const coords = match ? `X=${match[1]}, Y=${match[2]}` : "–Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
                alert(`–ú—ã—à—Ü–∞: ${gid}\n${coords}`);
              });
              return;
            }

            if (groupKey) {
              lastGroup = groupKey;
              GROUPS[groupKey].forEach(gid => {
                const g = svgDoc.getElementById(gid);
                if (g) g.classList.add("active");
              });
              renderInfoList(groupKey);
            }
          });
        });

        const svgRoot = svgDoc.documentElement;
        if (svgRoot) {
          svgRoot.addEventListener("pointerdown", (event) => {
            const target = event.target;
            if (target && typeof target.closest === "function" && target.closest(".muscle")) return;
            hideInfo();
          });
        }
      });
    }

    attachHandlers(document.getElementById("svgFront"));
    attachHandlers(document.getElementById("svgBack"));

    if (mapView) {
      mapView.addEventListener("pointerdown", (event) => {
        if (!info || info.classList.contains("is-hidden")) return;
        if (info.contains(event.target)) return;
        const target = event.target;
        if (target && typeof target.closest === "function" && target.closest(".svg-host")) return;
        hideInfo();
      });
    }

    function humanName(key){
      const map = {
        traps: "–¢—Ä–∞–ø–µ—Ü–∏–µ–≤–∏–¥–Ω–∞—è –º—ã—à—Ü–∞",
        chest: "–ë–æ–ª—å—à–∞—è –≥—Ä—É–¥–Ω–∞—è –º—ã—à—Ü–∞",
        delts: "–î–µ–ª—å—Ç–æ–≤–∏–¥–Ω–∞—è –º—ã—à—Ü–∞",
        biceps: "–î–≤—É–≥–ª–∞–≤–∞—è –º—ã—à—Ü–∞ –ø–ª–µ—á–∞ (–±–∏—Ü–µ–ø—Å)",
        forearm: "–ú—ã—à—Ü—ã –ø—Ä–µ–¥–ø–ª–µ—á—å—è",
        abs: "–ü—Ä—è–º–∞—è –º—ã—à—Ü–∞ –∂–∏–≤–æ—Ç–∞",
        quads: "–ú—ã—à—Ü—ã –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å–∞",
        adductors: "–ü—Ä–∏–≤–æ–¥—è—â–∞—è –º—ã—à—Ü–∞",
        tibialis: "–ü–µ—Ä–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞ –º—ã—à—Ü –≥–æ–ª–µ–Ω–∏",
        upperBack: "–ú—ã—à—Ü—ã –≤–µ—Ä—Ö–∞ —Å–ø–∏–Ω—ã",
        triceps: "–¢—Ä–µ—Ö–≥–ª–∞–≤–∞—è –º—ã—à—Ü–∞ –ø–ª–µ—á–∞ (—Ç—Ä–∏—Ü–µ–ø—Å)",
        lats: "–®–∏—Ä–æ—á–∞–π—à–∞—è –º—ã—à—Ü–∞ —Å–ø–∏–Ω—ã",
        erectors: "–ú—ã—à—Ü—ã –Ω–∏–∑–∞ —Å–ø–∏–Ω—ã",
        glutes: "–ë–æ–ª—å—à–∞—è —è–≥–æ–¥–∏—á–Ω–∞—è –º—ã—à—Ü–∞",
        hams: "–•–∞–º—Å—Ç—Ä–∏–Ω–≥–∏ (–º—ã—à—Ü—ã –∑–∞–¥–Ω–µ–π —á–∞—Å—Ç–∏ –±–µ–¥—Ä–∞)",
        calves: "–ò–∫—Ä–æ–Ω–æ–∂–Ω–∞—è –º—ã—à—Ü–∞"
      };
      return map[key] || key;
    }

    const setupPreview = (previewEl, card, previewUrl) => {
      if (!previewEl || !previewUrl) return false;
      let primed = false;
      let ready = false;
      const showPreview = () => {
        if (ready) return;
        if (previewEl.videoWidth > 0 && previewEl.videoHeight > 0 && previewEl.currentTime > 0) {
          ready = true;
          card.classList.add("has-preview");
        }
      };

      const prime = () => {
        if (primed) return;
        primed = true;
        previewEl.muted = true;
        previewEl.playsInline = true;
        previewEl.preload = "metadata";
        const src = previewUrl.includes("#") ? previewUrl : `${previewUrl}#t=0.1`;
        previewEl.src = src;

        previewEl.addEventListener("loadedmetadata", () => {
          try {
            const seekTo = Math.min(0.1, (previewEl.duration || 1) / 10);
            previewEl.currentTime = seekTo;
          } catch (_) {}
          if (previewEl.requestVideoFrameCallback) {
            previewEl.requestVideoFrameCallback(() => {
              previewEl.pause();
              showPreview();
            });
          }
        }, { once: true });
        previewEl.addEventListener("timeupdate", () => {
          previewEl.pause();
          showPreview();
        }, { once: true });
        previewEl.addEventListener("seeked", showPreview, { once: true });
        previewEl.addEventListener("error", () => {
          previewEl.removeAttribute("src");
        }, { once: true });

        try {
          previewEl.load();
          if (isAndroid) {
            const playAttempt = previewEl.play();
            if (playAttempt && typeof playAttempt.catch === "function") {
              playAttempt.catch(() => {});
            }
          }
        } catch (_) {}

        setTimeout(() => {
          if (!ready) {
            previewEl.removeAttribute("src");
            previewEl.load();
          }
        }, 1500);
      };

      if ("IntersectionObserver" in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              observer.disconnect();
              prime();
            }
          });
        }, { rootMargin: "200px" });
        observer.observe(card);
      } else {
        prime();
      }

      return true;
    };

    const renderExerciseList = (items) => {
      if (!exerciseList) return;
      exerciseList.innerHTML = "";
      if (!items.length) {
        if (exerciseEmpty) {
          const query = listSearch?.value.trim();
          exerciseEmpty.textContent = query ? "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." : "–ü–æ–∫–∞ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.";
          exerciseEmpty.hidden = false;
        }
        return;
      }
      if (exerciseEmpty) exerciseEmpty.hidden = true;
      items.forEach((exercise, i) => {
        const card = document.createElement("button");
        card.type = "button";
        card.className = "exercise-card";
        const letter = (exercise.title || "–£").slice(0, 1);
        const hasVideo = Boolean(exercise.videoUrl);
        const previewUrl = exercise.videoUrl && !isYandexPublicLink(exercise.videoUrl) ? exercise.videoUrl : "";
        card.innerHTML = `
          <div class="thumb">
            <div class="thumb-placeholder">${letter}</div>
            <video class="thumb-video" muted playsinline preload="metadata"></video>
            <div class="thumb-overlay"><span class="play-icon">&#9654;</span></div>
            <span class="thumb-chip">${hasVideo ? "–í–∏–¥–µ–æ" : "–ë–µ–∑ –≤–∏–¥–µ–æ"}</span>
          </div>
          <div class="card-body">
            <h3>${exercise.title || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"}</h3>
            <div class="card-hint">–û—Ç–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</div>
          </div>
        `;
        const previewEl = card.querySelector(".thumb-video");
        if (previewEl && previewUrl) {
          setupPreview(previewEl, card, previewUrl);
        } else if (previewEl) {
          previewEl.remove();
        }
        card.addEventListener("click", () => openVideo(exercise));
        exerciseList.appendChild(card);
        setTimeout(() => {
          card.style.opacity = 1;
          card.style.transform = "translateY(0)";
        }, 90 * i);
      });
    };

    const normalizeSearch = (value) => String(value || "").toLowerCase().trim();

    const getFilteredExercises = () => {
      const query = normalizeSearch(listSearch?.value);
      if (!query) return exerciseLibrary;
      return exerciseLibrary.filter((exercise) => {
        const haystack = `${exercise.title || ""} ${exercise.description || ""} ${exercise.details || ""}`.toLowerCase();
        return haystack.includes(query);
      });
    };

    const refreshExerciseList = () => {
      renderExerciseList(getFilteredExercises());
    };

    if (listSearch) {
      listSearch.addEventListener("input", () => {
        refreshExerciseList();
      });
    }

    const loadExercises = async () => {
      if (!apiBase) return;
      try {
        const query = new URLSearchParams({ type: "gym" });
        if (isGuestMode) query.set("guest", "1");
        const res = await fetch(`${apiBase}/api/exercises?${query.toString()}`);
        const json = await res.json().catch(() => ({}));
        if (!json?.ok || !Array.isArray(json.exercises)) return;
        exerciseLibrary = json.exercises;
        refreshExerciseList();
        if (lastGroup) {
          renderInfoList(lastGroup);
        }
      } catch (err) {
        console.warn("exercises load failed", err);
      }
    };

    const isYandexPublicLink = (url) => {
      try {
        const host = new URL(url).hostname;
        return host === "disk.yandex.ru" || host === "yadi.sk" || host.endsWith(".yandex.ru");
      } catch (_) {
        return false;
      }
    };

    const resolveVideoUrl = async (url) => {
      if (!url) return null;
      if (!isYandexPublicLink(url)) return url;
      try {
        const res = await fetch(`${apiBase}/api/yadisk/resolve?publicUrl=${encodeURIComponent(url)}`);
        const json = await res.json().catch(() => ({}));
        if (json?.ok && json.href) return json.href;
      } catch (err) {
        console.warn("Yandex resolve failed:", err);
      }
      return null;
    };

        const showVideoLink = (href, message) => {
      if (!videoNote) return;
      videoNote.innerHTML = "";
      if (message) {
        const text = document.createElement("span");
        text.textContent = message;
        videoNote.appendChild(text);
        videoNote.appendChild(document.createElement("br"));
      }
      const link = document.createElement("a");
      link.href = href;
      link.target = "_blank";
      link.rel = "noopener";
      link.className = "video-link";
      link.textContent = "–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ";
      videoNote.appendChild(link);
    };

    const escapeHtml = (value) => (
      String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
    );

    const formatText = (value) => escapeHtml(value).replace(/\n/g, "<br>");

    const splitDescription = (raw) => {
      const text = String(raw || "").replace(/\r\n/g, "\n").trim();
      if (!text) return { how: "", tip: "" };
      const tipRegex = /(?:^|\n)\s*–°–æ–≤–µ—Ç\s*:/i;
      const tipMatch = text.match(tipRegex);
      let how = text;
      let tip = "";
      if (tipMatch && typeof tipMatch.index === "number") {
        how = text.slice(0, tipMatch.index);
        tip = text.slice(tipMatch.index).replace(tipRegex, "");
      }
      how = how.replace(/–ö–∞–∫\s+–≤—ã–ø–æ–ª–Ω—è—Ç—å\s*:/i, "").trim();
      tip = tip.replace(/–°–æ–≤–µ—Ç\s*:/i, "").trim();
      if (!how && !tip) {
        how = text;
      }
      return { how, tip };
    };

    const buildDescriptionHtml = (raw) => {
      const sections = splitDescription(raw);
      const howText = sections.how || raw || "-";
      const tipText = sections.tip || "-";
      return `
        <div class="desc-block">
          <strong>–ö–∞–∫ –≤—ã–ø–æ–ª–Ω—è—Ç—å:</strong>
          <div>${formatText(howText)}</div>
        </div>
        <div class="desc-block">
          <strong>–°–æ–≤–µ—Ç:</strong>
          <div>${formatText(tipText)}</div>
        </div>
      `;
    };

        const openVideo = async (exercise) => {
      if (!videoModal) return;
      if (isGuestMode && exercise && exercise.guestAccess === false) {
        showAlert("\u0423\u043f\u0440\u0430\u0436\u043d\u0435\u043d\u0438\u0435 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e \u0432 \u0433\u043e\u0441\u0442\u0435\u0432\u043e\u043c \u0434\u043e\u0441\u0442\u0443\u043f\u0435.");
        return;
      }
      currentVideoRequest += 1;
      const requestId = currentVideoRequest;
      const guestLocked = isGuestMode && (exercise?.guestAccess ?? true);
      currentVideoLocked = guestLocked;
      const guestLockMessage = "\u0412\u0438\u0434\u0435\u043e \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u043e\u0441\u043b\u0435 \u043f\u043e\u043a\u0443\u043f\u043a\u0438 \u0442\u0430\u0440\u0438\u0444\u0430.";
      if (videoTitle) videoTitle.textContent = exercise?.title || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ";
      if (videoDesc) {
        videoDesc.innerHTML = buildDescriptionHtml(exercise?.description || "");
      }
      videoModal.classList.toggle("guest-locked", guestLocked);
      if (videoEl) {
        videoEl.pause();
        videoEl.removeAttribute("src");
        videoEl.style.display = "none";
        videoEl.onplay = null;
      }
      if (videoNote) {
        videoNote.style.display = "block";
        if (guestLocked && exercise?.videoUrl) {
          videoNote.textContent = guestLockMessage;
        } else {
          videoNote.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ...";
        }
      }

      videoModal.classList.add("show");
      videoModal.setAttribute("aria-hidden", "false");

      if (!exercise?.videoUrl) {
        currentVideoUrl = "";
        if (videoNote) videoNote.textContent = "–í–∏–¥–µ–æ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.";
        return;
      }

      currentVideoUrl = exercise.videoUrl || "";
      const resolvedUrl = await resolveVideoUrl(exercise.videoUrl);
      if (requestId !== currentVideoRequest) return;
      currentVideoUrl = resolvedUrl || exercise.videoUrl || "";

      if (resolvedUrl && videoEl) {
        videoEl.src = resolvedUrl;
        videoEl.style.display = "block";
        if (guestLocked) {
          videoEl.onplay = () => {
            videoEl.pause();
            showAlert(guestLockMessage);
            if (videoNote) {
              videoNote.style.display = "block";
              videoNote.textContent = guestLockMessage;
            }
          };
        } else {
          videoEl.onerror = () => {
            if (requestId !== currentVideoRequest) return;
            showVideoLink(resolvedUrl, "–í–∏–¥–µ–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.");
          };
        }

        videoEl.onloadeddata = () => {
          if (requestId !== currentVideoRequest) return;
          if (!guestLocked && videoNote) {
            videoNote.style.display = "block";
            videoNote.textContent = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–¥–µ–æ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å.";
          }
        };
        videoEl.onplaying = () => {
          if (requestId !== currentVideoRequest) return;
          if (!guestLocked && videoNote) videoNote.style.display = "none";
        };
        videoEl.load();
        if (!guestLocked) {
          const playAttempt = videoEl.play();
          if (playAttempt && typeof playAttempt.catch === "function") {
            playAttempt.catch(() => {
              if (requestId !== currentVideoRequest) return;
              showVideoLink(resolvedUrl, "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–¥–µ–æ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ.");
            });
          }
        }
      } else {
        if (guestLocked) {
          if (videoNote) videoNote.textContent = guestLockMessage;
        } else {
          showVideoLink(exercise.videoUrl, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ.");
        }
      }
    };

    if (info) {
      info.addEventListener("click", (event) => {
        const button = event.target.closest(".muscle-item");
        if (!button) return;
        const exId = button.dataset.exId;
        let exercise = null;
        if (exId) {
          exercise = exerciseLibrary.find((item) => String(item.id) === exId);
        }
        if (!exercise && button.dataset.exIndex) {
          const idx = Number(button.dataset.exIndex);
          if (!Number.isNaN(idx)) {
            exercise = exerciseLibrary[idx];
          }
        }
        if (exercise) openVideo(exercise);
      });
    }

    const closeVideoModal = () => {
      if (!videoModal) return;
      currentVideoRequest += 1;
      currentVideoUrl = "";
      currentVideoLocked = false;
      videoModal.classList.remove("show");
      videoModal.classList.remove("guest-locked");
      videoModal.setAttribute("aria-hidden", "true");
      if (videoEl) {
        videoEl.pause();
        videoEl.removeAttribute("src");
        videoEl.onplay = null;
      }
    };

    const openExternalVideo = () => {
      if (!currentVideoUrl) {
        showAlert("–í–∏–¥–µ–æ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.");
        return;
      }
      if (currentVideoLocked) {
        showAlert("–í–∏–¥–µ–æ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Ç–∞—Ä–∏—Ñ–∞.");
        return;
      }
      if (tg?.openLink) {
        tg.openLink(currentVideoUrl);
      } else {
        window.open(currentVideoUrl, "_blank");
      }
    };

    if (openVideoBtn) openVideoBtn.addEventListener("click", openExternalVideo);
    if (closeVideo) closeVideo.addEventListener("click", closeVideoModal);
    if (videoModal) {
      videoModal.addEventListener("click", (e) => {
        if (e.target === videoModal) closeVideoModal();
      });
    }

    const setViewMode = (mode) => {
      const safeMode = isGuestMode && mode !== "list" ? "list" : mode;
      const isList = safeMode === "list";
      if (mapView) {
        mapView.hidden = isList;
        mapView.classList.toggle("is-hidden", isList);
        mapView.setAttribute("aria-hidden", isList ? "true" : "false");
      }
      if (listView) {
        listView.hidden = !isList;
        listView.classList.toggle("is-hidden", !isList);
        listView.setAttribute("aria-hidden", isList ? "false" : "true");
      }
      viewButtons.forEach((btn) => {
        const active = btn.dataset.view === safeMode;
        btn.classList.toggle("is-active", active);
        btn.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.body.classList.toggle("map-mode", !isList);
      localStorage.setItem("exercise_view", safeMode);
    };

    viewButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.view;
        if (isGuestMode && mode !== "list") return;
        setViewMode(mode);
      });
    });

    const initPage = async () => {
      const allowed = await enforceBaseAccess();
      if (!allowed) return;
      document.body.classList.toggle("guest-mode", isGuestMode);
      if (viewToggle) viewToggle.hidden = isGuestMode;
      applyDebugVisibility();
      const savedView = localStorage.getItem("exercise_view") || "map";
      if (isGuestMode) {
        setViewMode("list");
      } else {
        setViewMode(savedView);
      }
      loadExercises();
    };

    initPage();
  </script>
</body>
</html>


