(function () {
  const tg = window.Telegram?.WebApp || null;
  const qs = new URLSearchParams(location.search);
  const API_BASE = window.ENV?.API_BASE || "";

  const greetingEl  = document.getElementById('greeting');
  const tariffEl    = document.getElementById('tariff');
  const themeToggleBtn = document.getElementById("themeToggle");
  const USE_TG_THEME = false; // ‚Üê –∑–∞–ø—Ä–µ—â–∞–µ–º –ª—é–±—ã–µ —Ü–≤–µ—Ç–∞ –∏–∑ Telegram

  // üîπ –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
  const profileBtn = document.getElementById("profileBtn");
  const profileModal = document.getElementById("profileModal");
  const closeProfile = document.getElementById("closeProfile");
  const profileNameEl = document.getElementById("profileName");
  const profileUsernameEl = document.getElementById("profileUsername");
  const profileIdEl = document.getElementById("profileId");
  const profileTariffEl = document.getElementById("profileTariff");
  const profilePhotoEl = document.getElementById("profilePhoto");

  // -------------------------------
  // –§–æ—Ä–º–∏—Ä—É–µ–º initData –¥–ª—è API
  // -------------------------------
  function buildInitData() {
    const raw = tg?.initData || '';
    if (raw && raw.length > 0) return raw;

    const u = tg?.initDataUnsafe || null;
    if (!u || !u.hash) return '';

    const p = new URLSearchParams();
    if (u.query_id)      p.set('query_id', u.query_id);
    if (u.user)          p.set('user', JSON.stringify(u.user));
    if (u.auth_date)     p.set('auth_date', String(u.auth_date));
    if (u.start_param)   p.set('start_param', u.start_param);
    if (u.chat_type)     p.set('chat_type', u.chat_type);
    if (u.chat_instance) p.set('chat_instance', u.chat_instance);
    p.set('hash', u.hash);

    return p.toString();
  }

  // -------------------------------
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —é–∑–µ—Ä–∞ –∏ —Ä–µ–Ω–¥–µ—Ä
  // -------------------------------
  async function fetchUserAndRender(initData) {
    try {
      const url = `${API_BASE}/api/user?initData=${encodeURIComponent(initData)}`;
      console.log("[api/user] ‚ûú", url);

      const res = await fetch(url);
      const json = await res.json().catch(() => ({}));

      console.log("[api/user] ‚¨Ö", json);

      if (!json?.ok) {
        console.warn("[api/user] ‚ö† –ù–µ—É–¥–∞—á–∞", json);
        return;
      }

      const name = json.profile?.fio || json.profile?.first_name || json.user?.first_name || "–¥—Ä—É–≥";
      const username = json.user?.username ? `@${json.user.username}` : "–Ω–µ —É–∫–∞–∑–∞–Ω";
      const id = json.user?.id || "-";
      const tariff = json.profile?.tariffName || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      const photoUrl = json.user?.photo_url || "";

      // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
      greetingEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${name}!`;
      tariffEl.textContent = `–¢–∞—Ä–∏—Ñ: ${tariff}`;
      renderTilesByTariff(tariff);

      // –ø—Ä–æ—Ñ–∏–ª—å –≤ –º–æ–¥–∞–ª–∫–µ
      profileNameEl.textContent = name;
      profileUsernameEl.textContent = username;
      profileIdEl.textContent = id;
      profileTariffEl.textContent = tariff;
      if (profilePhotoEl) {
        profilePhotoEl.src = photoUrl || "default-avatar.png";
      }

    } catch (e) {
      console.error("[api/user] ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞", e);
      tariffEl.textContent = "–¢–∞—Ä–∏—Ñ: –æ—à–∏–±–∫–∞";
    }
  }

  // -------------------------------
  // –ü–ª–∏—Ç–∫–∏ –ø–æ —Ç–∞—Ä–∏—Ñ—É
  // -------------------------------
  function renderTilesByTariff(tariff) {
    const tiles = document.getElementById("tiles");
    if (!tiles) return;

    tiles.innerHTML = "";
    let actions = [];

    if (tariff === "–ë–∞–∑–æ–≤—ã–π") {
      actions = ["–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏", "–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è", "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"];
    } else if (tariff === "–í—ã–≥–æ–¥–Ω—ã–π" || tariff === "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π") {
      actions = ["–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏", "–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è", "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è", "–°–≤—è–∑—å —Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º"];
    } else {
      actions = ["–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏", "–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è", "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"];
    }

    actions.forEach(label => {
  const tile = document.createElement("button");
  tile.className = "tile";
  tile.dataset.action = label;
  tile.innerHTML = `
    <div class="title">${label}</div>
    <div class="desc">${label === "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" ? "–í—ã–±–æ—Ä –º—ã—à—Ü –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π" : "–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"}</div>
  `;

  tile.addEventListener("click", () => {
    if (label === "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è") {
      window.location.href = "exercises.html"; // üîπ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    } else {
      showAlert(`¬´${label}¬ª ‚Äî —Ä–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`);
    }
  });

  tiles.appendChild(tile);
});

  }

  // -------------------------------
  // –°—Ç–∏–ª–∏ Telegram —Ç–µ–º—ã
  // -------------------------------
  // –°—Ç–∏–ª–∏ Telegram —Ç–µ–º—ã ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω—ã
  const setCSSFromTheme = (p = {}) => {
    if (!USE_TG_THEME) return; // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    // –ï—Å–ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∑–∞—Ö–æ—á–µ—à—å ‚Äî —É–±–µ—Ä–∏ return –∏ —Ä–∞—Å–∫–æ–º–º–∏—Ç—å –∫–æ–¥ –Ω–∏–∂–µ
    /*
    const r = document.documentElement;
    if (p.bg_color)            r.style.setProperty('--bg', p.bg_color);
    if (p.text_color)          r.style.setProperty('--text', p.text_color);
    if (p.secondary_bg_color)  r.style.setProperty('--card', p.secondary_bg_color);
    if (p.section_bg_color)    r.style.setProperty('--card-border', p.section_bg_color);
    // –ø–æ–¥ —Å–≤–æ–π –∞–∫—Ü–µ–Ω—Ç ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é:
    // if (p.link_color)       r.style.setProperty('--accent', p.link_color);
    */
  };


  const showAlert = (msg) => (tg?.showAlert ? tg.showAlert(msg) : alert(msg));
  const waitReady = () => { try { tg?.ready?.(); } catch (_) {} };

  // -------------------------------
  // –¢–µ–º–∞ üåô / ‚òÄÔ∏è
  // -------------------------------
  let isDark = true;

  function applyTheme() {
    clearInlineVars();
    if (isDark) {
      document.documentElement.classList.remove("light");
      themeToggleBtn.textContent = "üåô";
      localStorage.setItem("theme", "dark");
    } else {
      document.documentElement.classList.add("light");
      themeToggleBtn.textContent = "‚òÄÔ∏è";
      localStorage.setItem("theme", "light");
    }
  }

  function clearInlineVars() {
    const r = document.documentElement;
    ['--bg','--text','--card','--card-border','--accent'].forEach(k => r.style.removeProperty(k));
  }

  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    isDark = savedTheme === "dark";
  }
  // –Ω–∏–∫–∞–∫–∏—Ö —Ü–≤–µ—Ç–æ–≤ –∏–∑ Telegram
  applyTheme();


  if (themeToggleBtn) {
    themeToggleBtn.addEventListener("click", () => {
      isDark = !isDark;
      applyTheme();
    });
  }

  // -------------------------------
  // –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  // -------------------------------
  if (profileBtn) {
    profileBtn.addEventListener("click", () => profileModal.classList.remove("hidden"));
  }
  if (closeProfile) {
    closeProfile.addEventListener("click", () => profileModal.classList.add("hidden"));
  }
  window.addEventListener("click", (e) => {
    if (e.target === profileModal) profileModal.classList.add("hidden");
  });

  // -------------------------------
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  // -------------------------------
  async function init() {
    try {
      console.log(">>> INIT: –∑–∞–ø—É—Å–∫ WebApp");
      if (tg) {
        waitReady();
        tg.expand?.();
        
        const u = tg.initDataUnsafe?.user;
        if (u?.first_name) greetingEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${u.first_name}!`;
      }

      const qpTariff = qs.get('tariff');
      if (qpTariff) tariffEl.textContent = `–¢–∞—Ä–∏—Ñ: ${qpTariff}`;

      if (API_BASE && tg) {
        const initData = buildInitData();
        await fetch(`${API_BASE}/api/validate?initData=${encodeURIComponent(initData)}`).catch(() => ({}));
        await fetchUserAndRender(initData);
      }
    } catch (e) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏", e);
      showAlert("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");
    }
  }

  window.API_BASE = API_BASE;
  window.tg = tg;
  window.buildInitData = buildInitData;

  init();
})();
