<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fit Dew - Создание программы</title>

  <script>
    (function() {
      const savedTheme = localStorage.getItem("theme") || "dark";
      document.documentElement.classList.toggle("light", savedTheme === "light");
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@600;700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="env.js?v=20260115"></script>

  <style>
    :root {
      --bg: #0f0f10;
      --bg-soft: #141417;
      --text: #f4f1e8;
      --muted: #c6c0b2;
      --card: #1b1b1f;
      --card-border: rgba(255, 255, 255, 0.08);
      --accent: #f6e5a6;
      --accent-strong: #f2d17c;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      --radius: 18px;
      --radius-lg: 26px;
      --font-title: "Exo 2", sans-serif;
      --font-body: "Manrope", sans-serif;
      --transition: 0.3s ease;
    }

    html.light {
      --bg: #f4f1e6;
      --bg-soft: #ffffff;
      --text: #1b1b1b;
      --muted: #6f6a60;
      --card: #ffffff;
      --card-border: rgba(0, 0, 0, 0.08);
      --accent: #e8cc7a;
      --accent-strong: #ddb965;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }

    html {
      color-scheme: dark;
    }

    html.light {
      color-scheme: light;
    }

    select option {
      background: #1b1b1f;
      color: #f4f1e8;
    }

    html.light select option {
      background: #ffffff;
      color: #1b1b1b;
    }

    * {
      box-sizing: border-box;
    }

    [hidden] {
      display: none !important;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      transition: background-color var(--transition), color var(--transition);
    }

    body::before {
      content: "";
      position: fixed;
      inset: -20%;
      background:
        radial-gradient(520px 280px at 15% 8%, rgba(243, 213, 139, 0.16), transparent 60%),
        radial-gradient(440px 320px at 90% 20%, rgba(154, 215, 202, 0.12), transparent 65%),
        radial-gradient(420px 300px at 40% 90%, rgba(243, 213, 139, 0.08), transparent 70%);
      z-index: -2;
    }

    .admin-screen {
      max-width: 860px;
      margin: 0 auto;
      padding: 22px 18px 140px;
    }

    .page-header {
      display: grid;
      gap: 12px;
      padding: 18px;
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, #1f1f22, #121214);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    html.light .page-header {
      background: #ffffff;
    }

    .page-header::after {
      content: "";
      position: absolute;
      inset: -80px;
      background: radial-gradient(circle at 20% 120%, rgba(243, 213, 139, 0.35), transparent 70%);
      opacity: 0.8;
      z-index: 0;
    }

    .page-header > * {
      position: relative;
      z-index: 1;
    }

    .header-top {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .eyebrow {
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .page-title {
      margin: 0;
      font-family: var(--font-title);
      font-size: clamp(1.6rem, 6vw, 2.4rem);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .page-subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.06);
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .status-pill::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9c9c9c;
    }

    .status-pill.ok {
      color: #1b1b1b;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
    }

    .status-pill.ok::before {
      background: #1b1b1b;
    }

    .status-pill.bad {
      color: #ffb0b0;
      border-color: rgba(255, 120, 120, 0.4);
      background: rgba(120, 20, 20, 0.3);
    }

    .status-pill.bad::before {
      background: #ff8a8a;
    }


    .section-card {
      margin-top: 18px;
      padding: 18px;
      border-radius: var(--radius-lg);
      background: var(--card);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      display: grid;
      gap: 14px;
    }

    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .section-head.compact {
      align-items: flex-start;
    }

    .section-eyebrow {
      font-size: 0.65rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .section-title {
      margin: 4px 0 0;
      font-family: var(--font-title);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .section-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--muted);
      line-height: 1.5;
      margin: 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    .form-grid label {
      display: grid;
      gap: 8px;
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .inline-group {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 140px;
      gap: 10px;
    }

    .help-text {
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: none;
      color: var(--muted);
    }

    .form-grid label.full {
      grid-column: 1 / -1;
    }

    input,
    textarea,
    select {
      width: 100%;
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 0.95rem;
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        right 18px center,
        right 12px center;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 42px;
    }

    html.light select {
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        right 18px center,
        right 12px center;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    select option {
      background: #1b1b1f;
      color: var(--text);
    }
    html.light select option {
      background: #ffffff;
      color: #1b1b1b;
    }

    html.light input,
    html.light textarea,
    html.light select {
      background: rgba(0, 0, 0, 0.03);
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: rgba(242, 209, 124, 0.6);
      box-shadow: 0 0 0 3px rgba(242, 209, 124, 0.15);
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .slug-field {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .slug-field input {
      flex: 1;
    }

    .type-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding: 10px 0;
    }

    .field-label {
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .pill-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      position: relative;
      cursor: pointer;
    }

    .pill input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .pill span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 18px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-family: var(--font-title);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 0.75rem;
      transition: var(--transition);
    }

    .pill input:checked + span {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1b1b;
      border-color: transparent;
    }

    .note-box {
      padding: 14px;
      border-radius: 16px;
      border: 1px dashed var(--card-border);
      background: rgba(255, 255, 255, 0.03);
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .section-divider {
      height: 1px;
      background: var(--card-border);
      border-radius: 999px;
    }

    .stack {
      display: grid;
      gap: 14px;
    }

    .repeat-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .repeat-row label {
      display: grid;
      gap: 8px;
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      flex: 1;
      min-width: 180px;
    }

    .repeat-row select {
      width: 100%;
    }

    .week-card {
      padding: 16px;
      border-radius: 20px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.18);
      display: grid;
      gap: 12px;
    }

    html.light .week-card {
      background: rgba(0, 0, 0, 0.03);
    }

    .workout-card {
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.22);
      display: grid;
      gap: 12px;
    }

    html.light .workout-card {
      background: rgba(0, 0, 0, 0.04);
    }

    .exercise-card {
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.15);
      display: grid;
      gap: 10px;
    }

    html.light .exercise-card {
      background: rgba(0, 0, 0, 0.03);
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .exercise-list {
      display: grid;
      gap: 12px;
    }

    .btn-primary,
    .btn-outline,
    .btn-ghost {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      cursor: pointer;
      font-family: var(--font-title);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 0.75rem;
      transition: var(--transition);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1b1b;
      box-shadow: 0 12px 26px rgba(243, 213, 139, 0.3);
    }

    .btn-primary:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--card-border);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
      padding: 8px 14px;
    }

    .btn-ghost.btn-file {
      border: 1px solid var(--card-border);
      color: var(--text);
    }

    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .nav-actions {
      justify-content: flex-start;
    }

    .status-line {
      min-height: 20px;
      font-size: 0.9rem;
    }

    .status-line.ok {
      color: #7ee0a8;
    }

    .status-line.bad {
      color: #ff9b9b;
    }

    .program-list {
      display: grid;
      gap: 12px;
    }

    .program-item {
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    html.light .program-item {
      background: rgba(0, 0, 0, 0.03);
    }

    .program-meta {
      display: grid;
      gap: 4px;
    }

    .program-meta strong {
      font-size: 1rem;
    }

    .program-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .program-tag {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .plan-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      align-items: end;
    }

    .plan-grid button {
      height: 44px;
    }

    .exercise-item {
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    html.light .exercise-item {
      background: rgba(0, 0, 0, 0.03);
    }

    .exercise-meta {
      display: grid;
      gap: 4px;
      max-width: 70%;
    }

    .exercise-meta strong {
      font-size: 1rem;
    }

    .exercise-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .wizard-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    .wizard-step {
      border: 1px solid var(--card-border);
      border-radius: 999px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--muted);
      font-size: 0.7rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), border-color var(--transition), transform var(--transition);
    }

    .wizard-step .wizard-index {
      font-family: var(--font-title);
      font-size: 0.8rem;
      letter-spacing: 0.2em;
      color: inherit;
    }

    .wizard-step .wizard-label {
      color: inherit;
    }

    .wizard-step.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #1b1b1b;
      transform: translateY(-1px);
    }

    .wizard-panel {
      display: none;
      gap: 16px;
    }

    .wizard-panel.active {
      display: grid;
      animation: panelFade 0.3s ease;
    }

    .wizard-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }

    .wizard-spacer {
      flex: 1;
    }

    @keyframes panelFade {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .plan-grid {
        grid-template-columns: 1fr;
      }

      .inline-group {
        grid-template-columns: 1fr;
      }

      .section-head {
        flex-direction: column;
        align-items: flex-start;
      }

      .actions {
        justify-content: flex-start;
      }

      .wizard-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .wizard-spacer {
        display: none;
      }
    }
  </style>
</head>


<body>
  <div class="admin-screen">
    <header class="page-header">
      <div class="header-top">
        <span class="eyebrow">Админка</span>
      </div>
      <h1 class="page-title">Создание программы</h1>
      <p class="page-subtitle">Собирай план по неделям и тренировкам. Видео - публичная ссылка на видео.</p>
    </header>

    <section class="section-card">
      <div class="actions nav-actions">
        <button class="btn-outline" id="goHome" type="button">Назад</button>
        <button class="btn-outline" id="goExercises" type="button">Упражнения</button>
        <button class="btn-outline" id="goClients" type="button">Клиенты</button>
      </div>
    </section>

    <section class="section-card" id="formCard" hidden>
      <div class="section-head">
        <div>
          <span class="section-eyebrow" id="formModeLabel">Новая программа</span>
          <h2 class="section-title" id="formTitle">Создание программы</h2>
        </div>
        <div class="section-actions">
          <button class="btn-outline" id="resetForm" type="button">Очистить</button>
        </div>
      </div>

      <div class="wizard-steps" role="tablist" aria-label="Шаги создания программы">
        <button class="wizard-step active" data-step="1" type="button" aria-selected="true">
          <span class="wizard-index">01</span>
          <span class="wizard-label">Параметры</span>
        </button>
        <button class="wizard-step" data-step="2" type="button" aria-selected="false">
          <span class="wizard-index">02</span>
          <span class="wizard-label">Структура</span>
        </button>
        <button class="wizard-step" data-step="3" type="button" aria-selected="false">
          <span class="wizard-index">03</span>
          <span class="wizard-label">Наполнение</span>
        </button>
      </div>

      <div class="wizard-panel active" data-step-panel="1">
        <div class="type-row">
          <span class="field-label">Тип программы</span>
          <div class="pill-group">
            <label class="pill">
              <input type="radio" name="programType" value="gym" checked>
              <span>Зал</span>
            </label>
            <label class="pill">
              <input type="radio" name="programType" value="crossfit">
              <span>Кроссфит</span>
            </label>
          </div>
        </div>

        <div class="type-row">
          <span class="field-label">Доступ по тарифам</span>
          <div class="pill-group">
            <label class="pill">
              <input type="checkbox" name="programTariff" value="Базовый" checked>
              <span>Базовый</span>
            </label>
            <label class="pill">
              <input type="checkbox" name="programTariff" value="Оптимальный" checked>
              <span>Оптимальный</span>
            </label>
            <label class="pill">
              <input type="checkbox" name="programTariff" value="Максимум" checked>
              <span>Максимум</span>
            </label>
          </div>
        </div>

        <div class="type-row">
          <span class="field-label">Доступ в гостевом</span>
          <div class="pill-group">
            <label class="pill">
              <input type="checkbox" id="programGuestAccess">
              <span>Гостевой доступ</span>
            </label>
          </div>
        </div>

        <div class="form-grid">
          <label>
            Название программы
            <input id="programTitle" type="text" placeholder="Например: Программа на все тело">
          </label>
          <label>
            Слаг (URL)
            <div class="slug-field">
              <input id="programSlug" type="text" placeholder="crossfit-busy-fullbody">
              <button class="btn-ghost" id="slugAuto" type="button">Авто</button>
            </div>
          </label>
          <label>
            Подзаголовок
            <input id="programSubtitle" type="text" placeholder="Для самых занятых">
          </label>
          <label>
            Краткое описание
            <input id="programSummary" type="text" placeholder="3 тренировки в неделю, весь функционал">
          </label>
          <label class="full">
            Полное описание
            <textarea id="programDescription" placeholder="Опишите программу подробнее..."></textarea>
          </label>
          <label>
            Уровень
            <input id="programLevel" type="text" placeholder="Новички">
          </label>
          <label>
            Пол
            <input id="programGender" type="text" placeholder="Универсальная">
          </label>
          <label>
            Частота
            <div class="inline-group">
              <input id="programFrequencyValue" type="number" min="1" placeholder="3">
              <select id="programFrequencyUnit">
                <option value="трен/нед">трен/нед</option>
                <option value="трен/мес">трен/мес</option>
                <option value="трен/год">трен/год</option>
              </select>
            </div>
          </label>
          <label>
            Недель (авто)
            <input id="programWeeksCount" type="number" min="1" readonly placeholder="Авто">
            <span class="help-text">Берется из плана ниже.</span>
          </label>
          <label>
            Обложка (ключ/URL или файл)
            <div class="inline-group">
              <input id="programCover" type="text" placeholder="https://...">
              <button class="btn-ghost btn-file" id="programCoverUpload" type="button">Файл</button>
            </div>
            <input id="programCoverFile" type="file" accept="image/*" hidden>
            <span class="help-text">Необязательно. До 50 МБ.</span>
          </label>
          <label class="full">
            Куратор (из базы)
            <select id="trainerSelect">
              <option value="">Не выбран</option>
            </select>
          </label>
          <label>
            Автор
            <input id="programAuthorName" type="text" value="Тестов Тест Тестович">
          </label>
          <label>
            Роль автора
            <input id="programAuthorRole" type="text" value="Куратор Fit Dew">
          </label>
          <label class="full">
            Avatar URL (опционально)
            <input id="programAuthorAvatar" type="text" placeholder="https://...">
          </label>
        </div>

        <div class="note-box">
          <strong>Видео</strong>
          <span>Можно прикрепить файл или вставить ссылку на видео в упражнении.</span>
        </div>
      </div>

      <div class="wizard-panel" data-step-panel="2">
        <div class="section-head compact">
          <div>
            <span class="section-eyebrow">Структура</span>
            <h3 class="section-title">Недели и тренировки</h3>
          </div>
        </div>

        <div class="plan-grid">
          <label>
            Недель
            <input id="planWeeks" type="number" min="1" value="4">
          </label>
          <label>
            Тренировок в неделе
            <input id="planWorkouts" type="number" min="1" value="2">
          </label>
          <button class="btn-outline" id="generatePlan" type="button">Сгенерировать план</button>
        </div>

        <div class="note-box">
          <strong>Совет</strong>
          <span>Сначала задай базовую сетку или добавляй недели вручную. Затем переходи к шагу 3 и заполняй упражнения.</span>
        </div>
      </div>

      <div class="wizard-panel" data-step-panel="3">
        <div class="section-head compact">
          <div>
            <span class="section-eyebrow">Наполнение</span>
            <h3 class="section-title">Недели, тренировки, упражнения</h3>
          </div>
          <div class="section-actions">
            <button class="btn-outline" data-action="add-week" type="button">+ Неделя</button>
          </div>
        </div>

        <div id="weeksContainer" class="stack"></div>

        <div class="actions">
          <button class="btn-outline" id="deleteProgram" type="button" hidden>Удалить программу</button>
          <button class="btn-primary" id="saveProgram" type="button">Сохранить программу</button>
        </div>
      </div>

      <div class="wizard-actions">
        <button class="btn-ghost" id="wizardPrev" type="button">Назад</button>
        <div class="wizard-spacer"></div>
        <button class="btn-outline" id="wizardNext" type="button">К структуре</button>
      </div>
      <div class="status-line" id="formStatus"></div>
    </section>

    <section class="section-card" id="listCard" hidden>
      <div class="section-head compact">
        <div>
          <span class="section-eyebrow">Каталог</span>
          <h2 class="section-title">Существующие программы</h2>
        </div>
        <div class="section-actions">
          <button class="btn-outline" id="reloadPrograms" type="button">Обновить</button>
        </div>
      </div>
      <div class="program-list" id="programList"></div>
    </section>

  </div>

  <script>

    (function() {
      const tg = window.Telegram?.WebApp || null;
      const params = new URLSearchParams(window.location.search);
      const API_BASE = window.ENV?.API_BASE || "";
      const apiBase = API_BASE ? API_BASE.replace(/\/$/, "") : "";
      const buildInitData = () => {
        const raw = tg?.initData || "";
        if (raw && raw.length > 0) return raw;

        const u = tg?.initDataUnsafe || null;
        if (!u || !u.hash) return "";

        const p = new URLSearchParams();
        if (u.query_id) p.set("query_id", u.query_id);
        if (u.user) p.set("user", JSON.stringify(u.user));
        if (u.auth_date) p.set("auth_date", String(u.auth_date));
        if (u.start_param) p.set("start_param", u.start_param);
        if (u.chat_type) p.set("chat_type", u.chat_type);
        if (u.chat_instance) p.set("chat_instance", u.chat_instance);
        p.set("hash", u.hash);

        return p.toString();
      };

      const initData = tg?.initData || params.get("initData") || buildInitData() || "";

      const accessStatus = document.getElementById("accessStatus");
      const accessMessage = document.getElementById("accessMessage");
      const formCard = document.getElementById("formCard");
      const listCard = document.getElementById("listCard");
      const weeksContainer = document.getElementById("weeksContainer");
      const formStatus = document.getElementById("formStatus");
      const formModeLabel = document.getElementById("formModeLabel");
      const formTitle = document.getElementById("formTitle");
      const programList = document.getElementById("programList");

      const programTitle = document.getElementById("programTitle");
      const programSlug = document.getElementById("programSlug");
      const programSubtitle = document.getElementById("programSubtitle");
      const programSummary = document.getElementById("programSummary");
      const programDescription = document.getElementById("programDescription");
      const programLevel = document.getElementById("programLevel");
      const programGender = document.getElementById("programGender");
      const programFrequencyValue = document.getElementById("programFrequencyValue");
      const programFrequencyUnit = document.getElementById("programFrequencyUnit");
      const programWeeksCount = document.getElementById("programWeeksCount");
      const programCover = document.getElementById("programCover");
      const programCoverUpload = document.getElementById("programCoverUpload");
      const programCoverFile = document.getElementById("programCoverFile");
      const trainerSelect = document.getElementById("trainerSelect");
      const programAuthorName = document.getElementById("programAuthorName");
      const programAuthorRole = document.getElementById("programAuthorRole");
      const programAuthorAvatar = document.getElementById("programAuthorAvatar");
      const tariffInputs = Array.from(document.querySelectorAll("input[name='programTariff']"));
      const programTypeInputs = Array.from(document.querySelectorAll("input[name='programType']"));
      const programGuestAccess = document.getElementById("programGuestAccess");

      const planWeeks = document.getElementById("planWeeks");
      const planWorkouts = document.getElementById("planWorkouts");
      const generatePlan = document.getElementById("generatePlan");

      const slugAuto = document.getElementById("slugAuto");
      const goHome = document.getElementById("goHome");
      const goExercises = document.getElementById("goExercises");
      const goClients = document.getElementById("goClients");
      const resetForm = document.getElementById("resetForm");
      const saveProgram = document.getElementById("saveProgram");
      const deleteProgram = document.getElementById("deleteProgram");
      const reloadPrograms = document.getElementById("reloadPrograms");
      const wizardSteps = Array.from(document.querySelectorAll("[data-step]"));
      const wizardPanels = Array.from(document.querySelectorAll("[data-step-panel]"));
      const wizardPrev = document.getElementById("wizardPrev");
      const wizardNext = document.getElementById("wizardNext");

      let exerciseLibrary = [];
      let trainerList = [];
      let editingSlug = null;
      let trainerScope = "both";
      let isTrainer = false;
      const maxWizardStep = 3;
      let wizardStep = 1;

      const setStatus = (message, ok) => {
        formStatus.textContent = message;
        formStatus.classList.toggle("ok", Boolean(ok));
        formStatus.classList.toggle("bad", ok === false);
      };

      const uploadAdminMedia = async ({ kind, file }) => {
        if (!apiBase || !initData || !file) {
          setStatus("Нет данных для загрузки.", false);
          return null;
        }
        const size = file.size || 0;
        const fileType = file.type || "";
        if (!fileType) {
          setStatus("Не удалось определить тип файла.", false);
          return null;
        }
        const allowVideo = ["exercise_video", "program_video"].includes(kind);
        const allowImage = kind === "program_cover";
        if (allowVideo && !fileType.startsWith("video/")) {
          setStatus("Можно загрузить только видео.", false);
          return null;
        }
        if (allowImage && !fileType.startsWith("image/")) {
          setStatus("Можно загрузить только изображение.", false);
          return null;
        }
        if (size <= 0 || size > 50 * 1024 * 1024) {
          setStatus("Файл больше 50 МБ.", false);
          return null;
        }
        try {
          setStatus("Загрузка файла...");
          const res = await fetch(`${apiBase}/api/admin/upload-url`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              initData,
              kind,
              fileName: file.name || "file",
              contentType: fileType,
              size
            })
          });
          const json = await res.json().catch(() => ({}));
          if (!json?.ok || !json.uploadUrl) {
            setStatus("Ошибка подготовки загрузки.", false);
            return null;
          }
          const uploadRes = await fetch(json.uploadUrl, {
            method: "PUT",
            headers: { "Content-Type": fileType },
            body: file
          });
          if (!uploadRes.ok) {
            setStatus("Ошибка загрузки файла.", false);
            return null;
          }
          setStatus("Файл загружен.", true);
          return json.publicUrl || null;
        } catch (err) {
          setStatus("Ошибка сети при загрузке.", false);
          return null;
        }
      };

      const setAccess = (ok, message) => {
        if (accessStatus) {
          accessStatus.textContent = ok ? "Доступ открыт" : "Нет доступа";
          accessStatus.classList.toggle("ok", ok);
          accessStatus.classList.toggle("bad", !ok);
        }
        if (accessMessage) {
          accessMessage.textContent = message;
        }
        formCard.hidden = !ok;
        listCard.hidden = !ok;
        if (saveProgram) saveProgram.disabled = !ok;
      };

      const applyTrainerScope = () => {
        if (!programTypeInputs.length) return;
        if (!trainerScope || trainerScope === "both") {
          programTypeInputs.forEach((input) => {
            input.disabled = false;
          });
          refreshExerciseSelects();
          return;
        }
        programTypeInputs.forEach((input) => {
          const allowed = input.value === trainerScope;
          input.disabled = !allowed;
          if (allowed) input.checked = true;
        });
        refreshExerciseSelects();
      };

      const setEditMode = (slug) => {
        editingSlug = slug || null;
        if (formModeLabel) formModeLabel.textContent = editingSlug ? "Редактирование" : "Новая программа";
        if (formTitle) formTitle.textContent = editingSlug ? "Редактирование программы" : "Создание программы";
        if (saveProgram) saveProgram.textContent = editingSlug ? "Обновить программу" : "Сохранить программу";
        if (deleteProgram) deleteProgram.hidden = !editingSlug;
      };

      const setWizardStep = (nextStep) => {
        const step = Math.min(Math.max(nextStep, 1), maxWizardStep);
        wizardStep = step;
        wizardSteps.forEach((btn) => {
          const btnStep = Number(btn.dataset.step);
          const isActive = btnStep === step;
          btn.classList.toggle("active", isActive);
          btn.setAttribute("aria-selected", isActive ? "true" : "false");
        });
        wizardPanels.forEach((panel) => {
          const panelStep = Number(panel.dataset.stepPanel);
          panel.classList.toggle("active", panelStep === step);
        });
        if (wizardPrev) wizardPrev.disabled = step === 1;
        if (wizardNext) {
          wizardNext.disabled = step === maxWizardStep;
          wizardNext.textContent = step === 1 ? "К структуре" : step === 2 ? "К наполнению" : "Готово";
        }
      };

      const scrollToForm = () => {
        if (formCard && typeof formCard.scrollIntoView === "function") {
          formCard.scrollIntoView({ behavior: "smooth", block: "start" });
          return;
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      const getSelectedTariffs = () => (
        tariffInputs
          .filter((input) => input.checked)
          .map((input) => input.value)
      );

      const setSelectedTariffs = (tariffs) => {
        const list = Array.isArray(tariffs) ? tariffs.map((item) => String(item).trim()) : [];
        const picked = new Set(list.filter(Boolean));
        let hasAny = false;
        tariffInputs.forEach((input) => {
          const checked = picked.has(input.value);
          input.checked = checked;
          if (checked) hasAny = true;
        });
        if (!hasAny) {
          tariffInputs.forEach((input) => {
            input.checked = true;
          });
        }
      };

      const translitMap = {
        "а": "a", "б": "b", "в": "v", "г": "g", "д": "d", "е": "e", "ё": "e",
        "ж": "zh", "з": "z", "и": "i", "й": "y", "к": "k", "л": "l", "м": "m",
        "н": "n", "о": "o", "п": "p", "р": "r", "с": "s", "т": "t", "у": "u",
        "ф": "f", "х": "h", "ц": "ts", "ч": "ch", "ш": "sh", "щ": "sch", "ъ": "",
        "ы": "y", "ь": "", "э": "e", "ю": "yu", "я": "ya"
      };

      const slugify = (value) => {
        if (!value) return "";
        const lower = value.toLowerCase();
        let out = "";
        for (const ch of lower) {
          if (translitMap[ch] !== undefined) {
            out += translitMap[ch];
            continue;
          }
          if ((ch >= "a" && ch <= "z") || (ch >= "0" && ch <= "9")) {
            out += ch;
            continue;
          }
          out += "-";
        }
        out = out.replace(/-+/g, "-").replace(/^-|-$/g, "");
        return out;
      };

      const formatTrainerName = (trainer) => {
        if (!trainer) return "";
        const name = [trainer.first_name, trainer.last_name].filter(Boolean).join(" ");
        return name || trainer.username || `Куратор #${trainer.id}`;
      };

      const pluralizeWeeks = (value) => {
        const count = Number(value);
        if (!Number.isFinite(count)) return "недель";
        const mod100 = Math.abs(count) % 100;
        const mod10 = mod100 % 10;
        if (mod100 >= 11 && mod100 <= 14) return "недель";
        if (mod10 === 1) return "неделя";
        if (mod10 >= 2 && mod10 <= 4) return "недели";
        return "недель";
      };

      const renderTrainerSelect = (trainers) => {
        if (!trainerSelect) return;
        const current = trainerSelect.value;
        const options = trainers.map((trainer) => (
          `<option value="${trainer.id}">${formatTrainerName(trainer)}</option>`
        ));
        trainerSelect.innerHTML = `<option value="">Не выбран</option>${options.join("")}`;
        if (current) trainerSelect.value = current;
      };

      const loadTrainers = async () => {
        if (!apiBase || !initData) return;
        try {
          const res = await fetch(`${apiBase}/api/admin/trainers?initData=${encodeURIComponent(initData)}`);
          const json = await res.json().catch(() => ({}));
          if (!json?.ok || !Array.isArray(json.trainers)) return;
          trainerList = json.trainers;
          renderTrainerSelect(json.trainers);
        } catch (err) {
          console.warn("trainers load failed", err);
        }
      };

      const normalizeSearch = (value) => String(value || "").toLowerCase().trim();

      const buildExerciseOptions = (items) => [
        `<option value="">Выбрать из архива</option>`,
        ...items.map((exercise) => (
          `<option value="${exercise.id}">${exercise.title}</option>`
        ))
      ].join("");

      const refreshExerciseSelects = () => {
        const currentType = document.querySelector("input[name='programType']:checked")?.value || "gym";

        document.querySelectorAll("[data-ex-select]").forEach((select) => {
          const card = select.closest("[data-exercise]");
          const searchInput = card?.querySelector("[data-ex-search]");
          const query = normalizeSearch(searchInput?.value);
          const filtered = exerciseLibrary.filter((exercise) => {
            const matchesType = !exercise?.type || exercise.type === currentType;
            if (!matchesType) return false;
            if (!query) return true;
            const title = normalizeSearch(exercise.title);
            return title.includes(query);
          });

          const current = select.value;
          select.innerHTML = buildExerciseOptions(filtered);
          if (current && filtered.some((exercise) => String(exercise.id) === String(current))) {
            select.value = current;
          }
        });
      };

      if (programTypeInputs.length) {
        programTypeInputs.forEach((input) => {
          input.addEventListener("change", () => {
            refreshExerciseSelects();
          });
        });
      }

      const loadExercises = async () => {
        if (!apiBase || !initData) return;
        try {
          const res = await fetch(`${apiBase}/api/admin/exercises?initData=${encodeURIComponent(initData)}`);
          const json = await res.json().catch(() => ({}));
          if (!json?.ok || !Array.isArray(json.exercises)) return;
          exerciseLibrary = json.exercises;
          refreshExerciseSelects();
        } catch (err) {
          console.warn("exercises load failed", err);
        }
      };

      const bindExerciseUpload = (card) => {
        if (!card) return;
        const uploadBtn = card.querySelector("[data-ex-upload]");
        const fileInput = card.querySelector("[data-ex-file]");
        const urlInput = card.querySelector("[data-ex-video]");
        if (!uploadBtn || !fileInput || !urlInput) return;
        uploadBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", async () => {
          const file = fileInput.files?.[0];
          fileInput.value = "";
          if (!file) return;
          uploadBtn.disabled = true;
          const url = await uploadAdminMedia({ kind: "program_video", file });
          if (url) urlInput.value = url;
          uploadBtn.disabled = false;
        });
      };

      const createExerciseCard = () => {
        const card = document.createElement("div");
        card.className = "exercise-card";
        card.dataset.exercise = "true";
        card.innerHTML = `
          <div class="card-head">
            <span class="chip" data-exercise-label>Упражнение</span>
            <button class="btn-ghost" data-action="remove-exercise" type="button">Удалить</button>
          </div>
          <div class="form-grid">
            <label class="full">
              Поиск в архиве
              <input type="text" data-ex-search placeholder="Начни вводить название">
            </label>
            <label class="full">
              Архив упражнений
              <select data-ex-select>
                <option value="">Выбрать из архива</option>
              </select>
            </label>
            <label>
              Метка (1a)
              <input type="text" data-ex-label placeholder="1a">
            </label>
            <label>
              Название упражнения
              <input type="text" data-ex-title placeholder="Например: Оверхед присед">
            </label>
            <label>
              Кратко (повторы/сек)
              <input type="text" data-ex-details placeholder="12 повторов">
            </label>
            <label class="full">
              Описание
              <textarea data-ex-description placeholder="Техника выполнения..."></textarea>
            </label>
            <label class="full">
              Видео (ссылка или файл)
              <div class="inline-group">
                <input type="url" data-ex-video placeholder="https://...">
                <button class="btn-ghost btn-file" data-ex-upload type="button">Файл</button>
              </div>
              <input type="file" data-ex-file accept="video/*" hidden>
            </label>
          </div>
        `;
        bindExerciseUpload(card);
        const searchInput = card.querySelector("[data-ex-search]");
        if (searchInput) {
          searchInput.addEventListener("input", () => refreshExerciseSelects());
        }
        return card;
      };

      const createWorkoutCard = () => {
        const card = document.createElement("div");
        card.className = "workout-card";
        card.dataset.workout = "true";
        card.innerHTML = `
          <div class="card-head">
            <span class="chip" data-workout-label>Тренировка</span>
            <button class="btn-ghost" data-action="remove-workout" type="button">Удалить</button>
          </div>
          <div class="form-grid">
            <label>
              Название тренировки
              <input type="text" data-workout-title placeholder="Силовая + кардио">
            </label>
            <label class="full">
              Описание тренировки
              <textarea data-workout-desc placeholder="Короткое описание тренировки..."></textarea>
            </label>
          </div>
          <div class="exercise-list" data-exercises></div>
          <div class="section-actions">
            <button class="btn-outline" data-action="add-exercise" type="button">+ Упражнение</button>
          </div>
        `;
        return card;
      };

      const createWeekCard = () => {
        const card = document.createElement("div");
        card.className = "week-card";
        card.dataset.week = "true";
        card.innerHTML = `
          <div class="card-head">
            <span class="chip" data-week-label>Неделя</span>
            <button class="btn-ghost" data-action="remove-week" type="button">Удалить</button>
          </div>
          <label>
            Название недели
            <input type="text" data-week-title placeholder="Неделя 1">
          </label>
          <div class="repeat-row">
            <label>
              Повторить неделю
              <select data-repeat-source>
                <option value="">Повторить неделю...</option>
              </select>
            </label>
            <button class="btn-outline" data-action="repeat-week" type="button">Повторить</button>
          </div>
          <div class="stack" data-workouts></div>
          <div class="section-actions">
            <button class="btn-outline" data-action="add-workout" type="button">+ Тренировка</button>
          </div>
        `;
        return card;
      };

      const addDefaultWeek = () => {
        const weekCard = createWeekCard();
        const workoutsContainer = weekCard.querySelector("[data-workouts]");
        const workoutCard = createWorkoutCard();
        workoutsContainer.appendChild(workoutCard);
        const exercisesContainer = workoutCard.querySelector("[data-exercises]");
        exercisesContainer.appendChild(createExerciseCard());
        weeksContainer.appendChild(weekCard);
        renumber();
        refreshExerciseSelects();
      };

      const renumber = () => {
        const weekCards = Array.from(weeksContainer.querySelectorAll("[data-week]"));
        programWeeksCount.value = weekCards.length || "";
        weekCards.forEach((weekCard, weekIndex) => {
          const weekLabel = weekCard.querySelector("[data-week-label]");
          if (weekLabel) weekLabel.textContent = `Неделя ${weekIndex + 1}`;
          const workoutCards = Array.from(weekCard.querySelectorAll("[data-workout]"));
          workoutCards.forEach((workoutCard, workoutIndex) => {
            const workoutLabel = workoutCard.querySelector("[data-workout-label]");
            if (workoutLabel) workoutLabel.textContent = `Тренировка ${workoutIndex + 1}`;
            const exerciseCards = Array.from(workoutCard.querySelectorAll("[data-exercise]"));
            exerciseCards.forEach((exerciseCard, exerciseIndex) => {
              const exLabel = exerciseCard.querySelector("[data-exercise-label]");
              if (exLabel) exLabel.textContent = `Упражнение ${exerciseIndex + 1}`;
            });
          });
        });
        refreshRepeatOptions();
      };

      const refreshRepeatOptions = () => {
        const weekCards = Array.from(weeksContainer.querySelectorAll("[data-week]"));
        const titles = weekCards.map((weekCard, idx) => {
          const title = weekCard.querySelector("[data-week-title]")?.value.trim();
          return title || `Неделя ${idx + 1}`;
        });

        weekCards.forEach((weekCard, idx) => {
          const select = weekCard.querySelector("[data-repeat-source]");
          if (!select) return;
          const currentIndex = idx + 1;
          const currentValue = select.value;
          const options = titles
            .map((title, titleIdx) => {
              const index = titleIdx + 1;
              if (index === currentIndex) return "";
              return `<option value="${index}">Неделя ${index}: ${title}</option>`;
            })
            .filter(Boolean)
            .join("");
          select.innerHTML = `<option value="">Повторить неделю...</option>${options}`;
          if (currentValue && currentValue !== String(currentIndex)) {
            select.value = currentValue;
          }
        });
      };

      const extractWeekData = (weekCard) => {
        const weekTitle = weekCard.querySelector("[data-week-title]")?.value.trim() || "";
        const workouts = [];
        const workoutCards = Array.from(weekCard.querySelectorAll("[data-workout]"));
        workoutCards.forEach((workoutCard) => {
          const title = workoutCard.querySelector("[data-workout-title]")?.value.trim() || "";
          const description = workoutCard.querySelector("[data-workout-desc]")?.value.trim() || "";
          const exercises = [];
          const exerciseCards = Array.from(workoutCard.querySelectorAll("[data-exercise]"));
          exerciseCards.forEach((exerciseCard) => {
            const selectId = exerciseCard.querySelector("[data-ex-select]")?.value || "";
            exercises.push({
              selectId,
              label: exerciseCard.querySelector("[data-ex-label]")?.value.trim() || "",
              title: exerciseCard.querySelector("[data-ex-title]")?.value.trim() || "",
              details: exerciseCard.querySelector("[data-ex-details]")?.value.trim() || "",
              description: exerciseCard.querySelector("[data-ex-description]")?.value.trim() || "",
              videoUrl: exerciseCard.querySelector("[data-ex-video]")?.value.trim() || ""
            });
          });
          workouts.push({ title, description, exercises });
        });
        return { title: weekTitle, workouts };
      };

      const applyWeekData = (weekCard, data) => {
        const weekTitle = weekCard.querySelector("[data-week-title]");
        if (weekTitle) weekTitle.value = data.title || "";
        const workoutsContainer = weekCard.querySelector("[data-workouts]");
        if (!workoutsContainer) return;
        workoutsContainer.innerHTML = "";

        (data.workouts || []).forEach((workout) => {
          const workoutCard = createWorkoutCard();
          const workoutTitle = workoutCard.querySelector("[data-workout-title]");
          const workoutDesc = workoutCard.querySelector("[data-workout-desc]");
          if (workoutTitle) workoutTitle.value = workout.title || "";
          if (workoutDesc) workoutDesc.value = workout.description || "";
          const exercisesContainer = workoutCard.querySelector("[data-exercises]");
          exercisesContainer.innerHTML = "";
          (workout.exercises || []).forEach((exercise) => {
            const exerciseCard = createExerciseCard();
            const select = exerciseCard.querySelector("[data-ex-select]");
            if (select && exercise.selectId) select.value = exercise.selectId;
            const exLabel = exerciseCard.querySelector("[data-ex-label]");
            const exTitle = exerciseCard.querySelector("[data-ex-title]");
            const exDetails = exerciseCard.querySelector("[data-ex-details]");
            const exDescription = exerciseCard.querySelector("[data-ex-description]");
            const exVideo = exerciseCard.querySelector("[data-ex-video]");
            if (exLabel) exLabel.value = exercise.label || "";
            if (exTitle) exTitle.value = exercise.title || "";
            if (exDetails) exDetails.value = exercise.details || "";
            if (exDescription) exDescription.value = exercise.description || "";
            if (exVideo) exVideo.value = exercise.videoUrl || "";
            exercisesContainer.appendChild(exerciseCard);
          });
          workoutsContainer.appendChild(workoutCard);
        });

        if (!workoutsContainer.querySelector("[data-workout]")) {
          const workoutCard = createWorkoutCard();
          workoutsContainer.appendChild(workoutCard);
          workoutCard.querySelector("[data-exercises]")?.appendChild(createExerciseCard());
        }

        renumber();
        refreshExerciseSelects();
      };

      const generatePlanStructure = () => {
        const weeksCount = Number(planWeeks.value);
        const workoutsCount = Number(planWorkouts.value);

        if (!Number.isFinite(weeksCount) || weeksCount < 1) {
          setStatus("Укажи количество недель.", false);
          return;
        }
        if (!Number.isFinite(workoutsCount) || workoutsCount < 1) {
          setStatus("Укажи количество тренировок в неделе.", false);
          return;
        }

        weeksContainer.innerHTML = "";
        for (let w = 0; w < weeksCount; w += 1) {
          const weekCard = createWeekCard();
          const weekTitle = weekCard.querySelector("[data-week-title]");
          if (weekTitle) weekTitle.value = `Неделя ${w + 1}`;
          const workoutsContainer = weekCard.querySelector("[data-workouts]");
          for (let t = 0; t < workoutsCount; t += 1) {
            const workoutCard = createWorkoutCard();
            const workoutTitle = workoutCard.querySelector("[data-workout-title]");
            if (workoutTitle) workoutTitle.value = `Тренировка ${t + 1}`;
            const exercisesContainer = workoutCard.querySelector("[data-exercises]");
            exercisesContainer.appendChild(createExerciseCard());
            workoutsContainer.appendChild(workoutCard);
          }
          weeksContainer.appendChild(weekCard);
        }

        renumber();
        refreshExerciseSelects();
        setStatus("План создан.", true);
        setWizardStep(3);
      };

      const collectProgram = () => {
        const type = document.querySelector("input[name='programType']:checked")?.value || "gym";
        const tariffs = getSelectedTariffs();
        const freqValue = programFrequencyValue.value.trim();
        const freqUnit = programFrequencyUnit.value || "трен/нед";
        const program = {
          title: programTitle.value.trim(),
          slug: programSlug.value.trim(),
          type,
          tariffs,
          guestAccess: Boolean(programGuestAccess?.checked),
          subtitle: programSubtitle.value.trim(),
          summary: programSummary.value.trim(),
          description: programDescription.value.trim(),
          level: programLevel.value.trim(),
          gender: programGender.value.trim(),
          frequency: freqValue ? `${freqValue} ${freqUnit}` : "",
          coverImage: programCover.value.trim(),
          trainerId: trainerSelect.value,
          authorName: programAuthorName.value.trim(),
          authorRole: programAuthorRole.value.trim(),
          authorAvatar: programAuthorAvatar.value.trim(),
          weeks: []
        };

        const errors = [];
        if (!program.title) errors.push("Заполни название программы.");
        if (!tariffs.length) errors.push("Выбери хотя бы один тариф.");

        const weekCards = Array.from(weeksContainer.querySelectorAll("[data-week]"));
        if (!weekCards.length) errors.push("Добавь хотя бы одну неделю.");

        weekCards.forEach((weekCard, weekIndex) => {
          const weekTitle = weekCard.querySelector("[data-week-title]")?.value.trim();
          const week = { title: weekTitle, workouts: [] };
          const workoutCards = Array.from(weekCard.querySelectorAll("[data-workout]"));
          if (!workoutCards.length) {
            errors.push(`Неделя ${weekIndex + 1}: добавь тренировку.`);
          }
          workoutCards.forEach((workoutCard, workoutIndex) => {
            const workoutTitle = workoutCard.querySelector("[data-workout-title]")?.value.trim();
            const workoutDesc = workoutCard.querySelector("[data-workout-desc]")?.value.trim();
            const workout = { title: workoutTitle, description: workoutDesc, exercises: [] };
            if (!workoutTitle) {
              errors.push(`Неделя ${weekIndex + 1}: заполни название тренировки ${workoutIndex + 1}.`);
            }
            const exerciseCards = Array.from(workoutCard.querySelectorAll("[data-exercise]"));
            if (!exerciseCards.length) {
              errors.push(`Неделя ${weekIndex + 1}: тренировка ${workoutIndex + 1} без упражнений.`);
            }
            exerciseCards.forEach((exerciseCard, exerciseIndex) => {
              const exLabel = exerciseCard.querySelector("[data-ex-label]")?.value.trim();
              const exTitle = exerciseCard.querySelector("[data-ex-title]")?.value.trim();
              const exDetails = exerciseCard.querySelector("[data-ex-details]")?.value.trim();
              const exDescription = exerciseCard.querySelector("[data-ex-description]")?.value.trim();
              const exVideo = exerciseCard.querySelector("[data-ex-video]")?.value.trim();
              if (!exTitle) {
                errors.push(`Неделя ${weekIndex + 1}: тренировка ${workoutIndex + 1}, упражнение ${exerciseIndex + 1} — нет названия.`);
              }
              workout.exercises.push({
                label: exLabel,
                title: exTitle,
                details: exDetails,
                description: exDescription,
                videoUrl: exVideo
              });
            });
            week.workouts.push(workout);
          });
          program.weeks.push(week);
        });

        return { program, errors };
      };

      const clearForm = () => {
        setEditMode(null);
        programTitle.value = "";
        programSlug.value = "";
        programSubtitle.value = "";
        programSummary.value = "";
        programDescription.value = "";
        programLevel.value = "";
        programGender.value = "";
        programFrequencyValue.value = "";
        programFrequencyUnit.value = "трен/нед";
        programCover.value = "";
        trainerSelect.value = "";
        programAuthorName.value = "Тестов Тест Тестович";
        programAuthorRole.value = "Куратор Fit Dew";
        programAuthorAvatar.value = "";
        if (programGuestAccess) programGuestAccess.checked = false;
        planWeeks.value = "4";
        planWorkouts.value = "2";
        const defaultType = trainerScope && trainerScope !== "both" ? trainerScope : "gym";
        const typeInput = document.querySelector(`input[name='programType'][value='${defaultType}']`);
        if (typeInput) {
          typeInput.checked = true;
        } else {
          document.querySelector("input[name='programType'][value='gym']").checked = true;
        }
        setSelectedTariffs(["Базовый", "Оптимальный", "Максимум"]);
        weeksContainer.innerHTML = "";
        addDefaultWeek();
        setStatus("", null);
        setWizardStep(1);
        if (isTrainer) {
          applyTrainerScope();
        } else {
          refreshExerciseSelects();
        }
      };

      const renderProgramList = (programs) => {
        programList.innerHTML = "";
        if (!programs.length) {
          programList.innerHTML = "<p class='muted'>Программ пока нет.</p>";
          return;
        }
        programs.forEach((program) => {
          const item = document.createElement("div");
          item.className = "program-item";
          const weeksCount = Number(program.weeksCount);
          const weeksLabel = Number.isFinite(weeksCount) && weeksCount > 0
            ? `${weeksCount} ${pluralizeWeeks(weeksCount)}`
            : "-";
          item.innerHTML = `
            <div class="program-meta">
              <strong>${program.title || program.slug}</strong>
              <div class="program-tags">
                <span class="program-tag">${program.type === "crossfit" ? "Кроссфит" : "Зал"}</span>
                <span class="program-tag">${weeksLabel}</span>
                ${program.guestAccess ? '<span class="program-tag">Гостевой</span>' : ""}
              </div>
            </div>
            <div class="section-actions">
              <button class="btn-outline" type="button" data-load-slug="${program.slug}">Редактировать</button>
              <button class="btn-ghost" type="button" data-delete-slug="${program.slug}">Удалить</button>
            </div>
          `;
          programList.appendChild(item);
        });
      };

      const filterProgramsByScope = (programs) => {
        if (!isTrainer || !trainerScope || trainerScope === "both") return programs;
        return programs.filter((program) => program.type === trainerScope);
      };

      const loadPrograms = async () => {
        if (!apiBase) return;
        try {
          const res = await fetch(`${apiBase}/api/programs`);
          const json = await res.json().catch(() => ({}));
          if (json?.ok && Array.isArray(json.programs)) {
            renderProgramList(filterProgramsByScope(json.programs));
          }
        } catch (err) {
          console.warn("programs load failed", err);
        }
      };

      const loadProgramIntoForm = async (slug) => {
        if (!slug || !apiBase) return;
        try {
          const res = await fetch(`${apiBase}/api/programs/${encodeURIComponent(slug)}`);
          const json = await res.json().catch(() => ({}));
          if (!json?.ok || !json.program) return;
          const program = json.program;
          if (isTrainer && trainerScope && trainerScope !== "both" && program.type !== trainerScope) {
            setStatus("У тебя нет прав редактировать программу другого типа.", false);
            return;
          }

          programTitle.value = program.title || "";
          programSlug.value = program.slug || "";
          programSubtitle.value = program.subtitle || "";
          programSummary.value = program.summary || "";
          programDescription.value = program.description || "";
          programLevel.value = program.level || "";
          programGender.value = program.gender || "";
          const freqRaw = (program.frequency || "").trim();
          const freqMatch = freqRaw.match(/^(\d+)\s*(.*)$/);
          if (freqMatch) {
            programFrequencyValue.value = freqMatch[1];
            const unitValue = freqMatch[2].trim();
            const units = Array.from(programFrequencyUnit.options).map((opt) => opt.value);
            programFrequencyUnit.value = units.includes(unitValue) ? unitValue : "трен/нед";
          } else {
            programFrequencyValue.value = "";
            programFrequencyUnit.value = "трен/нед";
          }
          programCover.value = program.coverImage || "";
          programAuthorName.value = program.authorName || "Тестов Тест Тестович";
          programAuthorRole.value = program.authorRole || "Куратор Fit Dew";
          programAuthorAvatar.value = program.authorAvatar || "";
          trainerSelect.value = program.authorUserId ? String(program.authorUserId) : "";
          if (programGuestAccess) programGuestAccess.checked = Boolean(program.guestAccess);
          const typeInput = document.querySelector(`input[name='programType'][value='${program.type}']`);
          if (typeInput) typeInput.checked = true;
          setSelectedTariffs(program.tariffs);

          planWeeks.value = program.weeks?.length || "";
          const firstWeekWorkouts = program.weeks?.[0]?.workouts?.length || "";
          planWorkouts.value = firstWeekWorkouts || "";

          weeksContainer.innerHTML = "";
          (program.weeks || []).forEach((week) => {
            const weekCard = createWeekCard();
            weekCard.querySelector("[data-week-title]").value = week.title || "";
            const workoutsContainer = weekCard.querySelector("[data-workouts]");
            workoutsContainer.innerHTML = "";
            (week.workouts || []).forEach((workout) => {
              const workoutCard = createWorkoutCard();
              workoutCard.querySelector("[data-workout-title]").value = workout.title || "";
              workoutCard.querySelector("[data-workout-desc]").value = workout.description || "";
              const exercisesContainer = workoutCard.querySelector("[data-exercises]");
              exercisesContainer.innerHTML = "";
              (workout.exercises || []).forEach((exercise) => {
                const exerciseCard = createExerciseCard();
                exerciseCard.querySelector("[data-ex-label]").value = exercise.label || "";
                exerciseCard.querySelector("[data-ex-title]").value = exercise.title || "";
                exerciseCard.querySelector("[data-ex-details]").value = exercise.details || "";
                exerciseCard.querySelector("[data-ex-description]").value = exercise.description || "";
                exerciseCard.querySelector("[data-ex-video]").value = exercise.videoUrl || "";
                exercisesContainer.appendChild(exerciseCard);
              });
              workoutsContainer.appendChild(workoutCard);
            });
            weeksContainer.appendChild(weekCard);
          });

          if (!weeksContainer.querySelector("[data-week]")) {
            addDefaultWeek();
          } else {
            renumber();
          }
          refreshExerciseSelects();
          setEditMode(program.slug);
          setWizardStep(1);
          scrollToForm();
          setStatus("Программа загружена в форму.", true);
        } catch (err) {
          console.warn("load program failed", err);
        }
      };

      const deleteProgramBySlug = async (slug) => {
        if (!slug) return;
        if (!apiBase) {
          setStatus("Не найден API_BASE. Проверь env.js.", false);
          return;
        }
        if (!initData) {
          setStatus("Нет initData. Открой админку внутри Telegram.", false);
          return;
        }
        const ok = confirm(`Удалить программу "${slug}"?`);
        if (!ok) return;

        setStatus("Удаляем программу...", null);
        try {
          const res = await fetch(`${apiBase}/api/admin/programs/${encodeURIComponent(slug)}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ initData })
          });
          const json = await res.json().catch(() => ({}));
          if (!res.ok || !json?.ok) {
            setStatus("Не удалось удалить программу.", false);
            return;
          }
          if (editingSlug === slug) {
            clearForm();
          }
          await loadPrograms();
          setStatus("Программа удалена.", true);
        } catch (err) {
          console.error(err);
          setStatus("Ошибка сети при удалении программы.", false);
        }
      };

      document.addEventListener("change", (event) => {
        const select = event.target.closest("[data-ex-select]");
        if (!select) return;
        const id = Number(select.value);
        if (!Number.isInteger(id)) return;
        const exercise = exerciseLibrary.find((item) => item.id === id);
        if (!exercise) return;
        const card = select.closest("[data-exercise]");
        if (!card) return;
        const title = card.querySelector("[data-ex-title]");
        const description = card.querySelector("[data-ex-description]");
        const video = card.querySelector("[data-ex-video]");
        if (title) title.value = exercise.title || "";
        if (description) description.value = exercise.description || "";
        if (video) video.value = exercise.videoUrl || "";
      });

      document.addEventListener("click", (event) => {
        const actionBtn = event.target.closest("[data-action]");
        if (actionBtn) {
          const action = actionBtn.dataset.action;
          if (action === "add-week") {
            addDefaultWeek();
            return;
          }
          if (action === "remove-week") {
            actionBtn.closest("[data-week]")?.remove();
            renumber();
            return;
          }
          if (action === "repeat-week") {
            const targetWeek = actionBtn.closest("[data-week]");
            if (!targetWeek) return;
            const select = targetWeek.querySelector("[data-repeat-source]");
            const sourceIndex = Number(select?.value);
            if (!Number.isInteger(sourceIndex) || sourceIndex < 1) {
              setStatus("Выбери неделю для повтора.", false);
              return;
            }
            const weekCards = Array.from(weeksContainer.querySelectorAll("[data-week]"));
            const sourceWeek = weekCards[sourceIndex - 1];
            if (!sourceWeek) {
              setStatus("Неделя для повтора не найдена.", false);
              return;
            }
            const data = extractWeekData(sourceWeek);
            applyWeekData(targetWeek, data);
            setStatus(`Неделя ${weekCards.indexOf(targetWeek) + 1} повторяет неделю ${sourceIndex}.`, true);
            return;
          }
          if (action === "add-workout") {
            const weekCard = actionBtn.closest("[data-week]");
            if (!weekCard) return;
            const workoutsContainer = weekCard.querySelector("[data-workouts]");
            const workoutCard = createWorkoutCard();
            workoutsContainer.appendChild(workoutCard);
            const exercisesContainer = workoutCard.querySelector("[data-exercises]");
            exercisesContainer.appendChild(createExerciseCard());
            renumber();
            refreshExerciseSelects();
            return;
          }
          if (action === "remove-workout") {
            actionBtn.closest("[data-workout]")?.remove();
            renumber();
            return;
          }
          if (action === "add-exercise") {
            const workoutCard = actionBtn.closest("[data-workout]");
            if (!workoutCard) return;
            const exercisesContainer = workoutCard.querySelector("[data-exercises]");
            exercisesContainer.appendChild(createExerciseCard());
            renumber();
            refreshExerciseSelects();
            return;
          }
          if (action === "remove-exercise") {
            actionBtn.closest("[data-exercise]")?.remove();
            renumber();
          }
        }

        const loadBtn = event.target.closest("[data-load-slug]");
        if (loadBtn) {
          loadProgramIntoForm(loadBtn.dataset.loadSlug);
        }

        const deleteBtn = event.target.closest("[data-delete-slug]");
        if (deleteBtn) {
          deleteProgramBySlug(deleteBtn.dataset.deleteSlug);
        }

      });

      wizardSteps.forEach((stepBtn) => {
        stepBtn.addEventListener("click", () => {
          const step = Number(stepBtn.dataset.step);
          if (!Number.isFinite(step)) return;
          setWizardStep(step);
        });
      });

      wizardPrev?.addEventListener("click", () => {
        setWizardStep(wizardStep - 1);
      });

      wizardNext?.addEventListener("click", () => {
        setWizardStep(wizardStep + 1);
      });

      slugAuto?.addEventListener("click", () => {
        programSlug.value = slugify(programTitle.value.trim());
      });

      const buildUrl = (path) => (
        initData ? `${path}?initData=${encodeURIComponent(initData)}` : path
      );

      goHome?.addEventListener("click", () => {
        window.location.href = buildUrl("admin_programs.html");
      });

      goExercises?.addEventListener("click", () => {
        window.location.href = buildUrl("admin_exercises.html");
      });

      goClients?.addEventListener("click", () => {
        window.location.href = buildUrl("admin_clients.html");
      });

      programCoverUpload?.addEventListener("click", () => programCoverFile?.click());
      programCoverFile?.addEventListener("change", async () => {
        const file = programCoverFile.files?.[0];
        programCoverFile.value = "";
        if (!file) return;
        if (programCoverUpload) programCoverUpload.disabled = true;
        const url = await uploadAdminMedia({ kind: "program_cover", file });
        if (url && programCover) programCover.value = url;
        if (programCoverUpload) programCoverUpload.disabled = false;
      });

      generatePlan?.addEventListener("click", () => generatePlanStructure());

      trainerSelect?.addEventListener("change", () => {
        if (!trainerSelect.value) return;
        const trainer = trainerList.find((item) => String(item.id) === trainerSelect.value);
        if (!trainer) return;
        programAuthorName.value = formatTrainerName(trainer);
        if (!programAuthorRole.value) {
          programAuthorRole.value = "Куратор Fit Dew";
        }
      });

      resetForm?.addEventListener("click", () => clearForm());

      deleteProgram?.addEventListener("click", () => {
        if (editingSlug) {
          deleteProgramBySlug(editingSlug);
        }
      });

      saveProgram?.addEventListener("click", async () => {
        if (!apiBase) {
          setStatus("Не найден API_BASE. Проверь env.js.", false);
          return;
        }
        if (!initData) {
          setStatus("Нет initData. Открой админку внутри Telegram.", false);
          return;
        }
        const { program, errors } = collectProgram();
        if (errors.length) {
          setStatus(errors[0], false);
          return;
        }

        saveProgram.disabled = true;
        const isEditing = Boolean(editingSlug);
        setStatus(isEditing ? "Обновляем программу..." : "Сохраняем программу...", null);
        try {
          const url = isEditing
            ? `${apiBase}/api/admin/programs/${encodeURIComponent(editingSlug)}`
            : `${apiBase}/api/admin/programs`;
          const res = await fetch(url, {
            method: isEditing ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ initData, program })
          });
          const json = await res.json().catch(() => ({}));
          if (!res.ok || !json?.ok) {
            const details = Array.isArray(json?.details) ? json.details[0] : null;
            setStatus(details || "Не удалось сохранить программу.", false);
            saveProgram.disabled = false;
            return;
          }
          programSlug.value = json.program?.slug || programSlug.value;
          if (isEditing) {
            editingSlug = json.program?.slug || editingSlug;
            setEditMode(editingSlug);
          }
          setStatus(isEditing ? "Программа обновлена." : "Программа сохранена.", true);
          await loadPrograms();
        } catch (err) {
          console.error(err);
          setStatus("Ошибка сети при сохранении программы.", false);
        } finally {
          saveProgram.disabled = false;
        }
      });

      reloadPrograms?.addEventListener("click", () => loadPrograms());

      setWizardStep(1);

      const checkAccess = async () => {
        if (!apiBase) {
          setAccess(false, "Нет API_BASE. Проверь env.js и конфиг.");
          return;
        }
        if (!initData) {
          setAccess(false, "Открой админку через Telegram, чтобы получить initData.");
          return;
        }
        try {
          const res = await fetch(`${apiBase}/api/user?initData=${encodeURIComponent(initData)}`);
          const json = await res.json().catch(() => ({}));
          if (!json?.ok) {
            setAccess(false, "Не удалось подтвердить доступ.");
            return;
          }
          const role = json?.profile?.role || "user";
          const canTrain = Boolean(json?.profile?.canTrain);
          trainerScope = "both";
          isTrainer = false;
          if (!canTrain) {
            setAccess(false, "Доступ закрыт. Нужна роль admin или sadmin.");
            return;
          }
          const accessText = role === "sadmin"
            ? "Доступ подтвержден. Роль: суперадмин."
            : "Доступ подтвержден. Можно создавать программы.";
          setAccess(true, accessText);
          clearForm();
          if (isTrainer) {
            applyTrainerScope();
          }
          await loadTrainers();
          await loadExercises();
          await loadPrograms();
        } catch (err) {
          console.error(err);
          setAccess(false, "Ошибка сети при проверке доступа.");
        }
      };

      checkAccess();

      try {
        tg?.ready?.();
        tg?.expand?.();
      } catch (_) {}
    })();
  </script>
</body>
</html>
