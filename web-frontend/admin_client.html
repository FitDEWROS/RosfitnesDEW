<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Fit Dew - Профиль клиента</title>

  <script>

    (function() {

      const savedTheme = localStorage.getItem("theme") || "dark";

      document.documentElement.classList.toggle("light", savedTheme === "light");

    })();

  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@600;700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script src="env.js"></script>

  <style>

    :root {

      --bg: #0b0f14;

      --card: rgba(24, 27, 34, 0.9);

      --card-border: rgba(255, 255, 255, 0.08);

      --text: #f3f4f7;

      --muted: rgba(255, 255, 255, 0.55);

      --accent: #f2d17c;

      --accent-strong: #f0c266;

      --ok: #7ee0a8;

      --warn: #f3c76a;

      --shadow: 0 22px 50px rgba(0, 0, 0, 0.35);

      --radius: 18px;

    }



    html {

      color-scheme: dark;

    }

    html.light {

      color-scheme: light;

      --bg: #f4f1e9;

      --card: rgba(255, 255, 255, 0.9);

      --card-border: rgba(0, 0, 0, 0.06);

      --text: #121212;

      --muted: rgba(0, 0, 0, 0.55);

    }



    * { box-sizing: border-box; }

    body {

      margin: 0;

      font-family: "Manrope", sans-serif;

      background: var(--bg);

      color: var(--text);

    }



    .admin-screen {

      max-width: 1100px;

      margin: 0 auto;

      padding: 28px 20px 60px;

      display: grid;

      gap: 18px;

    }



    .page-header {

      display: grid;

      gap: 8px;

    }



    .header-top {

      display: flex;

      align-items: center;

      justify-content: space-between;

      gap: 12px;

      flex-wrap: wrap;

    }



    .eyebrow {

      font-size: 0.7rem;

      letter-spacing: 0.25em;

      text-transform: uppercase;

      color: var(--muted);

    }



    .page-title {

      margin: 0;

      font-family: "Exo 2", sans-serif;

      font-size: 1.6rem;

    }



    .page-subtitle {

      margin: 0;

      color: var(--muted);

    }



    .section-card {

      background: var(--card);

      border: 1px solid var(--card-border);

      border-radius: var(--radius);

      padding: 18px;

      box-shadow: var(--shadow);

    }

    #staffCard {

      margin-top: 14px;

    }

    #availableCard {
      margin-top: 16px;
    }

    #progressCard {
      margin-top: 16px;
    }

    .progress-list {
      display: grid;
      gap: 12px;
    }

    .progress-week {
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      display: grid;
      gap: 8px;
    }

    .progress-week-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .progress-week-weight {
      color: var(--text);
      font-weight: 600;
    }

    .progress-photos {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .progress-photo {
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 12px;
      object-fit: cover;
      background: rgba(0, 0, 0, 0.35);
      display: block;
    }

    .progress-photo.is-empty {
      display: grid;
      place-items: center;
      color: var(--muted);
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }



    .section-head {

      display: flex;

      align-items: center;

      justify-content: space-between;

      gap: 12px;

      flex-wrap: wrap;

      margin-bottom: 12px;

    }



    .section-title {

      margin: 0;

      font-size: 1.1rem;

    }



    .actions {

      display: flex;

      gap: 10px;

      flex-wrap: wrap;

    }



    .btn-outline {

      padding: 10px 14px;

      border-radius: 14px;

      border: 1px solid var(--card-border);

      background: transparent;

      color: var(--text);

      cursor: pointer;

      font-weight: 600;

    }



    .info-grid {

      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));

      gap: 12px;

    }



    .info-item {

      display: grid;

      gap: 6px;

      padding: 12px;

      border-radius: 14px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

    }



    html.light .info-item {

      background: rgba(0, 0, 0, 0.04);

    }



    .info-label {

      color: var(--muted);

      font-size: 0.65rem;

      letter-spacing: 0.18em;

      text-transform: uppercase;

    }



    .info-value {

      font-weight: 600;

    }



    .select {

      padding: 10px 40px 10px 12px;

      border-radius: 12px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

      color: var(--text);

      width: 100%;

      font-family: inherit;

      font-size: 0.95rem;

      line-height: 1.2;

      appearance: none;

      -webkit-appearance: none;

      -moz-appearance: none;

      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);

      background-position:
        right 18px center,
        right 12px center;

      background-size: 6px 6px, 6px 6px;

      background-repeat: no-repeat;

    }



    html.light .select {

      background: rgba(0, 0, 0, 0.04);

      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);

      background-position:
        right 18px center,
        right 12px center;

      background-size: 6px 6px, 6px 6px;

      background-repeat: no-repeat;

    }

    .select option {

      background: #1b1b1f;

      color: var(--text);

    }

    html.light .select option {

      background: #ffffff;

      color: #1b1b1b;

    }



    .calendar-card {

      display: grid;

      gap: 12px;

    }



    .calendar-head {

      display: flex;

      align-items: center;

      justify-content: space-between;

      gap: 12px;

      flex-wrap: wrap;

    }



    .calendar-nav {

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

      color: var(--text);

      border-radius: 10px;

      padding: 6px 10px;

      cursor: pointer;

    }



    html.light .calendar-nav {

      background: rgba(0, 0, 0, 0.04);

    }



    .calendar-grid {

      display: grid;

      grid-template-columns: repeat(7, minmax(0, 1fr));

      gap: 6px;

    }



    .calendar-day {

      height: 36px;

      border-radius: 10px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

      color: var(--text);

      cursor: pointer;

      position: relative;

    }



    html.light .calendar-day {

      background: rgba(0, 0, 0, 0.04);

    }



    .calendar-day.is-out {

      opacity: 0.35;

    }



    .calendar-day.is-selected {

      border-color: var(--accent);

      box-shadow: 0 0 0 2px rgba(242, 209, 124, 0.25);

    }



    .calendar-day.has-data::after {
      content: "";
      position: absolute;
      bottom: 4px;
      right: 6px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(126, 224, 168, 0.15);
    }

    .calendar-day.is-reviewed::after {
      background: #7ab8ff;
      box-shadow: 0 0 0 4px rgba(122, 184, 255, 0.2);
    }

    .calendar-day.has-comment {
      border-color: rgba(242, 209, 124, 0.55);
    }


    .day-card {

      display: grid;

      gap: 12px;

      padding: 14px;

      border-radius: 16px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

    }



    html.light .day-card {

      background: rgba(0, 0, 0, 0.04);

    }



    .day-metrics {

      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));

      gap: 10px;

    }



    .comment-box textarea {

      width: 100%;

      min-height: 120px;

      border-radius: 12px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

      color: var(--text);

      padding: 10px 12px;

      font-family: inherit;

    }



    html.light .comment-box textarea {

      background: rgba(0, 0, 0, 0.04);

    }



    .comment-actions {

      display: flex;

      align-items: center;

      gap: 10px;

      flex-wrap: wrap;

    }



    .status-line {

      font-size: 0.85rem;

      color: var(--muted);

    }



    details.section-card summary {

      cursor: pointer;

      list-style: none;

    }



    details.section-card summary::-webkit-details-marker {

      display: none;

    }



    .toggle-row {

      display: flex;

      align-items: center;

      gap: 10px;

      padding: 12px;

      border-radius: 14px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.18);

      font-weight: 600;

    }



    .chat-window {

      border-radius: 16px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.1);

      padding: 12px;

      max-height: 320px;

      overflow-y: auto;

      display: flex;

      flex-direction: column;

      gap: 10px;

    }



    .chat-bubble {

      max-width: 80%;

      padding: 10px 12px;

      border-radius: 14px;

      background: rgba(0, 0, 0, 0.14);

      color: var(--text);

      align-self: flex-start;

      word-break: break-word;

      position: relative;

    }



    .chat-bubble video {

      width: 100%;

      border-radius: 12px;

      background: #000;

      display: block;

      margin-bottom: 8px;

    }



    .chat-bubble.is-mine {

      align-self: flex-end;

      background: linear-gradient(135deg, var(--accent), var(--accent-strong));

      color: #1b1b1b;

    }
    .chat-meta {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
      line-height: 1;
      text-align: right;
    }
    .chat-time {
      font-size: 9px;
      opacity: 0.6;
      letter-spacing: 0.2px;
    }
    .chat-status {
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      gap: 2px;
      font-size: 10px;
      opacity: 0.6;
    }
    .chat-status svg {
      width: auto;
      height: 10px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      display: block;
    }
    .chat-status.is-read {
      opacity: 0.9;
    }



    .chat-input-row {

      display: flex;

      gap: 10px;

      align-items: center;

      margin-top: 12px;

    }



    .chat-attach {

      width: 40px;

      height: 40px;

      border-radius: 12px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.12);

      color: var(--text);

      font-size: 18px;

      cursor: pointer;

    }



    .chat-input {

      flex: 1;

      border-radius: 14px;

      border: 1px solid var(--card-border);

      background: rgba(0, 0, 0, 0.12);

      padding: 10px 12px;

      color: var(--text);

    }



    .chat-send {

      border: none;

      border-radius: 999px;

      padding: 10px 16px;

      background: linear-gradient(135deg, var(--accent), var(--accent-strong));

      color: #1b1b1b;

      font-weight: 700;

      cursor: pointer;

    }



    .chat-open-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.12);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .chat-open-btn svg {
      width: 18px;
      height: 18px;
    }


    html.light .chat-open-btn {

      background: rgba(0, 0, 0, 0.04);

      color: #1b1b1b;

    }



    html.light .toggle-row {

      background: rgba(0, 0, 0, 0.04);

    }



    @media (max-width: 640px) {

      .admin-screen { padding: 22px 16px 50px; }

      .calendar-day { height: 32px; font-size: 0.8rem; }

    }

  </style>

</head>

<body>

  <div class="admin-screen">

    <header class="page-header">

      <div class="header-top">

        <span class="eyebrow">Админка</span>

        <div class="actions">

          <button class="btn-outline" id="goBack" type="button">Назад</button>

        </div>

      </div>

      <h1 class="page-title" id="clientTitle">Профиль клиента</h1>

      <p class="page-subtitle" id="clientSubtitle">Данные и питание</p>

    </header>



    <section class="section-card" id="accessCard">

      <h2 class="section-title">Доступ</h2>

      <p class="page-subtitle" id="accessMessage">Проверяем права администратора...</p>

    </section>



    <section class="section-card" id="profileCard" hidden>

      <div class="section-head">

        <h2 class="section-title">Данные клиента</h2>

        <div class="status-line" id="profileStatus"></div>

      </div>

      <div class="info-grid">

        <div class="info-item">

          <div class="info-label">Имя</div>

          <div class="info-value" id="infoName">—</div>

        </div>

        <div class="info-item">

          <div class="info-label">Тариф</div>

          <div class="info-value" id="infoTariff">—</div>

        </div>

        <div class="info-item">

          <div class="info-label">Тип</div>

          <div class="info-value" id="infoMode">—</div>

        </div>

        <div class="info-item">

          <div class="info-label">Рост / Вес</div>

          <div class="info-value" id="infoStats">—</div>

        </div>

        <div class="info-item">

          <div class="info-label">Куратор</div>

          <select class="select" id="trainerSelect"></select>

        </div>

      </div>

    

    <details class="section-card" id="staffCard" hidden>

      <summary class="section-title">Настройка ролей</summary>

      <p class="page-subtitle">Только для суперадмина.</p>

      <div class="info-grid">

        <div class="info-item">

          <div class="info-label">Роль</div>

          <select class="select" id="staffRole">

            <option value="user">Пользователь</option>

            <option value="admin">Админ</option>

            <option value="sadmin">Суперадмин</option>
            <option value="curator">&#1050;&#1091;&#1088;&#1072;&#1090;&#1086;&#1088;</option>

          </select>

        </div>

        

        

        <div class="info-item">

          <div class="info-label">Направление</div>

          <select class="select" id="staffScope">

            <option value="gym">Зал</option>

            <option value="crossfit">Кроссфит</option>

            <option value="both">Оба</option>

          </select>

        </div>

      </div>

      <div class="actions">

        <button class="btn-outline" id="saveStaff" type="button">Сохранить роли</button>

        <span class="status-line" id="staffStatus"></span>

      </div>

    </details>


    <section class="section-card" id="availableCard" hidden>

      <div class="section-head">

        <h2 class="section-title">&#1044;&#1086;&#1089;&#1090;&#1091;&#1087;&#1085;&#1099;&#1077; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1099; &#1080; &#1091;&#1087;&#1088;&#1072;&#1078;&#1085;&#1077;&#1085;&#1080;&#1103;</h2>

        <button class="btn-outline" id="openAvailable" type="button">&#1054;&#1090;&#1082;&#1088;&#1099;&#1090;&#1100;</button>

      </div>

      <p class="page-subtitle" id="availableStatus">&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1095;&#1090;&#1086; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1085;&#1086; &#1082;&#1083;&#1080;&#1077;&#1085;&#1090;&#1091;.</p>

    </section>



</section>

    <section class="section-card" id="progressCard" hidden>
      <div class="section-head">
        <h2 class="section-title">Динамика веса и замеры</h2>
        <button class="btn-outline" id="refreshProgress" type="button">Обновить</button>
      </div>
      <div class="progress-list" id="progressList"></div>
    </section>


    <section class="section-card" id="chatCard" hidden>

      <div class="section-head">

        <h2 class="section-title">Чат с клиентом</h2>

        <button id="openChatPage" class="chat-open-btn" type="button" aria-label="Открыть чат">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M14 5h5v5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 14l9-9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 14v5H5V5h5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <p class="page-subtitle" id="chatStatus">Открой чат в отдельной странице.</p>

    </section>



    <section class="section-card" id="nutritionCard" hidden>

      <div class="section-head">

        <h2 class="section-title">Календарь питания</h2>

        <div class="actions">

          <button class="calendar-nav" id="prevMonth" type="button">&lt;</button>

          <span id="calendarTitle">Месяц</span>

          <button class="calendar-nav" id="nextMonth" type="button">&gt;</button>

        </div>

      </div>

      <div class="calendar-grid" id="calendarGrid"></div>

      <div class="day-card">

        <div>

          <div class="info-label">Выбранная дата</div>

          <div class="info-value" id="selectedDateLabel">—</div>

        </div>

        <div class="day-metrics">

          <div class="info-item">

            <div class="info-label">Ккал</div>

            <div class="info-value" id="entryKcal">—</div>

          </div>

          <div class="info-item">

            <div class="info-label">Б / Ж / У</div>

            <div class="info-value" id="entryMacros">—</div>

          </div>

          <div class="info-item">

            <div class="info-label">Вода</div>

            <div class="info-value" id="entryWater">—</div>

          </div>

          <div class="info-item">

            <div class="info-label">Приемы пищи</div>

            <div class="info-value" id="entryMeals">—</div>

          </div>

        </div>

        <div class="comment-box">

          <div class="info-label">Комментарий к питанию</div>

          <textarea id="commentText" placeholder="Напиши комментарий для клиента"></textarea>

        </div>

        <div class="comment-actions">

          <button class="btn-outline" id="saveComment" type="button">Сохранить комментарий</button>

          <span class="status-line" id="commentStatus"></span>

        </div>

      </div>

    </section>

  </div>



  <script>

    (function() {

      const tg = window.Telegram?.WebApp || null;
      const API_BASE = window.ENV?.API_BASE || "";
      const APP_VERSION = window.ENV?.APP_VERSION || "";
      const apiBase = API_BASE ? API_BASE.replace(/\/$/, "") : "";
      const params = new URLSearchParams(window.location.search);
      const openChatOnLoad = params.get("openChat") === "1";


      const accessMessage = document.getElementById("accessMessage");

      const profileCard = document.getElementById("profileCard");

      const nutritionCard = document.getElementById("nutritionCard");

      const chatCard = document.getElementById("chatCard");

      const chatMessages = document.getElementById("chatMessages");

      const chatInput = document.getElementById("chatInput");

      const chatSend = document.getElementById("chatSend");

      const chatAttach = document.getElementById("chatAttach");

      const chatFile = document.getElementById("chatFile");

      const openChatPage = document.getElementById("openChatPage");

      const chatStatus = document.getElementById("chatStatus");

      const profileStatus = document.getElementById("profileStatus");

      const progressCard = document.getElementById("progressCard");
      const progressList = document.getElementById("progressList");
      const refreshProgress = document.getElementById("refreshProgress");

      const clientTitle = document.getElementById("clientTitle");

      const clientSubtitle = document.getElementById("clientSubtitle");



      const infoName = document.getElementById("infoName");

      const infoTariff = document.getElementById("infoTariff");

      const infoMode = document.getElementById("infoMode");

      const infoStats = document.getElementById("infoStats");


      const trainerSelect = document.getElementById("trainerSelect");

      const staffCard = document.getElementById("staffCard");

      const staffRole = document.getElementById("staffRole");

      const staffScope = document.getElementById("staffScope");

      const saveStaff = document.getElementById("saveStaff");

      const staffStatus = document.getElementById("staffStatus");



      const calendarTitle = document.getElementById("calendarTitle");

      const calendarGrid = document.getElementById("calendarGrid");

      const prevMonth = document.getElementById("prevMonth");

      const nextMonth = document.getElementById("nextMonth");



      const selectedDateLabel = document.getElementById("selectedDateLabel");

      const entryKcal = document.getElementById("entryKcal");

      const entryMacros = document.getElementById("entryMacros");

      const entryWater = document.getElementById("entryWater");

      const entryMeals = document.getElementById("entryMeals");

      const commentText = document.getElementById("commentText");

      const saveComment = document.getElementById("saveComment");

      const commentStatus = document.getElementById("commentStatus");

      const goBack = document.getElementById("goBack");

      const availableCard = document.getElementById("availableCard");
      const openAvailable = document.getElementById("openAvailable");
      const availableStatus = document.getElementById("availableStatus");



      const clientId = Number(params.get("clientId") || params.get("id"));
      const monthNames = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
      const monthsShort = ["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"];


      let currentMonth = new Date();

      let selectedDate = new Date();
      let monthEntries = {};
      let monthComments = {};
      let monthReviewed = {};
      let hasNutritionDiary = true;
      let role = "user";
      let isAdmin = false;

      let isSuperAdmin = false;

      let canCurate = false;

      let initData = "";

      let currentUserId = null;
      let chatLastId = 0;
      let chatPollTimer = null;

      const buildChatUrl = () => {
        if (!clientId) return "";
        const query = new URLSearchParams();
        query.set("clientId", String(clientId));
        if (initData) query.set("initData", initData);
        if (APP_VERSION) query.set("v", APP_VERSION);
        return `admin_chat.html?${query.toString()}`;
      };

      const openChatWindow = () => {
        const url = buildChatUrl();
        if (!url) return;
        window.location.href = url;
      };

      const buildAvailableUrl = () => {
        if (!clientId) return "";
        const query = new URLSearchParams();
        query.set("clientId", String(clientId));
        if (initData) query.set("initData", initData);
        if (APP_VERSION) query.set("v", APP_VERSION);
        return `admin_client_available.html?${query.toString()}`;
      };

      const openAvailablePage = () => {
        const url = buildAvailableUrl();
        if (!url) return;
        window.location.href = url;
      };

      const buildInitData = () => {
        const raw = tg?.initData || "";

        if (raw && raw.length > 0) return raw;

        const u = tg?.initDataUnsafe || null;

        if (!u || !u.hash) return "";

        const p = new URLSearchParams();

        if (u.query_id) p.set("query_id", u.query_id);

        if (u.user) p.set("user", JSON.stringify(u.user));

        if (u.auth_date) p.set("auth_date", String(u.auth_date));

        if (u.start_param) p.set("start_param", u.start_param);

        if (u.chat_type) p.set("chat_type", u.chat_type);

        if (u.chat_instance) p.set("chat_instance", u.chat_instance);

        p.set("hash", u.hash);

        return p.toString();

      };



      const toYMD = (date) => {

        const y = date.getFullYear();

        const m = String(date.getMonth() + 1).padStart(2, "0");

        const d = String(date.getDate()).padStart(2, "0");

        return `${y}-${m}-${d}`;

      };



      const parseYMD = (value) => new Date(`${value}T00:00:00`);



      const startOfWeek = (date) => {

        const d = new Date(date);

        const day = (d.getDay() + 6) % 7;

        d.setDate(d.getDate() - day);

        return d;

      };



      const addDays = (date, offset) => {

        const d = new Date(date);

        d.setDate(d.getDate() + offset);

        return d;

      };

      const startOfMonth = (date) => {
        const d = new Date(date);
        d.setDate(1);
        return d;
      };

      const getMonthStartKey = (date) => toYMD(startOfMonth(date));

      const formatMonthRange = (monthStartKey) => {
        if (!monthStartKey) return "—";
        const start = parseYMD(monthStartKey);
        const end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
        return `${start.getDate()} ${monthsShort[start.getMonth()]} — ${end.getDate()} ${monthsShort[end.getMonth()]}`;
      };

      const formatMonthRangeNumeric = (monthStartKey) => {
        if (!monthStartKey) return "—";
        const start = parseYMD(monthStartKey);
        const end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
        const pad = (value) => String(value).padStart(2, "0");
        const startLabel = `${pad(start.getDate())}.${pad(start.getMonth() + 1)}`;
        const endLabel = `${pad(end.getDate())}.${pad(end.getMonth() + 1)}`;
        return `${startLabel} - ${endLabel}`;
      };

      const formatWeekRange = (weekStartKey) => {
        if (!weekStartKey) return "—";
        const start = parseYMD(weekStartKey);
        const end = addDays(start, 6);
        return `${start.getDate()} ${monthsShort[start.getMonth()]} — ${end.getDate()} ${monthsShort[end.getMonth()]}`;
      };



      const updateCalendarTitle = () => {

        if (calendarTitle) {

          calendarTitle.textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

        }

      };



      const renderCalendar = () => {
        if (!calendarGrid) return;
        calendarGrid.innerHTML = "";
        const first = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const start = startOfWeek(first);
        const selectedKey = toYMD(selectedDate);

        for (let i = 0; i < 42; i += 1) {
          const date = addDays(start, i);
          const key = toYMD(date);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "calendar-day";
          if (date.getMonth() !== currentMonth.getMonth()) btn.classList.add("is-out");
          if (key === selectedKey) btn.classList.add("is-selected");
          if (monthEntries[key]) btn.classList.add("has-data");
          if (monthReviewed[key]) btn.classList.add("is-reviewed");
          if (monthComments[key]) btn.classList.add("has-comment");
          btn.textContent = String(date.getDate());
          btn.addEventListener("click", () => {
            selectedDate = parseYMD(key);
            updateDayDetails();
            renderCalendar();
          });

          calendarGrid.appendChild(btn);

        }

      };



      const formatMode = (mode) => (mode === "crossfit" ? "Кроссфит" : "Зал");

      const isTariffActive = (value) => {
        if (!value) return true;
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return true;
        return dt.getTime() > Date.now();
      };




      const updateDayDetails = () => {
        const key = toYMD(selectedDate);
        const entry = monthEntries[key];
        const comment = monthComments[key] || "";


        selectedDateLabel.textContent = key;

        entryKcal.textContent = entry?.kcal ?? "—";

        const protein = entry?.protein ?? "—";

        const fat = entry?.fat ?? "—";

        const carb = entry?.carb ?? "—";

        entryMacros.textContent = `Б ${protein} · Ж ${fat} · У ${carb}`;

        entryWater.textContent = entry?.waterLiters ?? "—";

        entryMeals.textContent = entry?.mealsCount ?? "—";
        if (commentText) commentText.value = comment;
        if (entry && !monthReviewed[key]) {
          markDayReviewed(key);
        }
      };

      const markDayReviewed = async (dateKey) => {
        if (!apiBase || !initData || !clientId || !dateKey) return;
        try {
          const res = await fetch(`${apiBase}/api/admin/clients/${clientId}/nutrition-reviewed`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ initData, date: dateKey })
          });
          const json = await res.json().catch(() => ({}));
          if (json?.ok) {
            monthReviewed[dateKey] = true;
            renderCalendar();
          }
        } catch (e) {
          console.warn("nutrition reviewed update failed", e);
        }
      };


      const loadMonth = async () => {

        if (!apiBase || !initData || !clientId) return;

        const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);

        const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);

        const from = toYMD(start);

        const to = toYMD(end);



        try {

          const url = `${apiBase}/api/admin/clients/${clientId}/nutrition?initData=${encodeURIComponent(initData)}&from=${from}&to=${to}`;

          const res = await fetch(url);

          const json = await res.json().catch(() => ({}));

          if (!json?.ok) return;



          monthEntries = {};
          monthComments = {};
          monthReviewed = {};

          (json.entries || []).forEach((entry) => {
            if (entry?.date) monthEntries[entry.date] = entry;
            if (entry?.date && entry?.reviewedAt) monthReviewed[entry.date] = true;
          });
          (json.comments || []).forEach((comment) => {

            if (comment?.date) monthComments[comment.date] = comment.text || "";

          });



          updateCalendarTitle();

          renderCalendar();

          updateDayDetails();

        } catch (e) {

          console.error("Ошибка загрузки календаря", e);

        }

      };



      const formatWeight = (value) => {
        if (!Number.isFinite(value)) return "—";
        const rounded = Math.round(value * 10) / 10;
        return String(rounded).replace(/\.0$/, "");
      };

      const renderProgress = (weightLogs = [], photoItems = []) => {
        if (!progressList) return;
        progressList.innerHTML = "";
        const weightMap = new Map();
        weightLogs.forEach((log) => {
          const key = getMonthStartKey(parseYMD(log.weekStart));
          if (!weightMap.has(key)) weightMap.set(key, log);
        });
        const photoMap = new Map();
        photoItems.forEach((item) => {
          const key = getMonthStartKey(parseYMD(item.weekStart));
          if (!photoMap.has(key)) photoMap.set(key, item);
        });
        const weekKeys = Array.from(new Set([...weightMap.keys(), ...photoMap.keys()]))
          .sort((a, b) => (a < b ? 1 : -1));

        if (!weekKeys.length) {
          progressList.innerHTML = '<div class="page-subtitle">Пока нет данных по весу и замерам.</div>';
          return;
        }

        weekKeys.forEach((weekStart) => {
          const weight = weightMap.get(weekStart);
          const photos = photoMap.get(weekStart) || {};
          const card = document.createElement("div");
          card.className = "progress-week";
          card.innerHTML = `
            <div class="progress-week-meta">
              <span>${formatMonthRangeNumeric(weekStart)}</span>
              <span class="progress-week-weight">Вес: ${formatWeight(weight?.weightKg)} кг</span>
            </div>
            <div class="progress-photos">
              ${photos.frontUrl
                ? `<img class="progress-photo" src="${photos.frontUrl}" alt="Фото спереди">`
                : `<div class="progress-photo is-empty">Спереди</div>`}
              ${photos.sideUrl
                ? `<img class="progress-photo" src="${photos.sideUrl}" alt="Фото сбоку">`
                : `<div class="progress-photo is-empty">Сбоку</div>`}
              ${photos.backUrl
                ? `<img class="progress-photo" src="${photos.backUrl}" alt="Фото сзади">`
                : `<div class="progress-photo is-empty">Сзади</div>`}
            </div>
          `;
          progressList.appendChild(card);
        });
      };

      const loadProgress = async () => {
        if (!apiBase || !initData || !clientId) return;
        try {
          const [weightRes, photoRes] = await Promise.all([
            fetch(`${apiBase}/api/admin/clients/${clientId}/weight-history?initData=${encodeURIComponent(initData)}&months=12`),
            fetch(`${apiBase}/api/admin/clients/${clientId}/measurements?initData=${encodeURIComponent(initData)}&months=12`)
          ]);

          const weightJson = await weightRes.json().catch(() => ({}));
          const photoJson = await photoRes.json().catch(() => ({}));
          const weightLogs = Array.isArray(weightJson.logs) ? weightJson.logs : [];
          const photoItems = Array.isArray(photoJson.items) ? photoJson.items : [];
          renderProgress(weightLogs, photoItems);
          if (progressCard) progressCard.hidden = false;
        } catch (e) {
          console.error("Ошибка загрузки прогресса", e);
        }
      };

      const loadClient = async () => {

        if (!apiBase || !initData || !clientId) return;

        try {

          const url = `${apiBase}/api/admin/clients/${clientId}?initData=${encodeURIComponent(initData)}`;

          const res = await fetch(url);

          const json = await res.json().catch(() => ({}));

          if (!json?.ok) return;



          const client = json.client || {};

          const name = [client.first_name, client.last_name].filter(Boolean).join(" ") || "Без имени";



          clientTitle.textContent = name;

          clientSubtitle.textContent = client.username ? `@${client.username}` : "без username";

          infoName.textContent = name;

          const tariffName = (client.tariffName || "").trim();

          infoTariff.textContent = tariffName || "?";

          infoMode.textContent = formatMode(client.trainingMode);

          infoStats.textContent = `${client.heightCm ?? "?"} см / ${client.weightKg ?? "?"} кг`;




          const hasAllowedTariff = ["Оптимальный", "Максимум"].includes(tariffName);

          const isStaffTarget = (client.role && client.role !== "user") || Boolean(client.isCurator);

          const tariffActive = isTariffActive(client.tariffExpiresAt);
          const hasChatAccess = hasAllowedTariff && tariffActive && !isStaffTarget;

          hasNutritionDiary = hasAllowedTariff && !isStaffTarget;



          if (profileCard) profileCard.hidden = false;

          if (nutritionCard) nutritionCard.hidden = !hasNutritionDiary;

          if (staffCard) staffCard.hidden = !isSuperAdmin;


          const hasCurator = Boolean(client.trainer?.id);

          const isAssignedCurator = hasCurator && currentUserId && client.trainer?.id === currentUserId;

          const canChat = canCurate && isAssignedCurator && hasChatAccess;

          if (chatCard) {

            chatCard.hidden = !canChat;

          }

          if (chatStatus) {
            if (!hasCurator) {
              chatStatus.textContent = "\u041a\u0443\u0440\u0430\u0442\u043e\u0440 \u043d\u0435 \u043d\u0430\u0437\u043d\u0430\u0447\u0435\u043d";
            } else if (!hasChatAccess) {
              chatStatus.textContent = "\u0427\u0430\u0442 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u043d\u0430 \u0431\u0430\u0437\u043e\u0432\u043e\u043c \u0442\u0430\u0440\u0438\u0444\u0435";
            } else {
              chatStatus.textContent = "";
            }
          }

          const canViewAvailable = canCurate && (isAssignedCurator || isAdmin);

          if (availableCard) {

            availableCard.hidden = !canViewAvailable;

          }

          if (availableStatus) {

            const modeLabel = formatMode(client.trainingMode);
            const tariffLabel = tariffName || "\u2014";
            availableStatus.textContent = `\u0420\u0435\u0436\u0438\u043c: ${modeLabel}, \u0442\u0430\u0440\u0438\u0444: ${tariffLabel}.`;

          }

          stopChatPolling();

          if (chatCard && !chatCard.hidden) {
            if (openChatOnLoad) {
              openChatWindow();
            }
          }




          if (staffRole && staffScope) {
            const roleValue = (client.role === "admin" || client.role === "sadmin" || client.role === "curator")
              ? client.role
              : (client.isCurator ? "curator" : "user");
            staffRole.value = roleValue;
            staffScope.value = client.trainerScope || "both";
            syncStaffRoleOptions();
            applyStaffRoleState();
          }


          await loadCurators(client.trainer?.id || null);
          await loadProgress();

        } catch (e) {

          console.error("Ошибка загрузки клиента", e);

        }

      };



const loadCurators = async (currentCuratorId) => {

        if (!apiBase || !initData) return;

        try {

          const res = await fetch(`${apiBase}/api/admin/curators?initData=${encodeURIComponent(initData)}`);

          const json = await res.json().catch(() => ({}));

          const curators = Array.isArray(json.curators) ? json.curators : [];

          trainerSelect.innerHTML = "";



          const emptyOpt = document.createElement("option");

          emptyOpt.value = "";

          emptyOpt.textContent = "Не назначен";

          trainerSelect.appendChild(emptyOpt);



          curators.forEach((curator) => {

            const opt = document.createElement("option");

            const name = [curator.first_name, curator.last_name].filter(Boolean).join(" ") || curator.username;

            opt.value = curator.id;

            opt.textContent = name || `Куратор #${curator.id}`;

            trainerSelect.appendChild(opt);

          });



          trainerSelect.value = currentCuratorId ? String(currentCuratorId) : "";

          trainerSelect.disabled = !isAdmin;

        } catch (e) {

          console.error("Ошибка загрузки кураторов", e);

        }

      };



const assignCurator = async () => {

        if (!isAdmin) return;

        const value = trainerSelect.value || null;

        try {

          profileStatus.textContent = "Сохраняем...";

          const res = await fetch(`${apiBase}/api/admin/clients/${clientId}/trainer`, {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify({ initData, trainerId: value ? Number(value) : null })

          });

          const json = await res.json().catch(() => ({}));

          profileStatus.textContent = json?.ok ? "Куратор назначен" : "Ошибка назначения";

          setTimeout(() => { profileStatus.textContent = ""; }, 2000);

        } catch (e) {

          profileStatus.textContent = "Ошибка назначения";

        }

      };



      const syncStaffRoleOptions = () => {
        if (!staffRole) return;
        const restrict = !isSuperAdmin;
        Array.from(staffRole.options).forEach((opt) => {
          if (opt.value === "admin" || opt.value === "sadmin") {
            opt.disabled = restrict;
            opt.hidden = restrict;
          }
        });
        if (restrict && (staffRole.value === "admin" || staffRole.value === "sadmin")) {
          staffRole.value = "user";
        }
      };

      const applyStaffRoleState = () => {
            if (!staffRole || !staffScope) return;
            const baseRole = staffRole.value || "user";
            staffScope.disabled = baseRole !== "curator";
            };
            
            const saveStaffHandler = async () => {

        if (!isAdmin) return;
        const selectedRole = staffRole?.value || "user";
        if (!isSuperAdmin && !["user", "curator"].includes(selectedRole)) {
          staffStatus.textContent = "Недостаточно прав для выбора этой роли.";
          setTimeout(() => { staffStatus.textContent = ""; }, 2000);
          return;
        }
        try {

          staffStatus.textContent = "Сохраняем...";

          const payload = {

            initData,

            role: staffRole?.value || "user",

            trainerScope: staffScope?.value || "both"

          };

          const res = await fetch(`${apiBase}/api/admin/clients/${clientId}/staff`, {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify(payload)

          });

          const json = await res.json().catch(() => ({}));

          staffStatus.textContent = json?.ok ? "Роли сохранены" : "Ошибка сохранения";

          setTimeout(() => { staffStatus.textContent = ""; }, 2000);

        } catch (e) {

          staffStatus.textContent = "Ошибка сохранения";

        }

      };



const saveCommentHandler = async () => {

        const dateKey = toYMD(selectedDate);

        const text = commentText?.value || "";

        if (!text.trim()) {

          commentStatus.textContent = "Комментарий пустой";

          return;

        }

        try {

          commentStatus.textContent = "Сохраняем...";

          const res = await fetch(`${apiBase}/api/admin/clients/${clientId}/nutrition-comment`, {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify({ initData, date: dateKey, text })

          });

          const json = await res.json().catch(() => ({}));

          if (json?.ok) {

            monthComments[dateKey] = text;

            renderCalendar();

            commentStatus.textContent = "Комментарий сохранен";

          } else {

            commentStatus.textContent = "Ошибка сохранения";

          }

          setTimeout(() => { commentStatus.textContent = ""; }, 2000);

        } catch (e) {

          commentStatus.textContent = "Ошибка сохранения";

        }

      };





      const CHAT_STATUS_SINGLE_SVG = '<svg class="chat-tick" viewBox="0 0 16 12" aria-hidden="true" focusable="false"><path d="M1 6l4 4L15 1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      const CHAT_STATUS_DOUBLE_SVG = '<svg class="chat-tick" viewBox="0 0 22 12" aria-hidden="true" focusable="false"><path d="M1 6l4 4L15 1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 6l4 4L21 1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>';

      const formatChatTimestamp = (value) => {

        if (!value) return "";

        const date = new Date(value);

        if (Number.isNaN(date.getTime())) return "";

        const pad = (n) => String(n).padStart(2, "0");

        return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;

      };

      const ensureChatMeta = (bubble, message) => {

        let meta = bubble.querySelector(".chat-meta");

        if (!meta) {

          meta = document.createElement("div");

          meta.className = "chat-meta";

          bubble.appendChild(meta);

        }

        let timeEl = meta.querySelector(".chat-time");

        if (!timeEl) {

          timeEl = document.createElement("span");

          timeEl.className = "chat-time";

          meta.appendChild(timeEl);

        }

        if (!timeEl.textContent && message?.createdAt) {

          timeEl.textContent = formatChatTimestamp(message.createdAt);

        }

        return meta;

      };

      const updateChatStatus = (bubble, message) => {

        if (!bubble) return;

        const meta = ensureChatMeta(bubble, message);

        const shouldShow = Boolean(message?.isMine);

        let statusEl = meta.querySelector(".chat-status");

        if (!shouldShow) {

          if (statusEl) statusEl.remove();

          return;

        }

        if (!statusEl) {

          statusEl = document.createElement("span");

          statusEl.className = "chat-status";

          meta.appendChild(statusEl);

        }

        statusEl.innerHTML = message.readAt ? CHAT_STATUS_DOUBLE_SVG : CHAT_STATUS_SINGLE_SVG;

        statusEl.classList.toggle("is-read", Boolean(message.readAt));

      };

      const renderChatMessage = (message) => {

        if (!chatMessages || !message) return;

        const existing = message.id ? chatMessages.querySelector(`[data-id="${message.id}"]`) : null;

        if (existing) {

          updateChatStatus(existing, message);

          return;

        }

        const bubble = document.createElement("div");

        bubble.className = `chat-bubble${message.isMine ? " is-mine" : ""}`;

        if (message.id) bubble.dataset.id = String(message.id);

        if (message.media?.url) {

          const video = document.createElement("video");

          video.src = message.media.url;

          video.controls = true;

          video.playsInline = true;

          video.preload = "metadata";

          bubble.appendChild(video);

        }

        if (message.text) {

          const textEl = document.createElement("div");

          textEl.textContent = message.text;

          bubble.appendChild(textEl);

        }

        updateChatStatus(bubble, message);

        chatMessages.appendChild(bubble);

      };



      const scrollChatToBottom = () => {

        if (!chatMessages) return;

        chatMessages.scrollTop = chatMessages.scrollHeight;

      };



      const loadChatMessages = async (opts = {}) => {

        if (!apiBase || !initData || !chatMessages || !clientId) return;

        const params = new URLSearchParams();

        params.set("initData", initData);

        params.set("clientId", String(clientId));

        if (opts.afterId && Number.isFinite(opts.afterId)) {

          params.set("afterId", String(opts.afterId));

        }

        if (opts.markRead === false) params.set("markRead", "0");
        if (opts.includeLast) params.set("includeLast", "1");



        try {

          const res = await fetch(`${apiBase}/api/chat/messages?${params.toString()}`);

          const json = await res.json().catch(() => ({}));

          if (!json?.ok) return;

          const items = Array.isArray(json.messages) ? json.messages : [];

          items.forEach((msg) => {

            renderChatMessage(msg);

            if (msg.id && msg.id > chatLastId) chatLastId = msg.id;

          });

          if (items.length) scrollChatToBottom();

        } catch (e) {

          console.warn("Ошибка загрузки чата", e);

        }

      };



      const startChatPolling = () => {

        if (chatPollTimer) return;

        chatPollTimer = setInterval(() => {

          loadChatMessages({ afterId: chatLastId, includeLast: true });

        }, 3000);

      };



      const stopChatPolling = () => {

        if (chatPollTimer) {

          clearInterval(chatPollTimer);

          chatPollTimer = null;

        }

      };



      const initChat = async () => {

        if (!chatCard || chatCard.hidden) return;

        if (!chatMessages || !chatInput) return;

        if (chatMessages) chatMessages.innerHTML = "";

        chatLastId = 0;

        await loadChatMessages({ markRead: true });

        startChatPolling();

      };



      const sendChatPayload = async ({ text, media } = {}) => {

        if (!apiBase || !initData || !clientId) return;

        if (!text && !media) return;

        if (chatSend) chatSend.disabled = true;

        if (chatAttach) chatAttach.disabled = true;

        try {

          const payload = { initData, clientId };

          if (text) payload.text = text;

          if (media) {

            payload.mediaKey = media.key;

            payload.mediaType = media.type;

            payload.mediaName = media.name;

            payload.mediaSize = media.size;

          }

          const res = await fetch(`${apiBase}/api/chat/messages`, {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify(payload)

          });

          const json = await res.json().catch(() => ({}));

          if (json?.ok && json.message) {
            renderChatMessage(json.message);
            if (json.message.id && json.message.id > chatLastId) chatLastId = json.message.id;
            scrollChatToBottom();
          } else if (chatStatus) {
            if (json?.error === "chat_not_allowed") {
              chatStatus.textContent = "\u0427\u0430\u0442 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u043d\u0430 \u0431\u0430\u0437\u043e\u0432\u043e\u043c \u0442\u0430\u0440\u0438\u0444\u0435";
              if (chatInput) chatInput.disabled = true;
              if (chatSend) chatSend.disabled = true;
              if (chatAttach) chatAttach.disabled = true;
            } else {
              chatStatus.textContent = "\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438";
            }
            setTimeout(() => { chatStatus.textContent = ""; }, 2000);
          }

        } catch (e) {

          if (chatStatus) {

            chatStatus.textContent = "\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438";

            setTimeout(() => { chatStatus.textContent = ""; }, 2000);

          }

        } finally {

          if (chatSend) chatSend.disabled = false;

          if (chatAttach) chatAttach.disabled = false;

        }

      };



      const uploadChatMedia = async (file) => {

        if (!apiBase || !initData || !clientId || !file) return null;

        const size = file.size || 0;

        if (size <= 0) return null;

        if (size > 50 * 1024 * 1024) {
          if (chatStatus) {
            chatStatus.textContent = "\u0424\u0430\u0439\u043b \u0431\u043e\u043b\u044c\u0448\u0435 50 \u041c\u0411.";
            setTimeout(() => { chatStatus.textContent = ""; }, 2000);
          }
          return null;

        }

        const res = await fetch(`${apiBase}/api/chat/upload-url`, {

          method: "POST",

          headers: { "Content-Type": "application/json" },

          body: JSON.stringify({

            initData,

            clientId,

            fileName: file.name || "video.mp4",

            contentType: file.type || "video/mp4",

            size

          })

        });

        const json = await res.json().catch(() => ({}));

        if (!json?.ok || !json.uploadUrl || !json.objectKey) {

          if (chatStatus) {

            chatStatus.textContent = "\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438";

            setTimeout(() => { chatStatus.textContent = ""; }, 2000);

          }

          return null;

        }

        const uploadRes = await fetch(json.uploadUrl, {

          method: "PUT",

          headers: { "Content-Type": file.type || "video/mp4" },

          body: file

        });

        if (!uploadRes.ok) {

          if (chatStatus) {

            chatStatus.textContent = "\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438";

            setTimeout(() => { chatStatus.textContent = ""; }, 2000);

          }

          return null;

        }

        return {

          key: json.objectKey,

          type: file.type || "video/mp4",

          name: file.name || "video.mp4",

          size

        };

      };



      const sendChatMessage = async () => {

        if (!chatInput) return;

        const text = chatInput.value.trim();

        if (!text) return;

        chatInput.value = "";

        await sendChatPayload({ text });

      };



            const checkAccess = async () => {

        if (!apiBase) {

          accessMessage.textContent = "Нет API_BASE. Проверь env.js и конфиг.";

          return;

        }

        initData = tg?.initData || params.get("initData") || buildInitData() || "";

        if (!initData) {

          accessMessage.textContent = "Открой админку через Telegram, чтобы получить initData.";

          return;

        }

        if (!clientId) {

          accessMessage.textContent = "Не указан клиент.";

          return;

        }

        try {

          const res = await fetch(`${apiBase}/api/user?initData=${encodeURIComponent(initData)}`);

          const json = await res.json().catch(() => ({}));

          role = json?.profile?.role || "user";

          isSuperAdmin = role === "sadmin";
          isAdmin = role === "admin" || isSuperAdmin;
          syncStaffRoleOptions();
          canCurate = Boolean(json?.profile?.canCurate);

          currentUserId = json?.profile?.id ?? null;

          if (!canCurate) {

            accessMessage.textContent = "Доступ закрыт. Нужна роль admin или куратор.";

            return;

          }

          accessMessage.textContent = "Доступ подтвержден.";

          await loadClient();

          if (hasNutritionDiary) {

            await loadMonth();

          }

        } catch (e) {

          accessMessage.textContent = "Ошибка проверки доступа.";

        }

      };



prevMonth?.addEventListener("click", () => {

        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);

        selectedDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);

        loadMonth();

      });

      nextMonth?.addEventListener("click", () => {

        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);

        selectedDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);

        loadMonth();

      });

      staffRole?.addEventListener("change", applyStaffRoleState);

      saveStaff?.addEventListener("click", saveStaffHandler);

      saveComment?.addEventListener("click", saveCommentHandler);

      refreshProgress?.addEventListener("click", loadProgress);

      chatSend?.addEventListener("click", sendChatMessage);

      chatInput?.addEventListener("keydown", (e) => {

        if (e.key === "Enter") {

          e.preventDefault();

          sendChatMessage();

        }

      });

      chatAttach?.addEventListener("click", () => chatFile?.click());

      chatFile?.addEventListener("change", async () => {
        const file = chatFile.files?.[0];
        chatFile.value = "";
        if (!file) return;
        const media = await uploadChatMedia(file);
        if (media) {
          await sendChatPayload({ media });
        }
      });
      openChatPage?.addEventListener("click", openChatWindow);


      trainerSelect?.addEventListener("change", assignCurator);
      goBack?.addEventListener("click", () => {

        const backUrl = initData ? `admin_clients.html?initData=${encodeURIComponent(initData)}` : "admin_clients.html";

        window.location.href = backUrl;

      });

      openAvailable?.addEventListener("click", openAvailablePage);



      checkAccess();

    })();

  </script>

</body>

</html>















