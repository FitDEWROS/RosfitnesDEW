name: Shorebird Release Android

on:
  push:
    branches:
      - main
      - master
    paths:
      - "app_android/**"
      - ".github/workflows/shorebird_release.yml"
  workflow_dispatch:
    inputs:
      artifact:
        description: "Artifact type (aab or apk)"
        required: false
        default: "apk"

jobs:
  release:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: app_android
    env:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
      ARTIFACT: ${{ github.event.inputs.artifact || 'apk' }}
    steps:
      - name: ðŸ“š Checkout
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: ðŸ” Prepare Android signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "Missing ANDROID_KEYSTORE_BASE64 secret"
            exit 1
          fi
          if [ -z "${ANDROID_KEYSTORE_PASSWORD:-}" ]; then
            echo "Missing ANDROID_KEYSTORE_PASSWORD secret"
            exit 1
          fi
          if [ -z "${ANDROID_KEY_ALIAS:-}" ]; then
            echo "Missing ANDROID_KEY_ALIAS secret"
            exit 1
          fi
          KEY_PASSWORD="${ANDROID_KEY_PASSWORD:-$ANDROID_KEYSTORE_PASSWORD}"
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/fitdew-release.jks
          cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=app/fitdew-release.jks
          EOF

      - name: Bump build number for release
        run: |
          python - <<'PY'
          import os, re, pathlib
          path = pathlib.Path("pubspec.yaml")
          text = path.read_text()
          m = re.search(r'^version:\s*([0-9]+\.[0-9]+\.[0-9]+)(?:\+(\d+))?$', text, re.M)
          if not m:
              raise SystemExit("version not found in pubspec.yaml")
          name = m.group(1)
          build = os.environ.get("GITHUB_RUN_NUMBER", "1")
          new_line = f"version: {name}+{build}"
          text = re.sub(r'^version:.*$', new_line, text, flags=re.M)
          path.write_text(text)
          print(new_line)
          PY

      - name: ðŸš€ Shorebird Release (Android)
        uses: shorebirdtech/shorebird-release@v1
        with:
          platform: android
          working-directory: app_android
          flutter-version: '3.38.9'
          args: --artifact ${{ env.ARTIFACT }} --verbose

      - name: Collect build logs
        if: ${{ always() }}
        run: |
          mkdir -p artifacts
          if [ -f output.log ]; then cp output.log artifacts/; fi
          cp /home/runner/.config/shorebird/logs/*_shorebird.log artifacts/ || true

      - name: Upload build logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: shorebird-build-logs
          path: artifacts/**
          if-no-files-found: warn

      - name: Dump Shorebird logs on failure
        if: ${{ failure() }}
        run: |
          if [ -f output.log ]; then
            echo "::group::shorebird output.log (tail)"
            tail -n 200 output.log || true
            echo "::endgroup::"
          fi
          echo "::group::shorebird logs"
          ls -la /home/runner/.config/shorebird/logs || true
          tail -n 400 /home/runner/.config/shorebird/logs/*_shorebird.log || true
          echo "::endgroup::"

      - name: Upload APK to S3
        if: ${{ env.ARTIFACT == 'apk' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.S3_REGION }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_KEY: ${{ secrets.S3_APK_KEY || 'updates/app-release.apk' }}
        run: |
          set -euo pipefail
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "APK not found at $APK_PATH"
            exit 1
          fi
          aws s3 cp "$APK_PATH" "s3://$S3_BUCKET/$S3_KEY" \
            --endpoint-url "$S3_ENDPOINT" \
            --acl public-read

      - name: Upload latest.json
        if: ${{ env.ARTIFACT == 'apk' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.S3_REGION }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_KEY: ${{ secrets.S3_APK_KEY || 'updates/app-release.apk' }}
          PUBLIC_BASE_URL: ${{ secrets.APP_UPDATE_PUBLIC_URL }}
        run: |
          set -euo pipefail
          VERSION_LINE=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          VERSION_NAME="${VERSION_LINE%%+*}"
          VERSION_CODE="${VERSION_LINE##*+}"
          if [ "$VERSION_CODE" = "$VERSION_LINE" ]; then VERSION_CODE=1; fi
          if [ -n "${PUBLIC_BASE_URL:-}" ]; then
            APK_URL="${PUBLIC_BASE_URL%/}/$S3_KEY"
          else
            APK_URL="${S3_ENDPOINT%/}/$S3_BUCKET/$S3_KEY"
          fi
          cat > /tmp/latest.json <<EOF
          {"versionCode":$VERSION_CODE,"versionName":"$VERSION_NAME","minVersionCode":0,"url":"$APK_URL"}
          EOF
          aws s3 cp /tmp/latest.json "s3://$S3_BUCKET/updates/latest.json" \
            --endpoint-url "$S3_ENDPOINT" \
            --acl public-read \
            --content-type application/json
